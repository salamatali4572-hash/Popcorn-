<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Popcorn - Complete Social Media Platform with EMS</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        :root {
            --primary: linear-gradient(135deg, #5e35b1, #7c4dff);
            --primary-dark: #4527a0;
            --secondary: #00bcd4;
            --success: #66bb6a;
            --danger: #ef5350;
            --warning: #ffb300;
            --background: #0a0a0a;
            --surface: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --border: #2a2a2a;
            --sidebar-width: 280px;
            --header-height: 70px;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
            --shadow-hover: 0 12px 40px rgba(0, 0, 0, 0.7);
            --radius: 12px;
            --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            background: linear-gradient(to bottom, var(--background), #1a1a1e);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .shadow-md {
            box-shadow: var(--shadow);
        }

        .shadow-hover {
            transition: var(--transition);
        }

        .shadow-hover:hover {
            box-shadow: var(--shadow-hover);
        }

        /* Auth Section - Enhanced with better gradient and glow */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-dark) 0%, #16213e 50%, #0f0f23 100%);
            padding: 20px;
            position: relative;
        }

        .auth-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .auth-form {
            background: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(20px);
            padding: 50px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 450px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            z-index: 1;
            border-top: 5px solid transparent;
            background-clip: padding-box;
        }

        .auth-form::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: var(--primary);
            border-radius: var(--radius) var(--radius) 0 0;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 35px;
            animation: fadeInUp 0.6s ease;
        }

        .auth-header h1 {
            background: var(--primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 36px;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .auth-header p {
            color: var(--text-secondary);
            font-size: 16px;
            opacity: 0.8;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 30px;
            border-radius: var(--radius);
            overflow: hidden;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 16px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            color: var(--text-secondary);
            position: relative;
        }

        .auth-tab::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--secondary);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .auth-tab.active {
            background: rgba(94, 53, 177, 0.2);
            color: var(--text-primary);
        }

        .auth-tab.active::after {
            transform: scaleX(1);
        }

        .form-group {
            margin-bottom: 25px;
            position: relative;
            animation: fadeInUp 0.6s ease 0.2s both;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 14px;
            opacity: 0.9;
        }

        .form-control {
            width: 100%;
            padding: 16px 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius);
            font-size: 16px;
            transition: var(--transition);
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            color: var(--text-primary);
            position: relative;
        }

        .form-control::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(0, 188, 212, 0.1);
            background: rgba(255, 255, 255, 0.08);
        }

        .btn {
            display: inline-block;
            background: var(--primary);
            color: white;
            border: none;
            padding: 16px 28px;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: var(--transition);
            text-align: center;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            position: relative;
            overflow: hidden;
            animation: fadeInUp 0.6s ease 0.4s both;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #81c784);
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #5cb860, var(--success));
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #e57373);
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #e53935, var(--danger));
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #ffd54f);
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #fbc02d, var(--warning));
        }

        .btn-whatsapp {
            background: linear-gradient(135deg, #25D366, #20ba5a);
        }

        .btn-whatsapp:hover {
            background: linear-gradient(135deg, #128C7E, #25D366);
        }

        /* Main App - Enhanced sidebar and content */
        #appSection {
            display: none;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
            position: relative;
            background: var(--background);
        }

        /* Sidebar - Glassmorphism effect */
        .sidebar {
            width: var(--sidebar-width);
            background: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(20px);
            color: var(--text-primary);
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            transition: var(--transition);
            z-index: 1000;
            box-shadow: var(--shadow);
            transform: translateX(-100%);
            overflow-y: auto;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sidebar.open {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--secondary);
            position: sticky;
            top: 0;
            background: inherit;
            backdrop-filter: blur(10px);
        }
        
        .logo-title {
            display: flex;
            align-items: center;
        }

        .logo-title i {
            background: var(--primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-right: 12px;
        }

        .sidebar-header h2 {
            font-size: 22px;
            margin-left: 10px;
            font-weight: 600;
            background: var(--secondary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .sidebar-close-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: var(--transition);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .sidebar-close-btn:hover {
            background: var(--danger);
            color: white;
            transform: rotate(90deg);
        }

        .sidebar-menu {
            list-style: none;
            padding: 20px 0;
        }

        .sidebar-menu li {
            padding: 16px 30px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            font-weight: 500;
            color: var(--text-secondary);
            position: relative;
            overflow: hidden;
        }

        .sidebar-menu li::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--secondary);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .sidebar-menu li i {
            margin-right: 15px;
            font-size: 18px;
            width: 24px;
            text-align: center;
            transition: var(--transition);
        }

        .sidebar-menu li:hover {
            background: rgba(94, 53, 177, 0.1);
            color: var(--text-primary);
            padding-left: 35px;
        }

        .sidebar-menu li:hover::before {
            transform: scaleY(1);
        }

        .sidebar-menu li:hover i {
            transform: scale(1.1);
        }

        .sidebar-menu li.active {
            background: rgba(94, 53, 177, 0.2);
            color: var(--text-primary);
            border-left: 4px solid var(--secondary);
        }

        .sidebar-menu li.active::before {
            transform: scaleY(1);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 30px;
            margin-left: 0;
            transition: var(--transition);
            animation: fadeIn 0.6s ease;
        }
        
        .sidebar-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 999;
            transition: var(--transition);
        }
        
        .sidebar-backdrop.open {
            display: block;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 35px;
            padding: 20px 30px;
            background: rgba(26, 26, 26, 0.8);
            backdrop-filter: blur(20px);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            position: sticky; 
            top: 0;
            z-index: 900;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .header-left-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .menu-toggle {
            font-size: 20px;
            cursor: pointer;
            background: var(--primary);
            color: var(--text-primary);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .menu-toggle:hover {
            background: var(--primary-dark);
            transform: rotate(90deg);
        }
        
        #pageTitle {
            font-size: 18px;
            background: var(--secondary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 600;
            margin: 0;
            flex-grow: 1;
            text-align: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--secondary), #26c6da);
            color: var(--surface);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .user-avatar:hover {
            transform: scale(1.1);
        }
        
        .user-info div:last-child {
            color: var(--text-secondary);
            display: flex;
            flex-direction: column; 
            gap: 5px;
        }
        
        /* Logout button specific styling on small screens */
        @media (max-width: 991px) {
            .user-info div:last-child > div {
                display: none;
            }
            #logoutBtn {
                margin: 0;
                padding: 5px 10px;
            }
            .user-info div:last-child {
                display: flex;
                flex-direction: column;
                justify-content: center;
            }
        }
        
        /* Content Sections - Enhanced animations */
        .content-section {
            display: none;
            animation: fadeInUp 0.6s ease;
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            margin-bottom: 30px;
            position: relative;
        }

        .section-header::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 0;
            width: 50px;
            height: 3px;
            background: var(--primary);
            border-radius: 2px;
        }

        .section-header h2 {
            font-size: 28px;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-weight: 700;
        }

        .section-header p {
            color: var(--text-secondary);
            font-size: 15px;
            opacity: 0.8;
        }

        /* Cards - Enhanced with gradient borders */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 35px;
        }

        .card {
            background: rgba(26, 26, 26, 0.8);
            backdrop-filter: blur(20px);
            border-radius: var(--radius);
            padding: 30px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary);
        }

        .card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: var(--shadow-hover);
        }

        .card-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(94, 53, 177, 0.2);
            backdrop-filter: blur(10px);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 20px;
            transition: var(--transition);
        }

        .card:hover .card-icon {
            background: rgba(94, 53, 177, 0.4);
            transform: rotate(360deg);
        }

        .card h3 {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
        }

        .card-value {
            font-size: 32px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 8px;
            background: var(--secondary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .card-desc {
            font-size: 14px;
            color: var(--text-secondary);
            opacity: 0.8;
        }

        /* Forms - Enhanced inputs */
        .form-container {
            background: rgba(26, 26, 26, 0.8);
            backdrop-filter: blur(20px);
            padding: 30px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 35px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .form-container h3 {
             color: var(--secondary);
             margin-bottom: 25px;
             border-bottom: 1px solid rgba(255, 255, 255, 0.1);
             padding-bottom: 15px;
             font-weight: 600;
             position: relative;
        }

        .form-container h3::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 40px;
            height: 2px;
            background: var(--secondary);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        /* Tables - Enhanced with better hover and stripes */
        .table-container {
            background: rgba(26, 26, 26, 0.8);
            backdrop-filter: blur(20px);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 35px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }
        
        .table-container h3 {
             padding: 20px 25px;
             color: var(--text-primary);
             font-weight: 600;
             background: rgba(42, 42, 42, 0.8);
             border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: rgba(42, 42, 42, 0.8);
            padding: 16px 25px;
            text-align: left;
            font-weight: 600;
            color: var(--secondary);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-transform: uppercase;
            font-size: 13px;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 15px 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            font-size: 15px;
            transition: var(--transition);
        }

        tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.02);
        }

        tr:hover {
            background: rgba(94, 53, 177, 0.1);
            transform: scale(1.01);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .btn-sm {
            padding: 10px 15px;
            font-size: 13px;
            border-radius: 6px;
            text-transform: none;
            transition: var(--transition);
        }

        .btn-sm:hover {
            transform: translateY(-1px);
        }

        /* Messaging System Styles - Enhanced bubbles */
        .messaging-container {
            display: flex;
            height: calc(100vh - 150px);
            background: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .contacts-list {
            width: 320px;
            background: rgba(42, 42, 42, 0.8);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            overflow-y: auto;
            padding: 0;
        }

        .contact-item {
            padding: 20px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
        }

        .contact-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--primary);
            transform: scaleY(0);
            transition: var(--transition);
        }

        .contact-item:hover::before,
        .contact-item.active::before {
            transform: scaleY(1);
        }

        .contact-item:hover,
        .contact-item.active {
            background: rgba(94, 53, 177, 0.2);
            color: var(--text-primary);
        }

        .contact-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--secondary), #26c6da);
            color: var(--surface);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            box-shadow: var(--shadow);
        }

        .contact-info {
            flex: 1;
        }

        .contact-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .contact-last-msg {
            font-size: 13px;
            color: var(--text-secondary);
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            max-width: 200px;
        }

        .chat-window {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .chat-header {
            padding: 20px 25px;
            background: rgba(42, 42, 42, 0.8);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .chat-header .contact-avatar {
            margin: 0;
        }

        .chat-header-info h4 {
            font-size: 18px;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .chat-header-info p {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 25px;
            background: var(--surface);
            scroll-behavior: smooth;
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-end;
            gap: 12px;
            max-width: 75%;
            position: relative;
            animation: messageSlideIn 0.3s ease;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.sent {
            margin-left: auto;
            flex-direction: row-reverse;
        }

        .message-bubble {
            padding: 14px 18px;
            border-radius: var(--radius);
            max-width: 100%;
            word-wrap: break-word;
            position: relative;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            transition: var(--transition);
        }

        .message-bubble:hover {
            transform: scale(1.02);
        }

        .message.sent .message-bubble {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--text-primary);
            border-bottom-right-radius: 6px;
        }

        .message.received .message-bubble {
            background: linear-gradient(135deg, var(--secondary), #26c6da);
            color: var(--surface);
            border-bottom-left-radius: 6px;
        }

        .message-time {
            font-size: 11px;
            color: var(--text-secondary);
            margin-left: 8px;
            opacity: 0.7;
        }

        .chat-input-container {
            padding: 20px 25px;
            background: rgba(42, 42, 42, 0.8);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 12px;
            align-items: center;
            position: sticky;
            bottom: 0;
            z-index: 1;
        }

        .chat-input {
            flex: 1;
            padding: 14px 18px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            color: var(--text-primary);
            font-size: 15px;
            transition: var(--transition);
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(94, 53, 177, 0.1);
        }

        .send-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .send-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
        }

        .send-btn:disabled {
            background: rgba(255, 255, 255, 0.1);
            cursor: not-allowed;
            transform: none;
        }

        .no-chat-selected {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-style: italic;
            text-align: center;
            padding: 40px;
        }

        .no-contacts {
            text-align: center;
            padding: 50px 20px;
            color: var(--text-secondary);
        }

        .loading {
            text-align: center;
            padding: 30px;
            color: var(--text-secondary);
            font-style: italic;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--secondary);
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Modal - Enhanced with scale and blur */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(15px);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            animation: modalOverlay 0.4s ease;
        }

        @keyframes modalOverlay {
            from { background: transparent; }
            to { background: rgba(0, 0, 0, 0.85); }
        }

        .modal-content {
            background: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(20px);
            padding: 35px;
            border-radius: var(--radius);
            width: 450px;
            max-width: 90%;
            box-shadow: var(--shadow-hover);
            animation: modalContent 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transform: scale(0.9);
            transition: var(--transition);
        }

        @keyframes modalContent {
            from { opacity: 0; transform: scale(0.9) translateY(-20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .modal-content.show {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header h3 {
            color: var(--secondary);
            font-size: 24px;
            font-weight: 600;
        }

        .close-modal {
            font-size: 28px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: var(--transition);
            padding: 5px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-modal:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--danger);
        }

        /* Status Indicators - Enhanced badges */
        .status-badge {
            display: inline-block;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .status-present {
            background: linear-gradient(135deg, rgba(102, 187, 106, 0.2), rgba(102, 187, 106, 0.1));
            color: var(--success);
            border: 1px solid rgba(102, 187, 106, 0.3);
        }

        .status-absent {
            background: linear-gradient(135deg, rgba(239, 83, 80, 0.2), rgba(239, 83, 80, 0.1));
            color: var(--danger);
            border: 1px solid rgba(239, 83, 80, 0.3);
        }

        .status-pending {
            background: linear-gradient(135deg, rgba(255, 179, 0, 0.2), rgba(255, 179, 0, 0.1));
            color: var(--warning);
            border: 1px solid rgba(255, 179, 0, 0.3);
        }

        /* Fee Status - Similar enhancements */
        .fee-status {
            display: inline-block;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .fee-paid {
            background: linear-gradient(135deg, rgba(102, 187, 106, 0.2), rgba(102, 187, 106, 0.1));
            color: var(--success);
            border: 1px solid rgba(102, 187, 106, 0.3);
        }
        
        .fee-partial {
            background: linear-gradient(135deg, rgba(255, 179, 0, 0.2), rgba(255, 179, 0, 0.1));
            color: var(--warning);
            border: 1px solid rgba(255, 179, 0, 0.3);
        }
        
        .fee-pending {
            background: linear-gradient(135deg, rgba(239, 83, 80, 0.2), rgba(239, 83, 80, 0.1));
            color: var(--danger);
            border: 1px solid rgba(239, 83, 80, 0.3);
        }
        
        /* Currency Styling */
        .currency {
            font-weight: 800;
            color: var(--success);
            text-shadow: 0 0 10px rgba(102, 187, 106, 0.5);
        }

        .currency::before {
            content: "PKR ";
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        /* WhatsApp Notification - Enhanced */
        .whatsapp-notification {
            background: linear-gradient(135deg, #25D366, #20ba5a);
            color: white;
            padding: 12px 18px;
            border-radius: var(--radius);
            margin-top: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }
        
        .whatsapp-notification:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }
        
        /* Disclaimer Styling - Better warning box */
        .disclaimer-box {
            margin-top: 35px;
            padding: 20px;
            border: 1px solid rgba(255, 179, 0, 0.3);
            border-radius: var(--radius);
            background: linear-gradient(135deg, rgba(255, 179, 0, 0.05), rgba(255, 179, 0, 0.02));
            color: var(--warning);
            font-size: 14px;
            box-shadow: 0 4px 20px rgba(255, 179, 0, 0.1);
        }
        
        .disclaimer-box p {
            margin-bottom: 8px;
            opacity: 0.9;
        }
        
        .disclaimer-box strong {
            color: var(--primary);
            background: var(--primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Animations - Enhanced */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes modalFade {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        /* NEW SOCIAL MEDIA STYLES - Enhanced profile and posts */
        
        /* Profile Section */
        .profile-container {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .profile-header {
            background: rgba(26, 26, 26, 0.8);
            backdrop-filter: blur(20px);
            border-radius: var(--radius);
            padding: 30px;
            box-shadow: var(--shadow);
            display: flex;
            gap: 25px;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .profile-avatar {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--secondary), #26c6da);
            color: var(--surface);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 56px;
            border: 6px solid var(--primary);
            box-shadow: var(--shadow-hover);
            transition: var(--transition);
        }
        
        .profile-avatar:hover {
            transform: scale(1.05);
        }
        
        .profile-info {
            flex: 1;
        }
        
        .profile-name {
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 8px;
            background: var(--primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .profile-bio {
            color: var(--text-secondary);
            margin-bottom: 20px;
            font-size: 16px;
            line-height: 1.6;
            opacity: 0.9;
        }
        
        .profile-stats {
            display: flex;
            gap: 25px;
        }
        
        .profile-stat {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius);
            transition: var(--transition);
        }
        
        .profile-stat:hover {
            background: rgba(94, 53, 177, 0.1);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 800;
            color: var(--text-primary);
        }
        
        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .profile-actions {
            display: flex;
            gap: 15px;
        }
        
        /* Posts Section - Enhanced cards */
        .posts-container {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .post-card {
            background: rgba(40, 44, 52, 0.8);
            backdrop-filter: blur(20px);
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(59, 64, 72, 0.5);
            transition: var(--transition);
            overflow: hidden;
        }
        
        .post-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary);
        }
        
        .post-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-hover);
        }
        
        .post-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            position: relative;
        }
        
        .post-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--secondary), #26c6da);
            color: var(--surface);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            box-shadow: var(--shadow);
        }
        
        .post-user-info {
            flex: 1;
        }
        
        .post-username {
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--text-primary);
        }
        
        .post-time {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .post-content {
            margin-bottom: 20px;
            background: rgba(31, 35, 42, 0.8);
            padding: 20px;
            border-radius: var(--radius);
            font-size: 16px;
            line-height: 1.6;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: var(--transition);
        }
        
        .post-content:hover {
            background: rgba(31, 35, 42, 0.9);
        }
        
        .post-actions {
            display: flex;
            gap: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            padding-top: 20px;
        }
        
        .post-action {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: var(--transition);
            padding: 8px 12px;
            border-radius: 20px;
        }
        
        .post-action:hover {
            color: var(--primary);
            background: rgba(94, 53, 177, 0.1);
            transform: translateY(-1px);
        }
        
        .post-action.active {
            color: var(--primary);
            background: rgba(94, 53, 177, 0.2);
        }

        /* Comments Section - Enhanced */
        .comments-section {
            margin-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            padding-top: 20px;
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .comment-input-container {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .comment-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            color: var(--text-primary);
            font-size: 15px;
            transition: var(--transition);
        }

        .comment-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(94, 53, 177, 0.1);
        }

        .add-comment-btn {
            padding: 12px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: var(--transition);
        }

        .add-comment-btn:hover {
            transform: translateY(-1px);
        }

        .comment-item {
            background: rgba(31, 35, 42, 0.8);
            padding: 15px;
            border-radius: var(--radius);
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: var(--transition);
        }

        .comment-item:hover {
            background: rgba(31, 35, 42, 0.9);
        }

        .comment-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .comment-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--secondary), #26c6da);
            color: var(--surface);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
        }

        .comment-author {
            font-weight: 700;
            font-size: 15px;
            color: var(--text-primary);
        }

        .comment-time {
            font-size: 12px;
            color: var(--text-secondary);
            margin-left: auto;
        }

        .comment-content {
            font-size: 15px;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .comment-actions {
            display: flex;
            gap: 15px;
            font-size: 13px;
        }

        .comment-action {
            cursor: pointer;
            color: var(--text-secondary);
            transition: var(--transition);
            padding: 5px 8px;
            border-radius: 15px;
        }

        .comment-action:hover {
            color: var(--primary);
            background: rgba(94, 53, 177, 0.1);
        }

        .replies-container {
            margin-left: 45px;
            margin-top: 15px;
            padding-left: 15px;
            border-left: 2px solid rgba(255, 255, 255, 0.1);
        }

        .reply-input-container {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .reply-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            background: rgba(42, 42, 42, 0.8);
            color: var(--text-primary);
            font-size: 13px;
        }

        .reply-btn {
            padding: 8px 12px;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: var(--transition);
        }

        .reply-btn:hover {
            background: #26c6da;
        }

        .reply-item {
            background: rgba(42, 42, 42, 0.8);
            padding: 10px 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 14px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Share Menu - Enhanced dropdown */
        .share-menu {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--radius);
            box-shadow: var(--shadow-hover);
            z-index: 3000;
            display: none;
            min-width: 220px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: modalContent 0.3s ease;
        }

        .share-menu ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .share-menu li {
            padding: 18px 25px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }

        .share-menu li:hover {
            background: rgba(94, 53, 177, 0.2);
            color: var(--text-primary);
            padding-left: 35px;
        }

        .share-menu li:last-child {
            border-bottom: none;
        }

        /* Stories Section - Enhanced carousel */
        .stories-container {
            display: flex;
            gap: 18px;
            overflow-x: auto;
            padding: 15px 0;
            margin-bottom: 25px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .stories-container::-webkit-scrollbar {
            display: none;
        }
        
        .story-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: var(--transition);
            min-width: 80px;
        }
        
        .story-item:hover {
            transform: scale(1.05);
        }
        
        .story-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--secondary), #26c6da);
            color: var(--surface);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 24px;
            border: 4px solid var(--primary);
            margin-bottom: 8px;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }
        
        .story-username {
            font-size: 13px;
            color: var(--text-secondary);
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            text-align: center;
        }
        
        .story-add {
            border: 3px dashed rgba(255, 255, 255, 0.3);
            background: transparent;
            color: var(--text-secondary);
            font-size: 28px;
        }
        
        .story-add:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .story-card {
            background: rgba(40, 44, 52, 0.8);
            backdrop-filter: blur(20px);
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(59, 64, 72, 0.5);
            margin-bottom: 25px;
        }

        .story-content {
            background: rgba(31, 35, 42, 0.8);
            padding: 20px;
            border-radius: var(--radius);
            font-size: 16px;
            line-height: 1.6;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        /* Friends Section */
        .friends-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 25px;
        }
        
        .friend-card {
            background: rgba(26, 26, 26, 0.8);
            backdrop-filter: blur(20px);
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
            text-align: center;
            transition: var(--transition);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .friend-card:hover {
            transform: translateY(-5px);
        }
        
        .friend-avatar {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--secondary), #26c6da);
            color: var(--surface);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 28px;
            margin: 0 auto 20px;
            box-shadow: var(--shadow);
        }
        
        .friend-name {
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-primary);
        }
        
        .friend-username {
            color: var(--text-secondary);
            font-size: 15px;
            margin-bottom: 20px;
            opacity: 0.8;
        }
        
        .friend-actions {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        /* Notifications - Enhanced list */
        .notifications-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .notification-item {
            background: rgba(26, 26, 26, 0.8);
            backdrop-filter: blur(20px);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: var(--transition);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .notification-item:hover {
            transform: translateX(5px);
        }
        
        .notification-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--secondary), #26c6da);
            color: var(--surface);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
        }
        
        .notification-content {
            flex: 1;
        }
        
        .notification-text {
            margin-bottom: 6px;
            font-weight: 500;
        }
        
        .notification-time {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .notification-actions {
            display: flex;
            gap: 8px;
        }
        
        /* Search Bar - Enhanced */
        .search-container {
            margin-bottom: 25px;
        }
        
        .search-bar {
            display: flex;
            gap: 12px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: var(--radius);
            padding: 5px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .search-input {
            flex: 1;
            padding: 14px 18px;
            border: none;
            border-radius: calc(var(--radius) - 5px);
            background: transparent;
            color: var(--text-primary);
            font-size: 16px;
        }
        
        .search-input:focus {
            outline: none;
            box-shadow: none;
        }
        
        /* Online Status - Pulsing dot */
        .online-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--success);
            position: absolute;
            bottom: 0;
            right: 0;
            border: 3px solid var(--surface);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(102, 187, 106, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(102, 187, 106, 0); }
            100% { box-shadow: 0 0 0 0 rgba(102, 187, 106, 0); }
        }
        
        .avatar-container {
            position: relative;
            display: inline-block;
        }

        /* Branding Section Styles - Enhanced preview */
        .branding-container {
            max-width: 700px;
            margin: 0 auto;
        }

        .branding-preview {
            background: linear-gradient(135deg, rgba(245, 247, 250, 0.1), rgba(195, 207, 226, 0.05));
            backdrop-filter: blur(10px);
            border-radius: var(--radius);
            padding: 25px;
            margin-bottom: 35px;
            box-shadow: var(--shadow);
            border-left: 5px solid var(--secondary);
            font-family: 'Courier New', monospace;
            white-space: pre-line;
            color: var(--text-primary);
            font-size: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .branding-preview::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--secondary);
        }

        .branding-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        @media (max-width: 768px) {
            .branding-form-row {
                grid-template-columns: 1fr;
            }
        }

        .save-status {
            text-align: center;
            padding: 12px;
            border-radius: var(--radius);
            margin-top: 15px;
            display: none;
            font-weight: 500;
        }

        .save-status.success {
            background: linear-gradient(135deg, rgba(102, 187, 106, 0.2), rgba(102, 187, 106, 0.1));
            color: var(--success);
            border: 1px solid rgba(102, 187, 106, 0.3);
            display: block;
            animation: fadeIn 0.5s ease;
        }

        /* Switch Toggle for Settings - Enhanced */
        .switch {
            position: relative;
            display: inline-block;
            width: 70px;
            height: 38px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 38px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 30px;
            width: 30px;
            left: 4px;
            bottom: 4px;
            background: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        input:checked + .slider {
            background: linear-gradient(135deg, var(--success), #81c784);
            border-color: var(--success);
        }

        input:checked + .slider:before {
            -webkit-transform: translateX(36px);
            -ms-transform: translateX(36px);
            transform: translateX(36px);
        }
        
        /* Responsive Fixes - Enhanced mobile */
        @media (min-width: 992px) {
            .sidebar {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: var(--sidebar-width);
            }
            
            .sidebar-close-btn {
                display: none;
            }
            
            .menu-toggle {
                display: none;
            }
            
            .header {
                 justify-content: flex-start;
                 gap: 30px;
            }
            
             .user-info {
                margin-left: auto;
            }
            
            #pageTitle {
                text-align: left;
                flex-grow: 0;
            }

            .messaging-container {
                height: 75vh;
            }
        }
        
        @media (max-width: 991px) {
            .sidebar {
                width: 85vw;
                max-width: var(--sidebar-width);
                z-index: 1001;
            }
            
            .main-content {
                margin-left: 0;
                padding: 20px;
            }
            
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: row;
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                gap: 12px;
                padding: 15px 20px;
            }
            
            .header-left-group {
                order: 1;
            }
            
            #pageTitle {
                order: 2;
                flex-grow: 1;
                text-align: center;
                display: block;
                font-size: 18px;
            }
            
            .user-info {
                order: 3;
                gap: 8px;
            }
            
            .menu-toggle {
                align-self: center;
                margin-bottom: 0;
            }
            
            .user-info div:last-child > div:first-child {
                display: none;
            }
            
            .user-info div:last-child {
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }

            /* Responsive Table CSS - Enhanced mobile cards */
            .table-container table,
            .table-container thead,
            .table-container tbody,
            .table-container th,
            .table-container td,
            .table-container tr {
                display: block;
            }

            .table-container thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            
            .table-container tr {
                border: 1px solid rgba(255, 255, 255, 0.1);
                margin-bottom: 15px;
                border-radius: var(--radius);
                overflow: hidden;
                background: rgba(42, 42, 42, 0.8);
                box-shadow: var(--shadow);
            }

            .table-container td {
                border: none;
                border-bottom: 1px solid rgba(255, 255, 255, 0.05);
                position: relative;
                padding: 15px 20px 15px 50%;
                text-align: right;
                min-height: 50px;
            }
            
            .table-container td:last-child {
                border-bottom: none;
                padding: 15px 20px;
                text-align: center;
            }

            .table-container td:before {
                position: absolute;
                top: 15px;
                left: 15px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: 600;
                color: var(--secondary);
                text-transform: uppercase;
                font-size: 13px;
                opacity: 0.8;
            }

            #studentsSection .table-container td:nth-of-type(1):before { content: "ID"; }
            #studentsSection .table-container td:nth-of-type(2):before { content: "Name"; }
            #studentsSection .table-container td:nth-of-type(3):before { content: "Grade"; }
            #studentsSection .table-container td:nth-of-type(4):before { content: "Phone"; }
            #studentsSection .table-container td:nth-of-type(5):before { content: "Monthly Fee"; }
            #studentsSection .table-container td:nth-of-type(6):before { content: "Fee Status"; }
            #studentsSection .table-container td:nth-of-type(7):before { content: "Actions"; }
            
            #feesSection .table-container td:nth-of-type(1):before { content: "Receipt ID"; }
            #feesSection .table-container td:nth-of-type(2):before { content: "Student Name"; }
            #feesSection .table-container td:nth-of-type(3):before { content: "Month"; }
            #feesSection .table-container td:nth-of-type(4):before { content: "Amount"; }
            #feesSection .table-container td:nth-of-type(5):before { content: "Status"; }
            #feesSection .table-container td:nth-of-type(6):before { content: "Date Paid"; }
            #feesSection .table-container td:nth-of-type(7):before { content: "Actions"; }

            .messaging-container {
                flex-direction: column;
                height: 75vh;
            }

            .contacts-list {
                width: 100%;
                max-height: 250px;
            }
            
            /* Mobile Social Media Styles */
            .profile-header {
                flex-direction: column;
                text-align: center;
                gap: 20px;
            }
            
            .profile-stats {
                justify-content: center;
                gap: 15px;
            }
            
            .profile-actions {
                justify-content: center;
            }
            
            .friends-container {
                grid-template-columns: 1fr;
            }
            
            /* Fix chat input on mobile */
            .chat-input-container {
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                padding: 15px;
                box-sizing: border-box;
                flex-wrap: nowrap;
                background: rgba(42, 42, 42, 0.95);
                backdrop-filter: blur(20px);
                border-top: 1px solid rgba(255, 255, 255, 0.1);
            }

            .chat-input {
                min-width: 0;
            }

            .send-btn {
                flex-shrink: 0;
            }

            /* Fix search bar on mobile */
            .search-bar {
                flex-direction: row;
                align-items: center;
            }

            .search-input {
                min-width: 0;
            }

            .btn {
                flex-shrink: 0;
                padding: 12px 20px;
                font-size: 14px;
            }

            /* Mobile Comments */
            .replies-container {
                margin-left: 25px;
            }

            .comment-input-container, .reply-input-container {
                flex-direction: column;
            }

            .comment-input, .reply-input {
                margin-bottom: 10px;
            }

            /* Auth form mobile */
            .auth-form {
                padding: 30px 20px;
                margin: 10px;
            }

            .auth-header h1 {
                font-size: 32px;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }
    </style>
</head>
<body>
<div class="auth-container" id="authSection">
<div class="auth-form shadow-md">
<div class="auth-header">
<h1><i class="fas fa-users"></i> Popcorn</h1>
<p>Complete Social Media Platform</p>
</div>
<div class="auth-tabs">
<div class="auth-tab active" id="loginTab">Login</div>
<div class="auth-tab" id="registerTab">Register</div>
</div>
<form id="loginForm">
<div class="form-group">
<label for="loginEmail"><i class="fas fa-envelope"></i> Email</label>
<input class="form-control" id="loginEmail" placeholder="Enter your email" required="" type="email"/>
</div>
<div class="form-group">
<label for="loginPassword"><i class="fas fa-lock"></i> Password</label>
<input class="form-control" id="loginPassword" placeholder="Enter your password" required="" type="password"/>
</div>
<button class="btn" type="submit">Login to Popcorn</button>
</form>
<form id="registerForm" style="display: none;">
<div class="form-group">
<label for="registerUsername"><i class="fas fa-user"></i> Username</label>
<input class="form-control" id="registerUsername" placeholder="Choose a username" required="" type="text"/>
</div>
<div class="form-group">
<label for="registerFullName"><i class="fas fa-id-card"></i> Full Name</label>
<input class="form-control" id="registerFullName" placeholder="Enter your full name" required="" type="text"/>
</div>
<div class="form-group">
<label for="registerPhone"><i class="fas fa-phone"></i> Phone Number</label>
<input class="form-control" id="registerPhone" placeholder="03XX-XXXXXXX" required="" type="tel"/>
</div>
<div class="form-group">
<label for="registerEmail"><i class="fas fa-envelope"></i> Email</label>
<input class="form-control" id="registerEmail" placeholder="Enter your email" required="" type="email"/>
</div>
<div class="form-group">
<label for="registerPassword"><i class="fas fa-lock"></i> Password</label>
<input class="form-control" id="registerPassword" placeholder="Create a password" required="" type="password"/>
</div>
<div class="form-group">
<label for="registerPIN"><i class="fas fa-key"></i> Security PIN</label>
<input class="form-control" id="registerPIN" maxlength="4" placeholder="4-digit PIN for security" required="" type="password"/>
</div>
<div class="form-group">
<label for="registerBio"><i class="fas fa-pen"></i> Bio</label>
<textarea class="form-control" id="registerBio" placeholder="Tell us about yourself" rows="3"></textarea>
</div>
<button class="btn btn-success" type="submit">Create Account</button>
</form>
<div id="authMessage" style="margin-top: 20px;"></div>
<div class="disclaimer-box">
<p><strong>⚠️ Data Storage Disclaimer:</strong></p>
<p><strong>English:</strong> This social media application uses Firebase Realtime Database for all data (users, posts, messages, stories). Your data is stored securely in the cloud.</p>
<p><strong>اردو:</strong> یہ سوشل میڈیا ایپلیکیشن تمام ڈیٹا (صارفین، پوسٹس، میسجز، سٹوریز) کے لیے Firebase Realtime Database استعمال کرتی ہے۔ آپ کا ڈیٹا کلاؤڈ میں محفوظ طریقے سے محفوظ ہوتا ہے۔</p>
</div>
</div>
</div>
<div class="app-container" id="appSection">
<div class="sidebar" id="sidebar">
<div class="sidebar-header">
<div class="logo-title">
<i class="fas fa-users fa-2x"></i>
<h2>Popcorn</h2>
</div>
<button aria-label="Close menu" class="sidebar-close-btn" id="sidebarCloseBtn">
<i class="fas fa-times"></i>
</button>
</div>
<ul class="sidebar-menu">
<li class="active" data-section="dashboard">
<i class="fas fa-home"></i> News Feed
                </li>
<li data-section="profile">
<i class="fas fa-user"></i> My Profile
                </li>
<li data-section="friends">
<i class="fas fa-user-friends"></i> Friends
                </li>
<li data-section="messages">
<i class="fas fa-comment-dots"></i> Messages
</li>
<li data-section="stories">
<i class="fas fa-history"></i> Stories
                </li>
<li data-section="notifications">
<i class="fas fa-bell"></i> Notifications
                </li>
<li data-section="search">
<i class="fas fa-search"></i> Search
                </li>
<li data-section="emsDashboard">
<i class="fas fa-tachometer-alt"></i> EMS Dashboard
                </li>
<li data-section="students">
<i class="fas fa-user-graduate"></i> Student Admission
                </li>
<li data-section="fees">
<i class="fas fa-money-bill-wave"></i> Fee Collection
                </li>
<li data-section="attendance">
<i class="fas fa-calendar-check"></i> Attendance
                </li>
<li data-section="settings">
<i class="fas fa-cog"></i> Settings
                </li>
<li data-section="branding">
<i class="fas fa-building"></i> Academy Branding
                </li>
</ul>
</div>
<div class="sidebar-backdrop" id="sidebarBackdrop"></div>
<div class="main-content" id="mainContent">
<div class="header shadow-md">
<div class="header-left-group">
<button class="menu-toggle" id="menuToggle">
<i class="fas fa-bars"></i>
</button>
</div>
<h1 id="pageTitle">News Feed</h1>
<div class="user-info">
<div class="user-avatar" id="userAvatar">U</div>
<div>
<div>Welcome, <strong id="loggedInUser">User</strong></div>
<button class="btn btn-danger btn-sm" id="logoutBtn">Logout</button>
</div>
</div>
</div>
<div class="content-section active" id="dashboardSection">
<div class="section-header">
<h2>News Feed</h2>
<p>Latest updates from your friends</p>
</div>
<div class="stories-container" id="storiesFeed">
<div class="story-item">
<div class="story-avatar story-add">
<i class="fas fa-plus"></i>
</div>
<div class="story-username">Your Story</div>
</div>
</div>
<div class="posts-container" id="postsFeed">
<div class="loading">Loading posts...</div>
</div>
</div>
<div class="content-section" id="profileSection">
<div class="section-header">
<h2>My Profile</h2>
<p>Manage your profile and settings</p>
</div>
<div class="profile-container">
<div class="profile-header">
<div class="profile-avatar" id="profileAvatar">U</div>
<div class="profile-info">
<h1 class="profile-name" id="profileName">User Name</h1>
<p class="profile-bio" id="profileBio">This is my bio</p>
<div class="profile-stats">
<div class="profile-stat">
<div class="stat-value" id="profilePosts">0</div>
<div class="stat-label">Posts</div>
</div>
<div class="profile-stat">
<div class="stat-value" id="profileFriends">0</div>
<div class="stat-label">Friends</div>
</div>
<div class="profile-stat">
<div class="stat-value" id="profileFollowers">0</div>
<div class="stat-label">Followers</div>
</div>
</div>
</div>
<div class="profile-actions">
<button class="btn" id="editProfileBtn">Edit Profile</button>
<button class="btn btn-success" id="createPostBtn">Create Post</button>
</div>
</div>
<div class="posts-container" id="profilePostsContainer">
<div class="loading">Loading your posts...</div>
</div>
</div>
</div>
<div class="content-section" id="friendsSection">
<div class="section-header">
<h2>Friends</h2>
<p>Manage your friends and connections</p>
</div>
<div class="search-container">
<div class="search-bar">
<input class="search-input" id="friendSearch" placeholder="Search for friends..." type="text"/>
<button class="btn" id="searchFriendBtn">Search</button>
</div>
</div>
<div class="friends-container" id="friendsList">
<div class="loading">Loading friends...</div>
</div>
<div class="section-header" style="margin-top: 45px;">
<h3>Friend Requests</h3>
</div>
<div class="friends-container" id="friendRequestsList">
<div class="loading">Loading friend requests...</div>
</div>
</div>

<div class="content-section" id="storiesSection">
<div class="section-header">
<h2>Stories</h2>
<p>Share moments that disappear after 24 hours</p>
</div>
<div class="stories-container" id="storiesList">
<div class="story-item">
<div class="story-avatar story-add">
<i class="fas fa-plus"></i>
</div>
<div class="story-username">Your Story</div>
</div>
</div>
<div class="form-container shadow-md">
<h3>Create New Story</h3>
<form id="storyForm">
<div class="form-group">
<label for="storyText">Story Text</label>
<textarea class="form-control" id="storyText" placeholder="What's happening?" rows="3"></textarea>
</div>
<button class="btn" type="submit">Add to Story</button>
</form>
</div>
</div>
<div class="content-section" id="notificationsSection">
<div class="section-header">
<h2>Notifications</h2>
<p>Your recent activity and updates</p>
</div>
<div class="notifications-container" id="notificationsList">
<div class="loading">Loading notifications...</div>
</div>
</div>
<div class="content-section" id="searchSection">
<div class="section-header">
<h2>Search</h2>
<p>Find people and content</p>
</div>
<div class="search-container">
<div class="search-bar">
<input class="search-input" id="globalSearch" placeholder="Search for people, posts, or hashtags..." type="text"/>
<button class="btn" id="globalSearchBtn">Search</button>
</div>
</div>
<div class="friends-container" id="searchResults">
<div class="no-contacts">
<i class="fas fa-search" style="font-size: 48px; color: var(--text-secondary); margin-bottom: 10px;"></i>
<p>Enter a search term to find people and content.</p>
</div>
</div>
</div>
<div class="content-section" id="messagesSection">
<div class="section-header">
<h2>Messages</h2>
<p>Chat with your friends</p>
</div>
<div class="messaging-container">
<div class="contacts-list" id="contactsList"></div>
<div class="chat-window" id="chatWindow">
<div class="no-chat-selected">
<i class="fas fa-comment-dots" style="font-size: 48px; color: var(--text-secondary); margin-bottom: 10px;"></i>
<p>Select a friend to start chatting.</p>
</div>
</div>
</div>
</div>
<!-- EMS Sections -->
<div class="content-section" id="emsDashboardSection">
<div class="section-header">
<h2>EMS Dashboard Overview</h2>
<p>Welcome to your education management dashboard</p>
</div>
<div class="dashboard-cards">
<div class="card shadow-hover">
<div class="card-icon">
<i class="fas fa-users"></i>
</div>
<h3>Total Students</h3>
<div class="card-value" id="totalStudents">0</div>
<div class="card-desc">Registered in academy</div>
</div>
<div class="card shadow-hover">
<div class="card-icon">
<i class="fas fa-coins"></i>
</div>
<h3>Fees Collected</h3>
<div class="card-value"><span class="currency" id="feesCollected">0</span></div>
<div class="card-desc">This month</div>
</div>
<div class="card shadow-hover">
<div class="card-icon">
<i class="fas fa-clipboard-check"></i>
</div>
<h3>Today's Attendance</h3>
<div class="card-value" id="todayAttendance">0%</div>
<div class="card-desc">Present students</div>
</div>
<div class="card shadow-hover">
<div class="card-icon">
<i class="fas fa-exclamation-circle"></i>
</div>
<h3>Pending Fees</h3>
<div class="card-value" id="pendingFees">0</div>
<div class="card-desc">For current month</div>
</div>
</div>
<div class="form-row">
<div class="table-container shadow-md">
<h3>Recent Fee collections</h3>
<div class="table-responsive">
<table id="recentFeesTable">
<thead>
<tr>
<th>Student</th>
<th>Amount</th>
<th>Status</th>
<th>Date</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</div>
</div>
<div class="table-container shadow-md">
<h3>Recent Attendance</h3>
<div class="table-responsive">
<table id="recentAttendanceTable">
<thead>
<tr>
<th>Date</th>
<th>Present</th>
<th>Absent</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="content-section" id="studentsSection">
<div class="section-header">
<h2>Student Admission</h2>
<p>Manage student records and information</p>
</div>
<div class="form-container shadow-md">
<h3>Add New Student</h3>
<form id="studentForm">
<div class="form-row">
<div class="form-group">
<label for="studentName">Student Name</label>
<input class="form-control" id="studentName" placeholder="Full name of student" required="" type="text"/>
</div>
<div class="form-group">
<label for="studentGrade">Grade (1-12)</label>
<select class="form-control" id="studentGrade" required="">
<option value="">Select Grade</option>
<option value="1">Grade 1</option>
<option value="2">Grade 2</option>
<option value="3">Grade 3</option>
<option value="4">Grade 4</option>
<option value="5">Grade 5</option>
<option value="6">Grade 6</option>
<option value="7">Grade 7</option>
<option value="8">Grade 8</option>
<option value="9">Grade 9</option>
<option value="10">Grade 10</option>
<option value="11">Grade 11</option>
<option value="12">Grade 12</option>
</select>
</div>
<div class="form-group">
<label for="studentPhone">Parent's Phone</label>
<input class="form-control" id="studentPhone" placeholder="03XX-XXXXXXX" required="" type="tel"/>
</div>
<div class="form-group">
<label for="studentFee">Monthly Fee (PKR)</label>
<input class="form-control" id="studentFee" placeholder="Monthly fee amount" required="" type="number"/>
</div>
</div>
<button class="btn" style="margin-top: 20px;" type="submit"><i class="fas fa-plus-circle"></i> Add Student</button>
</form>
</div>
<div class="table-container shadow-md">
<h3>Student Records (History)</h3>
<div class="table-responsive">
<table id="studentsTable">
<thead>
<tr>
<th>ID</th>
<th>Name</th>
<th>Grade</th>
<th>Phone</th>
<th>Monthly Fee</th>
<th>Fee Status</th>
<th>Actions</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</div>
</div>
</div>
<div class="content-section" id="feesSection">
<div class="section-header">
<h2>Fee Collection</h2>
<p>Record and manage student fee payments</p>
</div>
<div class="form-container shadow-md">
<h3>Collect Fee</h3>
<form id="feeForm">
<div class="form-row">
<div class="form-group">
<label for="feeStudent">Select Student</label>
<select class="form-control" id="feeStudent" required="">
<option value="">Select Student</option>
</select>
</div>
<div class="form-group">
<label for="feeMonth">Month</label>
<input class="form-control" id="feeMonth" required="" type="month"/>
</div>
<div class="form-group">
<label for="feeAmount">Amount (PKR)</label>
<input class="form-control" id="feeAmount" placeholder="Amount to collect" required="" type="number"/>
<small id="feeHelp" style="color: var(--text-secondary); font-weight: 500; margin-top: 5px; display: block;">
                                    Monthly Fee: <span class="currency" id="monthlyFeeDisplay" style="color: var(--success);">0</span> | 
                                    <span style="color: var(--danger);">Remaining/Due: <span class="currency" id="remainingFeeDisplay" style="color: var(--danger);">0</span></span>
</small>
</div>
<div class="form-group">
<label for="feeDate">Payment Date</label>
<input class="form-control" id="feeDate" required="" type="date"/>
</div>
</div>
<button class="btn" style="margin-top: 20px;" type="submit"><i class="fas fa-money-check"></i> Collect Fee</button>
</form>
</div>
<div class="table-container shadow-md">
<h3>Fee Records (History)</h3>
<div class="table-responsive">
<table id="feesTable">
<thead>
<tr>
<th>Receipt ID</th>
<th>Student Name</th>
<th>Month</th>
<th>Amount</th>
<th>Status</th>
<th>Date Paid</th>
<th>Actions</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</div>
</div>
</div>
<div class="content-section" id="attendanceSection">
<div class="section-header">
<h2>Attendance Management</h2>
<p>Track and manage student attendance</p>
</div>
<div class="form-container shadow-md">
<h3>Mark Attendance</h3>
<form id="attendanceForm">
<div class="form-row">
<div class="form-group">
<label for="attendanceDate">Date</label>
<input class="form-control" id="attendanceDate" required="" type="date"/>
</div>
</div>
<div class="form-group">
<label>Mark Attendance for Students</label>
<div id="attendanceList" style="max-height: 500px; overflow-y: auto; border: 1px solid rgba(255, 255, 255, 0.1); padding: 20px; border-radius: var(--radius); background: rgba(42, 42, 42, 0.5);">
</div>
</div>
<button class="btn" style="margin-top: 20px;" type="submit"><i class="fas fa-save"></i> Save Attendance</button>
</form>
</div>
<div class="table-container shadow-md">
<h3>Attendance Records (History)</h3>
<div class="table-responsive">
<table id="attendanceTable">
<thead>
<tr>
<th>Date</th>
<th>Present</th>
<th>Absent</th>
<th>Percentage</th>
<th>Actions</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</div>
</div>
</div>
<div class="content-section" id="settingsSection">
<div class="section-header">
<h2>Settings</h2>
<p>Manage your account and preferences</p>
</div>
<div class="form-container shadow-md">
<h3>Account Settings</h3>
<form id="settingsForm">
<div class="form-group">
<label for="changePasswordEmail">Reset Password</label>
<input class="form-control" id="changePasswordEmail" placeholder="Enter email to send reset link" required="" type="email"/>
<button class="btn btn-warning" onclick="sendPasswordReset()" type="button">Send Reset Link</button>
</div>
<div class="form-group">
<label>Notifications</label>
<label class="switch">
<input checked="" id="notificationsToggle" type="checkbox"/>
<span class="slider"></span>
</label>
<small>Enable/disable push notifications</small>
</div>
<div class="form-group">
<label for="privacySetting">Privacy</label>
<select class="form-control" id="privacySetting">
<option value="public">Public</option>
<option value="friends">Friends Only</option>
<option value="private">Private</option>
</select>
</div>
</form>
</div>
</div>
<div class="content-section" id="brandingSection">
<div class="section-header">
<h2>Academy Branding</h2>
<p>Set up your school or academy details for WhatsApp receipts and alerts</p>
</div>
<div class="branding-container">
<div class="form-container shadow-md">
<h3>Branding Settings</h3>
<form id="brandingForm">
<div class="form-row branding-form-row">
<div class="form-group">
<label for="schoolName"><i class="fas fa-school"></i> School/Academy Name</label>
<input class="form-control" disabled="" id="schoolName" placeholder="Enter your school or academy name" type="text"/>
</div>
<div class="form-group">
<label for="schoolPhone"><i class="fas fa-phone"></i> Academy Phone Number</label>
<input class="form-control" disabled="" id="schoolPhone" placeholder="03XX-XXXXXXX" type="tel"/>
</div>
</div>
<button class="btn btn-success" disabled="" type="submit"><i class="fas fa-save"></i> Save Branding</button>
<div class="save-status" id="saveStatus"></div>
</form>
</div>
<div class="form-container shadow-md">
<h3>WhatsApp Message Preview</h3>
<div class="branding-preview" id="brandingPreview">
                            Fee Receipt - Sample Student
                            
                            Month: 2025-10
                            Amount: PKR 5000
                            Status: Fully Paid
                            Date: 2025-10-12
                            
                            [Your Academy Name Here]
                            Contact: [Your Academy Phone Here]
                            
                            Thank you! - Created by Sample User
                        </div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<!-- Share Menu -->
<div class="share-menu" id="shareMenu">
<ul>
<li onclick="copyPostLink(currentPostId)"><i class="fas fa-link"></i> Copy Link</li>
<li onclick="savePost(currentPostId)"><i class="fas fa-bookmark"></i> Save Post</li>
<li onclick="shareToWhatsApp(currentPostId)"><i class="fab fa-whatsapp"></i> Share to WhatsApp</li>
<li onclick="closeShareMenu()"><i class="fas fa-times"></i> Cancel</li>
</ul>
</div>
<!-- Create Post Modal -->
<div class="modal" id="postModal">
<div class="modal-content">
<div class="modal-header">
<h3><i class="fas fa-edit"></i> Create Post</h3>
<span class="close-modal" onclick="closePostModal()">×</span>
</div>
<form id="createPostForm">
<div class="form-group">
<textarea class="form-control" id="postContent" placeholder="What's on your mind?" required="" rows="5"></textarea>
</div>
<div class="form-group">
<label for="postMedia">Add Photo/Video (optional)</label>
<input accept="image/*,video/*" class="form-control" id="postMedia" type="file"/>
</div>
<div class="form-group">
<label for="fontSize">Font Size</label>
<select class="form-control" id="fontSize">
<option value="normal">Normal</option>
<option value="large">Large</option>
</select>
</div>
<div style="display: flex; justify-content: space-between; gap: 12px; margin-top: 25px;">
<button class="btn btn-danger" onclick="closePostModal()" type="button">Cancel</button>
<button class="btn btn-success" type="submit">Post</button>
</div>
</form>
</div>
</div>
<!-- Edit Profile Modal -->
<div class="modal" id="profileModal">
<div class="modal-content">
<div class="modal-header">
<h3><i class="fas fa-user-edit"></i> Edit Profile</h3>
<span class="close-modal" onclick="closeProfileModal()">×</span>
</div>
<form id="editProfileForm">
<div class="form-group">
<label for="editFullName">Full Name</label>
<input class="form-control" id="editFullName" required="" type="text"/>
</div>
<div class="form-group">
<label for="editUsername">Username</label>
<input class="form-control" id="editUsername" required="" type="text"/>
</div>
<div class="form-group">
<label for="editBio">Bio</label>
<textarea class="form-control" id="editBio" rows="3"></textarea>
</div>
<div class="form-group">
<label for="editAvatar">Avatar Initial</label>
<input class="form-control" id="editAvatar" maxlength="1" required="" type="text"/>
</div>
<div style="display: flex; justify-content: space-between; gap: 12px; margin-top: 25px;">
<button class="btn btn-danger" onclick="closeProfileModal()" type="button">Cancel</button>
<button class="btn btn-success" type="submit">Save Changes</button>
</div>
</form>
</div>
</div>
<!-- Story Viewer Modal -->
<div class="modal" id="storyModal">
<div class="modal-content" style="width: 550px; max-width: 90%;">
<div class="modal-header">
<h3 id="storyUsername"><i class="fas fa-history"></i> Story</h3>
<span class="close-modal" onclick="closeStoryModal()">×</span>
</div>
<div class="story-content" id="storyContent"></div>
<div class="comments-section" id="storyRepliesSection">
<div class="comment-input-container">
<input class="comment-input" id="storyReplyInput" placeholder="Reply to this story..." type="text"/>
<button class="add-comment-btn" onclick="addStoryReply()">Reply</button>
</div>
<div id="storyReplies"></div>
</div>
</div>
</div>
<div class="modal" id="pinModal">
<div class="modal-content">
<div class="modal-header">
<h3><i class="fas fa-lock"></i> Enter Security PIN</h3>
<span class="close-modal" onclick="closePinModal()">×</span>
</div>
<p style="margin-bottom: 15px; color: var(--text-secondary);">To perform this secure action (Delete/Edit), please enter your 4-digit PIN.</p>
<div class="form-group">
<input class="form-control" id="pinInput" maxlength="4" placeholder="Enter your 4-digit PIN" type="password"/>
</div>
<div style="display: flex; justify-content: space-between; gap: 12px; margin-top: 25px;">
<button class="btn btn-danger" onclick="closePinModal()">Cancel</button>
<button class="btn btn-success" onclick="verifyPin()">Verify PIN</button>
</div>
</div>
</div>
<script>
        // Global variables for share menu
        let currentPostId = null;
        let currentStoryId = null;

        // ✅ FIXED Firebase Configuration - Database URL Updated
        const firebaseConfig = {
            apiKey: "AIzaSyAaM6vNyFpliNAgzujoG4xBDbTGmSB33no",
            authDomain: "ems-by-ali.firebaseapp.com",
            projectId: "ems-by-ali",
            storageBucket: "ems-by-ali.firebasestorage.app",
            messagingSenderId: "920434998465",
            appId: "1:920434998465:web:e52f12fdb9fa1d64cf6840",
            measurementId: "G-ZX7G5E1B45",
            databaseURL: "https://ems-by-ali-default-rtdb.asia-southeast1.firebasedatabase.app" // ✅ FIXED URL
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const storage = firebase.storage();

        // Application state
        let currentUser = null;
        let users = {};
        let currentChatUser = null;
        let currentMessagesRef = null;

        // EMS state
        let students = {};
        let fees = {};
        let attendance = {};
        let currentAction = null;
        let currentItemId = null;

        // Default branding (locked)
        const defaultSchoolName = "Powered by Ali ® 2025 03091539086";
        const defaultSchoolPhone = "03091539086";

        // Sidebar Elements
        const sidebar = document.getElementById('sidebar');
        const backdrop = document.getElementById('sidebarBackdrop');

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is signed in
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = {
                        uid: user.uid,
                        email: user.email
                    };
                    
                    // Load user data from DB
                    db.ref('users/' + currentUser.uid).on('value', (snap) => {
                        if (snap.exists()) {
                            const data = snap.val();
                            currentUser.username = data.username;
                            currentUser.fullName = data.fullName;
                            currentUser.phone = data.phone;
                            currentUser.schoolName = data.schoolName || defaultSchoolName;
                            currentUser.schoolPhone = data.schoolPhone || defaultSchoolPhone;
                            currentUser.bio = data.bio || '';
                            currentUser.avatar = data.avatar || currentUser.fullName.charAt(0).toUpperCase();
                            currentUser.createdAt = data.createdAt;
                            currentUser.pin = data.pin;
                            currentUser.brandingUnlocked = data.brandingUnlocked || false; // Fixed: Fetch brandingUnlocked
                            const dbToken = data.sessionToken;
                            const localToken = localStorage.getItem('sessionToken');
                            if (dbToken && localToken !== dbToken) {
                                auth.signOut();
                                alert('Logged out: Session active on another device.');
                                return;
                            }
                            loadUserData();
                            showApp();
                        }
                    });
                } else {
                    currentUser = null;
                }
            });

            // Set up event listeners
            setupEventListeners();
            
            // Set current dates for EMS
            const today = new Date().toISOString().split('T')[0];
            if (document.getElementById('feeMonth')) document.getElementById('feeMonth').valueAsDate = new Date();
            if (document.getElementById('feeDate')) document.getElementById('feeDate').value = today;
            if (document.getElementById('attendanceDate')) document.getElementById('attendanceDate').value = today;
        });

        // Set up event listeners
        function setupEventListeners() {
            // Auth tabs
            document.getElementById('loginTab').addEventListener('click', () => switchAuthTab('login'));
            document.getElementById('registerTab').addEventListener('click', () => switchAuthTab('register'));
            
            // Auth forms
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', function(e) {
                e.preventDefault();
                handleLogout();
            });
            
            // Sidebar toggle and close
            document.getElementById('menuToggle').addEventListener('click', openSidebar); 
            document.getElementById('sidebarCloseBtn').addEventListener('click', closeSidebar);
            backdrop.addEventListener('click', closeSidebar);
            
            // Menu items
            document.querySelectorAll('.sidebar-menu li').forEach(item => {
                item.addEventListener('click', () => {
                    const section = item.getAttribute('data-section');
                    showSection(section);
                    
                    // Update active menu item
                    document.querySelectorAll('.sidebar-menu li').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    
                    // Close sidebar after selection
                    closeSidebar();
                });
            });
            
            // Post creation
            document.getElementById('createPostBtn').addEventListener('click', openPostModal);
            document.getElementById('createPostForm').addEventListener('submit', handleCreatePost);
            
            // Profile editing
            document.getElementById('editProfileBtn').addEventListener('click', openProfileModal);
            document.getElementById('editProfileForm').addEventListener('submit', handleEditProfile);
            
            // Friend search
            document.getElementById('searchFriendBtn').addEventListener('click', handleFriendSearch);
            document.getElementById('friendSearch').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleFriendSearch();
            });
            
            // Global search
            document.getElementById('globalSearchBtn').addEventListener('click', handleGlobalSearch);
            document.getElementById('globalSearch').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleGlobalSearch();
            });
            
            // Story creation
            document.getElementById('storyForm').addEventListener('submit', handleCreateStory);
            
            // EMS event listeners
            if (document.getElementById('studentForm')) document.getElementById('studentForm').addEventListener('submit', handleAddStudent);
            if (document.getElementById('feeForm')) document.getElementById('feeForm').addEventListener('submit', handleFeeCollection);
            if (document.getElementById('feeStudent')) document.getElementById('feeStudent').addEventListener('change', updateFeeInfo);
            if (document.getElementById('feeMonth')) document.getElementById('feeMonth').addEventListener('change', updateFeeInfo);
            if (document.getElementById('attendanceForm')) document.getElementById('attendanceForm').addEventListener('submit', handleAttendance);
            if (document.getElementById('attendanceDate')) document.getElementById('attendanceDate').addEventListener('change', loadAttendanceForm);
        }

        // Sidebar Control functions
        function openSidebar() {
            sidebar.classList.add('open');
            backdrop.classList.add('open');
        }

        function closeSidebar() {
            sidebar.classList.remove('open');
            backdrop.classList.remove('open');
        }

        // Authentication functions
        function switchAuthTab(tab) {
            document.getElementById('loginTab').classList.toggle('active', tab === 'login');
            document.getElementById('registerTab').classList.toggle('active', tab === 'register');
            document.getElementById('loginForm').style.display = tab === 'login' ? 'block' : 'none';
            document.getElementById('registerForm').style.display = tab === 'register' ? 'block' : 'none';
            document.getElementById('authMessage').innerHTML = '';
            
            if (tab === 'login') {
                document.getElementById('registerForm').reset();
            } else {
                document.getElementById('loginForm').reset();
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const sessionToken = generateId();
                    db.ref('users/' + userCredential.user.uid + '/sessionToken').set(sessionToken);
                    localStorage.setItem('sessionToken', sessionToken);
                    showAuthMessage('Login successful! Redirecting to dashboard...', 'success');
                })
                .catch((error) => {
                    showAuthMessage('Invalid email or password. Please try again.', 'error');
                });
        }

        function handleRegister(e) {
            e.preventDefault();
            const username = document.getElementById('registerUsername').value;
            const fullName = document.getElementById('registerFullName').value;
            const phone = document.getElementById('registerPhone').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const bio = document.getElementById('registerBio').value;
            const pin = document.getElementById('registerPIN').value;
            
            if (!phone.match(/^03\d{9}$/)) {
                showAuthMessage('Please enter a valid Pakistani phone number (03XXXXXXXXX)', 'error');
                return;
            }
            
            if (pin.length !== 4 || isNaN(pin)) {
                showAuthMessage('PIN must be a 4-digit number', 'error');
                return;
            }
            
            // Check if username already exists
            db.ref('users').orderByChild('username').equalTo(username).once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        showAuthMessage('Username already exists. Please choose a different one.', 'error');
                    } else {
                        // Create user with email and password
                        auth.createUserWithEmailAndPassword(email, password)
                            .then((userCredential) => {
                                const user = userCredential.user;
                                
                                // Store user data in Firebase
                                db.ref('users/' + user.uid).set({
                                    username,
                                    usernameLower: username.toLowerCase(),
                                    fullName,
                                    phone,
                                    email,
                                    bio,
                                    avatar: fullName.charAt(0).toUpperCase(),
                                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                                    lastSeen: firebase.database.ServerValue.TIMESTAMP,
                                    pin,
                                    brandingUnlocked: false,
                                    schoolName: defaultSchoolName,
                                    schoolPhone: defaultSchoolPhone
                                }).then(() => {
                                    const sessionToken = generateId();
                                    db.ref('users/' + user.uid + '/sessionToken').set(sessionToken);
                                    localStorage.setItem('sessionToken', sessionToken);
                                    showAuthMessage('Registration successful! Loading dashboard...', 'success');
                                    document.getElementById('registerForm').reset();
                                }).catch((dbError) => {
                                    showAuthMessage('Error saving user data: ' + dbError.message, 'error');
                                });
                            })
                            .catch((error) => {
                                const errorCode = error.code;
                                const errorMessage = error.message;
                                showAuthMessage('Error creating account: ' + errorMessage, 'error');
                            });
                    }
                });
        }

        function showAuthMessage(message, type) {
            const messageDiv = document.getElementById('authMessage');
            const style = type === 'success' ? 'background: linear-gradient(135deg, #5cb860, #81c784); color: white; padding: 12px; border-radius: var(--radius); box-shadow: var(--shadow);' : 
                                               'background: linear-gradient(135deg, #e53935, #e57373); color: white; padding: 12px; border-radius: var(--radius); box-shadow: var(--shadow);';
            messageDiv.innerHTML = `<div style="${style}">${message}</div>`;
        }

        // Handle logout with proper cleanup
        function handleLogout() {
            if (currentMessagesRef) {
                currentMessagesRef.off();
            }
            
            // Update last seen timestamp
            if (currentUser) {
                db.ref('users/' + currentUser.uid + '/lastSeen').set(firebase.database.ServerValue.TIMESTAMP);
            }
            
            auth.signOut().then(() => {
                clearUserData();
                
                // Reset forms
                document.getElementById('loginForm').reset();
                document.getElementById('registerForm').reset();
                
                // Show auth section and hide app section
                document.getElementById('authSection').style.display = 'flex';
                document.getElementById('appSection').style.display = 'none';
                
                // Switch to login tab
                switchAuthTab('login');
                
                // Clear any auth messages
                document.getElementById('authMessage').innerHTML = '';
                
                console.log("User logged out successfully");
            }).catch((error) => {
                console.error("Error signing out:", error);
            });
        }

        // Clear EMS data on logout
        function clearUserData() {
            students = {};
            fees = {};
            attendance = {};
            currentUser = null;
            if (currentMessagesRef) {
                currentMessagesRef.off();
            }
        }

        // Load user-specific EMS data from Firebase
        function loadUserData() {
            if (!currentUser) return;

            // Load students
            db.ref(`ems/${currentUser.uid}/students`).on('value', (snap) => {
                students = snap.val() || {};
                updateDashboard();
                updateStudentDropdown();
                loadStudentsTable();
            });

            // Load fees
            db.ref(`ems/${currentUser.uid}/fees`).on('value', (snap) => {
                fees = snap.val() || {};
                loadFeesTable();
                updateDashboard();
            });

            // Load attendance
            db.ref(`ems/${currentUser.uid}/attendance`).on('value', (snap) => {
                attendance = snap.val() || {};
                loadAttendanceTable();
                updateDashboard();
            });

            updateBrandingPreview();
        }

        // UI Navigation functions
        function showApp() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('appSection').style.display = 'block';
            
            // Handle display for logged-in user
            const userName = currentUser.fullName || currentUser.username || currentUser.email.split('@')[0];
            document.getElementById('loggedInUser').textContent = userName;
            document.getElementById('userAvatar').textContent = currentUser.avatar;
            document.getElementById('changePasswordEmail').value = currentUser.email;
            
            // Update profile section
            updateProfileSection();
            
            // Update branding form (locked, show default)
            document.getElementById('schoolName').value = currentUser.schoolName;
            document.getElementById('schoolPhone').value = currentUser.schoolPhone;
            
            showSection('dashboard');
            
            // Load users in real-time
            db.ref('users').on('value', (snap) => {
                users = {};
                snap.forEach((child) => {
                    users[child.key] = child.val();
                });
                if (document.getElementById('messagesSection').classList.contains('active')) {
                    loadMessagesContacts();
                }
            });
            
            // Set up presence
            const myPresenceRef = db.ref('users/' + currentUser.uid + '/lastSeen');
            db.ref('.info/connected').on('value', (snap) => {
                if (snap.val()) {
                    myPresenceRef.onDisconnect().set(firebase.database.ServerValue.TIMESTAMP);
                    myPresenceRef.set(firebase.database.ServerValue.TIMESTAMP);
                }
            });
            setInterval(() => {
                myPresenceRef.set(firebase.database.ServerValue.TIMESTAMP);
            }, 60000); // Update every minute
        }

        function showSection(section) {
            document.querySelectorAll('.content-section').forEach(sec => {
                sec.classList.remove('active');
            });
            
            document.getElementById(`${section}Section`).classList.add('active');
            
            const titles = {
                dashboard: 'News Feed',
                profile: 'My Profile',
                friends: 'Friends',
                messages: 'Messages',
                stories: 'Stories',
                notifications: 'Notifications',
                search: 'Search',
                emsDashboard: 'EMS Dashboard Overview',
                students: 'Student Admission',
                fees: 'Fee Collection',
                attendance: 'Attendance Management',
                settings: 'Settings',
                branding: 'Academy Branding'
            };
            document.getElementById('pageTitle').textContent = titles[section] || section;
            
            if(section === 'branding') {
                loadBrandingSection();
            } else if (section === 'dashboard') {
                loadNewsFeed();
                loadStories();
            } else if (section === 'profile') {
                loadProfilePosts();
            } else if (section === 'friends') {
                loadFriends();
                loadFriendRequests();
            } else if (section === 'messages') {
                loadMessagesContacts();
            } else if (section === 'stories') {
                loadStories();
            } else if (section === 'notifications') {
                loadNotifications();
            } else if (section === 'search') {
                // Clear search results
                document.getElementById('searchResults').innerHTML = `
                    <div class="no-contacts">
                        <i class="fas fa-search" style="font-size: 48px; color: var(--text-secondary); margin-bottom: 10px;"></i>
                        <p>Enter a search term to find people and content.</p>
                    </div>
                `;
            } else if (section === 'emsDashboard') {
                updateDashboard();
            } else if (section === 'students') {
                loadStudentsTable();
            } else if (section === 'fees') {
                loadFeesTable();
            } else if (section === 'attendance') {
                loadAttendanceForm();
            } else if (section === 'settings') {
                // Settings loaded statically
            } else if (section === 'branding') {
                updateBrandingPreview();
            }
        }

        // Settings functions
        function sendPasswordReset() {
            const email = document.getElementById('changePasswordEmail').value;
            auth.sendPasswordResetEmail(email).then(() => {
                alert('Password reset email sent!');
            }).catch(error => {
                alert('Error: ' + error.message);
            });
        }

        // Branding Management (locked)
        function updateBrandingPreview() {
            const preview = document.getElementById('brandingPreview');
            const branding = currentUser.schoolName ? `${currentUser.schoolName}\n` : '';
            const contact = currentUser.schoolPhone ? `Contact: ${currentUser.schoolPhone}\n` : '';
            preview.textContent = `Fee Receipt - Sample Student

Month: 2025-10
Amount: PKR 5000
Status: Fully Paid
Date: 2025-10-12

${branding}${contact}Thank you! - Created by Sample User`;
        }

        function loadBrandingSection() {
            document.getElementById('schoolName').value = currentUser.schoolName;
            document.getElementById('schoolPhone').value = currentUser.schoolPhone;
            updateBrandingPreview();

            const form = document.getElementById('brandingForm');
            const button = form.querySelector('button');
            const inputs = form.querySelectorAll('input');
            const container = document.querySelector('.branding-container .form-container');

            // Remove existing message if any
            let existingMsg = container.querySelector('.unlock-message');
            if (existingMsg) existingMsg.remove();

            if (currentUser.brandingUnlocked) {
                inputs.forEach(inp => inp.disabled = false);
                button.disabled = false;
                if (!form.hasListener) {
                    form.addEventListener('submit', handleSaveBranding);
                    form.hasListener = true;
                }
            } else {
                inputs.forEach(inp => inp.disabled = true);
                button.disabled = true;

                const unlockMessage = document.createElement('div');
                unlockMessage.className = 'unlock-message';
                unlockMessage.style.marginTop = '25px';
                unlockMessage.innerHTML = `
                    <p style="color: var(--warning); text-align: center; font-weight: 500;">Custom branding is a paid feature.</p>
                    <p style="text-align: center; opacity: 0.8;">To unlock, contact Ali for payment.</p>
                    <button class="btn btn-whatsapp" style="display: block; margin: 15px auto;" onclick="contactAdmin()">Contact on WhatsApp</button>
                `;
                container.appendChild(unlockMessage);
            }
        }

        function handleSaveBranding(e) {
            e.preventDefault();
            const schoolName = document.getElementById('schoolName').value;
            const schoolPhone = document.getElementById('schoolPhone').value;

            db.ref('users/' + currentUser.uid).update({
                schoolName,
                schoolPhone
            }).then(() => {
                currentUser.schoolName = schoolName;
                currentUser.schoolPhone = schoolPhone;
                updateBrandingPreview();
                showSaveStatus('Branding saved successfully!');
            });
        }

        function showSaveStatus(msg) {
            const status = document.getElementById('saveStatus');
            status.textContent = msg;
            status.classList.add('success');
            status.style.display = 'block';
            setTimeout(() => {
                status.style.display = 'none';
                status.classList.remove('success');
            }, 3000);
        }

        function contactAdmin() {
            const adminPhone = '03091539086';
            const message = 'Hello Ali, I want to unlock custom branding for Popcorn app.';
            openWhatsApp(adminPhone, message);
        }

        // Profile Management
        function updateProfileSection() {
            document.getElementById('profileName').textContent = currentUser.fullName;
            document.getElementById('profileBio').textContent = currentUser.bio || 'No bio yet';
            document.getElementById('profileAvatar').textContent = currentUser.avatar;
            
            // Followers same as friends for simplicity
            document.getElementById('profileFollowers').textContent = document.getElementById('profileFriends').textContent;
        }

        function openProfileModal() {
            document.getElementById('editFullName').value = currentUser.fullName;
            document.getElementById('editUsername').value = currentUser.username;
            document.getElementById('editBio').value = currentUser.bio || '';
            document.getElementById('editAvatar').value = currentUser.avatar;
            
            document.getElementById('profileModal').style.display = 'flex';
            setTimeout(() => document.querySelector('#profileModal .modal-content').classList.add('show'), 10);
        }

        function closeProfileModal() {
            document.querySelector('#profileModal .modal-content').classList.remove('show');
            setTimeout(() => document.getElementById('profileModal').style.display = 'none', 400);
        }

        function handleEditProfile(e) {
            e.preventDefault();
            
            const fullName = document.getElementById('editFullName').value;
            const username = document.getElementById('editUsername').value;
            const bio = document.getElementById('editBio').value;
            const avatar = document.getElementById('editAvatar').value;
            
            // Check if username changed and if it's available
            if (username !== currentUser.username) {
                db.ref('users').orderByChild('username').equalTo(username).once('value')
                    .then((snapshot) => {
                        if (snapshot.exists()) {
                            alert('Username already exists. Please choose a different one.');
                        } else {
                            updateProfileData(fullName, username, bio, avatar);
                        }
                    });
            } else {
                updateProfileData(fullName, username, bio, avatar);
            }
        }

        function updateProfileData(fullName, username, bio, avatar) {
            db.ref('users/' + currentUser.uid).update({
                fullName,
                username,
                usernameLower: username.toLowerCase(),
                bio,
                avatar: avatar.charAt(0).toUpperCase()
            }).then(() => {
                // Update local user data
                currentUser.fullName = fullName;
                currentUser.username = username;
                currentUser.bio = bio;
                currentUser.avatar = avatar.charAt(0).toUpperCase();
                
                // Update UI
                updateProfileSection();
                document.getElementById('loggedInUser').textContent = currentUser.fullName;
                document.getElementById('userAvatar').textContent = currentUser.avatar;
                
                closeProfileModal();
                alert('Profile updated successfully!');
            }).catch((error) => {
                alert('Error updating profile: ' + error.message);
            });
        }

        // Post Management
        function openPostModal() {
            document.getElementById('postContent').value = '';
            document.getElementById('fontSize').value = 'normal';
            document.getElementById('postMedia').value = '';
            document.getElementById('postModal').style.display = 'flex';
            setTimeout(() => document.querySelector('#postModal .modal-content').classList.add('show'), 10);
        }

        function closePostModal() {
            document.querySelector('#postModal .modal-content').classList.remove('show');
            setTimeout(() => document.getElementById('postModal').style.display = 'none', 400);
        }

        async function handleCreatePost(e) {
            e.preventDefault();
            
            const content = document.getElementById('postContent').value;
            const fontSize = document.getElementById('fontSize').value;
            const file = document.getElementById('postMedia').files[0];
            
            if (!content.trim()) {
                alert('Please enter some content for your post');
                return;
            }
            
            const postId = db.ref('posts').push().key;
            const newPost = {
                id: postId,
                userId: currentUser.uid,
                username: currentUser.username,
                fullName: currentUser.fullName,
                avatar: currentUser.avatar,
                content: content,
                fontSize: fontSize,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                likes: 0,
                comments: 0,
                shares: 0
            };
            
            if (file) {
                const storageRef = storage.ref(`posts/${postId}/${file.name}`);
                await storageRef.put(file);
                const mediaURL = await storageRef.getDownloadURL();
                newPost.mediaURL = mediaURL;
                newPost.mediaType = file.type.startsWith('image') ? 'image' : 'video';
            }
            
            db.ref('posts/' + postId).set(newPost)
                .then(() => {
                    closePostModal();
                    alert('Post created successfully!');
                    
                    // Refresh posts feed
                    if (document.getElementById('dashboardSection').classList.contains('active')) {
                        loadNewsFeed();
                    }
                    if (document.getElementById('profileSection').classList.contains('active')) {
                        loadProfilePosts();
                    }
                })
                .catch((error) => {
                    alert('Error creating post: ' + error.message);
                });
        }

        function loadNewsFeed() {
            const postsFeed = document.getElementById('postsFeed');
            postsFeed.innerHTML = '<div class="loading">Loading posts...</div>';
            
            db.ref('posts').orderByChild('timestamp').on('value', (snapshot) => {
                postsFeed.innerHTML = '';
                
                if (!snapshot.exists()) {
                    postsFeed.innerHTML = `
                        <div class="no-contacts">
                            <i class="fas fa-newspaper" style="font-size: 48px; color: var(--text-secondary); margin-bottom: 10px;"></i>
                            <p>No posts yet. Be the first to post!</p>
                        </div>
                    `;
                    return;
                }
                
                const posts = [];
                snapshot.forEach((child) => {
                    posts.push(child.val());
                });
                
                // Sort by timestamp (newest first)
                posts.sort((a, b) => b.timestamp - a.timestamp);
                
                posts.forEach(async post => {
                    const postElement = await createPostElement(post);
                    postsFeed.appendChild(postElement);
                });
            });
        }

        function loadProfilePosts() {
            const profilePostsContainer = document.getElementById('profilePostsContainer');
            profilePostsContainer.innerHTML = '<div class="loading">Loading your posts...</div>';
            
            db.ref('posts').orderByChild('userId').equalTo(currentUser.uid).on('value', (snapshot) => {
                profilePostsContainer.innerHTML = '';
                
                if (!snapshot.exists()) {
                    profilePostsContainer.innerHTML = `
                        <div class="no-contacts">
                            <i class="fas fa-newspaper" style="font-size: 48px; color: var(--text-secondary); margin-bottom: 10px;"></i>
                            <p>You haven't posted anything yet.</p>
                        </div>
                    `;
                    return;
                }
                
                const posts = [];
                snapshot.forEach((child) => {
                    posts.push(child.val());
                });
                
                // Sort by timestamp (newest first)
                posts.sort((a, b) => b.timestamp - a.timestamp);
                
                // Update post count
                document.getElementById('profilePosts').textContent = posts.length;
                
                posts.forEach(async post => {
                    const postElement = await createPostElement(post);
                    profilePostsContainer.appendChild(postElement);
                });
            });
        }

        async function createPostElement(post) {
            const postElement = document.createElement('div');
            postElement.className = 'post-card';
            postElement.style.position = 'relative';
            
            const time = new Date(post.timestamp).toLocaleString();
            
            const fontStyle = post.fontSize === 'large' ? 'font-size: 20px;' : '';
            
            let mediaHTML = '';
            if (post.mediaURL) {
                if (post.mediaType === 'image') {
                    mediaHTML = `<img src="${post.mediaURL}" style="max-width:100%; border-radius:var(--radius); margin-top:15px; box-shadow: var(--shadow);">`;
                } else {
                    mediaHTML = `<video src="${post.mediaURL}" controls style="max-width:100%; border-radius:var(--radius); margin-top:15px; box-shadow: var(--shadow);"></video>`;
                }
            }
            
            // Fetch like status before rendering
            let userLiked = false;
            await new Promise(resolve => {
                db.ref(`postLikes/${currentUser.uid}/${post.id}`).once('value').then(snap => {
                    userLiked = snap.exists();
                    resolve();
                });
            });
            
            postElement.innerHTML = `
                <div class="post-header">
                    <div class="avatar-container">
                        <div class="post-avatar">${post.avatar}</div>
                    </div>
                    <div class="post-user-info">
                        <div class="post-username">${post.fullName}</div>
                        <div class="post-time">${time}</div>
                    </div>
                </div>
                <div class="post-content" style="${fontStyle}">
                    <p>${post.content}</p>
                    ${mediaHTML}
                </div>
                <div class="post-actions">
                    <div class="post-action ${userLiked ? 'active' : ''}" onclick="toggleLikePost('${post.id}')">
                        <i class="fas fa-heart"></i>
                        <span>${post.likes || 0}</span>
                    </div>
                    <div class="post-action" onclick="toggleComments('${post.id}')">
                        <i class="fas fa-comment"></i>
                        <span>${post.comments || 0}</span>
                    </div>
                    <div class="post-action" onclick="showShareMenu('${post.id}')">
                        <i class="fas fa-share"></i>
                        <span>${post.shares || 0}</span>
                    </div>
                    ${post.userId === currentUser.uid ? `
                    <div class="post-action" onclick="deletePost('${post.id}')" style="margin-left: auto; color: var(--danger);">
                        <i class="fas fa-trash"></i>
                        <span>Delete</span>
                    </div>
                    ` : ''}
                </div>
                <div class="comments-section" id="comments-section-${post.id}" style="display: none;">
                    <div class="comment-input-container">
                        <input type="text" class="comment-input" placeholder="Write a comment..." id="comment-input-${post.id}">
                        <button class="add-comment-btn" onclick="addComment('${post.id}')">Comment</button>
                    </div>
                    <div id="comments-${post.id}"></div>
                </div>
            `;
            
            // Load comments
            loadComments(post.id);
            
            return postElement;
        }

        function toggleComments(postId) {
            const section = document.getElementById(`comments-section-${postId}`);
            if (section.style.display === 'none' || section.style.display === '') {
                section.style.display = 'block';
                loadComments(postId); // Ensure comments are loaded
            } else {
                section.style.display = 'none';
            }
        }

        function showShareMenu(postId) {
            currentPostId = postId;
            const menu = document.getElementById('shareMenu');
            menu.style.display = 'block';
            setTimeout(() => menu.classList.add('show'), 10);
        }

        function closeShareMenu() {
            const menu = document.getElementById('shareMenu');
            menu.classList.remove('show');
            setTimeout(() => {
                menu.style.display = 'none';
                currentPostId = null;
            }, 300);
        }

        function copyPostLink(postId) {
            const currentUrl = window.location.href;
            const postLink = `${currentUrl}#post-${postId}`;
            navigator.clipboard.writeText(postLink).then(() => {
                alert('Post link copied to clipboard!');
                closeShareMenu();
            }).catch(() => {
                prompt('Copy this link:', postLink);
                closeShareMenu();
            });
        }

        function savePost(postId) {
            db.ref(`savedPosts/${currentUser.uid}/${postId}`).set(true).then(() => {
                alert('Post saved to your collection!');
                closeShareMenu();
            });
        }

        function shareToWhatsApp(postId) {
            db.ref(`posts/${postId}`).once('value').then(snap => {
                const post = snap.val();
                const message = `Check out this post: "${post.content}" by ${post.fullName}`;
                openWhatsApp(currentUser.phone, message);
                closeShareMenu();
            });
        }

        function toggleLikePost(postId) {
            db.ref(`postLikes/${currentUser.uid}/${postId}`).once('value').then((snap) => {
                const likeSection = document.querySelector(`#comments-section-${postId} .post-action:first-child`) || document.querySelector(`.post-card:has(#comments-section-${postId}) .post-action:first-child`);
                if (snap.exists()) {
                    db.ref(`postLikes/${currentUser.uid}/${postId}`).remove();
                    db.ref(`posts/${postId}/likes`).transaction(likes => (likes || 0) - 1);
                    if (likeSection) likeSection.classList.remove('active');
                } else {
                    db.ref(`postLikes/${currentUser.uid}/${postId}`).set(true);
                    db.ref(`posts/${postId}/likes`).transaction(likes => (likes || 0) + 1);
                    if (likeSection) likeSection.classList.add('active');
                }
            });
        }

        function addComment(postId) {
            const input = document.getElementById(`comment-input-${postId}`);
            const content = input.value.trim();
            if (!content) return;
            
            const commentId = db.ref(`comments/${postId}`).push().key;
            db.ref(`comments/${postId}/${commentId}`).set({
                id: commentId,
                postId,
                userId: currentUser.uid,
                username: currentUser.username,
                fullName: currentUser.fullName,
                avatar: currentUser.avatar,
                content,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                likes: 0,
                replies: 0
            }).then(() => {
                db.ref(`posts/${postId}/comments`).transaction(comments => (comments || 0) + 1);
                input.value = '';
                // Update comment count in post actions
                const commentCountSpan = document.querySelector(`.post-action[onclick="toggleComments('${postId}')"] span`);
                if (commentCountSpan) {
                    const currentCount = parseInt(commentCountSpan.textContent) || 0;
                    commentCountSpan.textContent = currentCount + 1;
                }
            });
        }

        function loadComments(postId) {
            const container = document.getElementById(`comments-${postId}`);
            if (!container) return;
            
            db.ref(`comments/${postId}`).orderByChild('timestamp').limitToLast(50).on('value', (snap) => {
                container.innerHTML = '';
                let commentCount = 0;
                snap.forEach((child) => {
                    const comment = child.val();
                    const commentEl = createCommentElement(comment, postId, child.key);
                    container.appendChild(commentEl);
                    commentCount++;
                });
                // Update comment count if visible
                const commentCountSpan = document.querySelector(`.post-action[onclick="toggleComments('${postId}')"] span`);
                if (commentCountSpan) commentCountSpan.textContent = commentCount;
            });
        }

        function createCommentElement(comment, postId, commentId) {
            const commentEl = document.createElement('div');
            commentEl.className = 'comment-item';
            const time = new Date(comment.timestamp).toLocaleString();
            
            commentEl.innerHTML = `
                <div class="comment-header">
                    <div class="comment-avatar">${comment.avatar}</div>
                    <div class="comment-author">${comment.fullName}</div>
                    <div class="comment-time">${time}</div>
                </div>
                <div class="comment-content">${comment.content}</div>
                <div class="comment-actions">
                    <span class="comment-action" onclick="toggleLikeComment('${postId}', '${commentId}')">
                        <i class="fas fa-heart"></i> ${comment.likes || 0}
                    </span>
                    <span class="comment-action" onclick="toggleReply('${postId}', '${commentId}')">
                        <i class="fas fa-reply"></i> Reply (${comment.replies || 0})
                    </span>
                    ${comment.userId === currentUser.uid ? `
                    <span class="comment-action" style="margin-left: auto; color: var(--danger);" onclick="deleteComment('${postId}', '${commentId}')">
                        <i class="fas fa-trash"></i> Delete
                    </span>
                    ` : ''}
                </div>
                <div class="replies-container" id="replies-${commentId}"></div>
                <div class="reply-input-container" id="reply-input-${commentId}" style="display: none; margin-top: 10px;">
                    <input type="text" class="reply-input" placeholder="Write a reply..." id="reply-input-text-${commentId}">
                    <button class="reply-btn" onclick="addReply('${postId}', '${commentId}')">Reply</button>
                </div>
            `;
            
            // Load replies
            loadReplies(postId, commentId);
            
            return commentEl;
        }

        function toggleLikeComment(postId, commentId) {
            db.ref(`commentLikes/${currentUser.uid}/${postId}/${commentId}`).once('value').then((snap) => {
                const likeSpan = document.querySelector(`#reply-input-${commentId} ~ .comment-actions .comment-action:first-child`) || document.querySelector(`.comment-item:has(#reply-input-${commentId}) .comment-action:first-child`);
                if (snap.exists()) {
                    db.ref(`commentLikes/${currentUser.uid}/${postId}/${commentId}`).remove();
                    db.ref(`comments/${postId}/${commentId}/likes`).transaction(likes => (likes || 0) - 1);
                    if (likeSpan) likeSpan.classList.remove('active');
                } else {
                    db.ref(`commentLikes/${currentUser.uid}/${postId}/${commentId}`).set(true);
                    db.ref(`comments/${postId}/${commentId}/likes`).transaction(likes => (likes || 0) + 1);
                    if (likeSpan) likeSpan.classList.add('active');
                }
            });
        }

        function toggleReply(postId, commentId) {
            const container = document.getElementById(`reply-input-${commentId}`);
            container.style.display = container.style.display === 'none' ? 'flex' : 'none';
        }

        function addReply(postId, commentId) {
            const input = document.getElementById(`reply-input-text-${commentId}`);
            const content = input.value.trim();
            if (!content) return;
            
            const replyId = db.ref(`replies/${postId}/${commentId}`).push().key;
            db.ref(`replies/${postId}/${commentId}/${replyId}`).set({
                id: replyId,
                postId,
                commentId,
                userId: currentUser.uid,
                username: currentUser.username,
                fullName: currentUser.fullName,
                avatar: currentUser.avatar,
                content,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                db.ref(`comments/${postId}/${commentId}/replies`).transaction(replies => (replies || 0) + 1);
                input.value = '';
                document.getElementById(`reply-input-${commentId}`).style.display = 'none';
                // Update reply count
                const replyCountSpan = document.querySelector(`.comment-action[onclick="toggleReply('${postId}', '${commentId}')"]`);
                if (replyCountSpan) {
                    const currentCount = parseInt(replyCountSpan.textContent.match(/\((\d+)\)/)?.[1] || 0) + 1;
                    replyCountSpan.innerHTML = `<i class="fas fa-reply"></i> Reply (${currentCount})`;
                }
            });
        }

        function loadReplies(postId, commentId) {
            const container = document.getElementById(`replies-${commentId}`);
            if (!container) return;
            
            db.ref(`replies/${postId}/${commentId}`).orderByChild('timestamp').on('value', (snap) => {
                container.innerHTML = '';
                snap.forEach((child) => {
                    const reply = child.val();
                    const replyEl = document.createElement('div');
                    replyEl.className = 'reply-item';
                    const time = new Date(reply.timestamp).toLocaleString();
                    replyEl.innerHTML = `
                        <strong>${reply.fullName}</strong> <small style="color: var(--text-secondary);">${time}</small><br>
                        ${reply.content}
                        ${reply.userId === currentUser.uid ? ` <button onclick="deleteReply('${postId}', '${commentId}', '${child.key}')" style="background: none; border: none; color: var(--danger); cursor: pointer; font-size: 12px; float: right;"><i class="fas fa-trash"></i></button>` : ''}
                    `;
                    container.appendChild(replyEl);
                });
            });
        }

        function deleteComment(postId, commentId) {
            if (confirm('Are you sure you want to delete this comment?')) {
                db.ref(`comments/${postId}/${commentId}`).remove().then(() => {
                    db.ref(`posts/${postId}/comments`).transaction(comments => (comments || 0) - 1);
                });
            }
        }

        function deleteReply(postId, commentId, replyId) {
            if (confirm('Are you sure you want to delete this reply?')) {
                db.ref(`replies/${postId}/${commentId}/${replyId}`).remove().then(() => {
                    db.ref(`comments/${postId}/${commentId}/replies`).transaction(replies => (replies || 0) - 1);
                });
            }
        }

        function sharePost(postId) {
            db.ref(`posts/${postId}`).once('value').then(snap => {
                const post = snap.val();
                const shareContent = `Check out this post: "${post.content}" shared by ${post.fullName}`;
                const shareId = db.ref('posts').push().key;
                db.ref(`posts/${shareId}`).set({
                    id: shareId,
                    userId: currentUser.uid,
                    username: currentUser.username,
                    fullName: currentUser.fullName,
                    avatar: currentUser.avatar,
                    content: shareContent,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    likes: 0,
                    comments: 0,
                    shares: 1,
                    originalPostId: postId
                }).then(() => {
                    db.ref(`posts/${postId}/shares`).transaction(shares => (shares || 0) + 1);
                    alert('Post shared successfully!');
                });
            });
        }

        function deletePost(postId) {
            if (confirm('Are you sure you want to delete this post?')) {
                db.ref('posts/' + postId).remove()
                    .then(() => {
                        alert('Post deleted successfully!');
                    })
                    .catch((error) => {
                        alert('Error deleting post: ' + error.message);
                    });
            }
        }

        // Friends Management
        function loadFriends() {
            const friendsList = document.getElementById('friendsList');
            friendsList.innerHTML = '<div class="loading">Loading friends...</div>';
            
            db.ref(`friends/${currentUser.uid}`).on('value', (snap) => {
                friendsList.innerHTML = '';
                
                if (!snap.exists()) {
                    friendsList.innerHTML = `
                        <div class="no-contacts">
                            <i class="fas fa-user-friends" style="font-size: 48px; color: var(--text-secondary); margin-bottom: 10px;"></i>
                            <p>You don't have any friends yet. Search for people to connect with!</p>
                        </div>
                    `;
                    document.getElementById('profileFriends').textContent = 0;
                    return;
                }
                
                let friendCount = 0;
                snap.forEach((child) => {
                    const friendUid = child.key;
                    const user = users[friendUid];
                    if (user) {
                        const friendElement = createFriendElement(user, friendUid);
                        friendsList.appendChild(friendElement);
                        friendCount++;
                    }
                });
                document.getElementById('profileFriends').textContent = friendCount;
            });
        }

        function createFriendElement(user, uid) {
            const friendCard = document.createElement('div');
            friendCard.className = 'friend-card shadow-hover';
            friendCard.innerHTML = `
                <div class="friend-avatar">${user.avatar}</div>
                <div class="friend-name">${user.fullName}</div>
                <div class="friend-username">@${user.username}</div>
                <div class="friend-actions">
                    <button class="btn btn-sm btn-success" onclick="openChatWith('${uid}')">Message</button>
                    <button class="btn btn-sm btn-danger" onclick="unfriend('${uid}')">Unfriend</button>
                    <button class="btn btn-sm btn-warning" onclick="toggleBlock('${uid}')">Block/Unblock</button>
                </div>
            `;
            return friendCard;
        }

        function unfriend(uid) {
            if (confirm('Are you sure you want to unfriend this user?')) {
                db.ref(`friends/${currentUser.uid}/${uid}`).remove();
                db.ref(`friends/${uid}/${currentUser.uid}`).remove();
            }
        }

        function loadFriendRequests() {
            const friendRequestsList = document.getElementById('friendRequestsList');
            friendRequestsList.innerHTML = '<div class="loading">Loading friend requests...</div>';
            
            db.ref(`friendRequests/${currentUser.uid}`).on('value', (snap) => {
                friendRequestsList.innerHTML = '';
                
                if (!snap.exists()) {
                    friendRequestsList.innerHTML = `
                        <div class="no-contacts">
                            <p>No pending friend requests.</p>
                        </div>
                    `;
                    return;
                }
                
                snap.forEach((child) => {
                    const senderUid = child.key;
                    const request = child.val();
                    if (request.status === 'pending') {
                        const user = users[senderUid];
                        if (user) {
                            const requestElement = document.createElement('div');
                            requestElement.className = 'friend-card shadow-hover';
                            requestElement.innerHTML = `
                                <div class="friend-avatar">${user.avatar}</div>
                                <div class="friend-name">${user.fullName}</div>
                                <div class="friend-username">@${user.username}</div>
                                <div class="friend-actions">
                                    <button class="btn btn-sm btn-success" onclick="acceptFriend('${senderUid}')">Accept</button>
                                    <button class="btn btn-sm btn-danger" onclick="declineFriend('${senderUid}')">Decline</button>
                                </div>
                            `;
                            friendRequestsList.appendChild(requestElement);
                        }
                    }
                });
            });
        }

        function acceptFriend(senderUid) {
            db.ref(`friendRequests/${currentUser.uid}/${senderUid}`).update({status: 'accepted'});
            db.ref(`friends/${currentUser.uid}/${senderUid}`).set(true);
            db.ref(`friends/${senderUid}/${currentUser.uid}`).set(true);
            
            // Send notification to sender
            db.ref(`notifications/${senderUid}`).push({
                type: 'friend_accept',
                from: currentUser.uid,
                text: `${currentUser.fullName} accepted your friend request`,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                read: false
            });
        }

        function declineFriend(senderUid) {
            db.ref(`friendRequests/${currentUser.uid}/${senderUid}`).remove();
        }

        function handleFriendSearch() {
            const searchTerm = document.getElementById('friendSearch').value.trim().toLowerCase();
            const friendsList = document.getElementById('friendsList');
            friendsList.innerHTML = '<div class="loading">Searching...</div>';
            
            db.ref('users').orderByChild('usernameLower').startAt(searchTerm).endAt(searchTerm + '\uf8ff').once('value')
                .then((snap) => {
                    friendsList.innerHTML = '';
                    
                    if (!snap.exists()) {
                        friendsList.innerHTML = `
                            <div class="no-contacts">
                                <i class="fas fa-search" style="font-size: 48px; color: var(--text-secondary); margin-bottom: 10px;"></i>
                                <p>No users found matching "${searchTerm}".</p>
                            </div>
                        `;
                        return;
                    }
                    
                    snap.forEach((child) => {
                        const uid = child.key;
                        if (uid === currentUser.uid) return;
                        const user = child.val();
                        const friendCard = document.createElement('div');
                        friendCard.className = 'friend-card shadow-hover';
                        friendCard.innerHTML = `
                            <div class="friend-avatar">${user.avatar}</div>
                            <div class="friend-name">${user.fullName}</div>
                            <div class="friend-username">@${user.username}</div>
                            <div class="friend-actions">
                                <button class="btn btn-sm btn-primary" onclick="sendFriendRequest('${uid}')">Add Friend</button>
                            </div>
                        `;
                        friendsList.appendChild(friendCard);
                    });
                })
                .catch((error) => {
                    friendsList.innerHTML = '<div class="no-contacts">Error searching users.</div>';
                });
        }

        function sendFriendRequest(uid) {
            db.ref(`friendRequests/${uid}/${currentUser.uid}`).set({
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                status: 'pending'
            });
            
            // Send notification to receiver
            db.ref(`notifications/${uid}`).push({
                type: 'friend_request',
                from: currentUser.uid,
                text: `${currentUser.fullName} sent you a friend request`,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                read: false
            });
            
            alert('Friend request sent!');
        }

        function handleGlobalSearch() {
            const searchTerm = document.getElementById('globalSearch').value.trim().toLowerCase();
            const searchResults = document.getElementById('searchResults');
            searchResults.innerHTML = '<div class="loading">Searching...</div>';
            
            // Search users by username or fullName, and posts by content
            const userQuery = db.ref('users').orderByChild('usernameLower').startAt(searchTerm).endAt(searchTerm + '\uf8ff');
            const postQuery = db.ref('posts').orderByChild('content').startAt(searchTerm).endAt(searchTerm + '\uf8ff'); // Note: contentLower not set, use content for simplicity
            
            Promise.all([userQuery.once('value'), postQuery.once('value')]).then(([userSnap, postSnap]) => {
                searchResults.innerHTML = '';
                let hasResults = false;
                
                // Users
                if (userSnap.exists()) {
                    hasResults = true;
                    const usersSection = document.createElement('div');
                    usersSection.innerHTML = '<h3 style="color: var(--secondary); margin-bottom: 20px; font-weight: 600;">People</h3>';
                    userSnap.forEach((child) => {
                        const uid = child.key;
                        if (uid === currentUser.uid) return;
                        const user = child.val();
                        const resultCard = document.createElement('div');
                        resultCard.className = 'friend-card shadow-hover';
                        resultCard.innerHTML = `
                            <div class="friend-avatar">${user.avatar}</div>
                            <div class="friend-name">${user.fullName}</div>
                            <div class="friend-username">@${user.username}</div>
                            <div class="friend-actions">
                                <button class="btn btn-sm btn-primary" onclick="sendFriendRequest('${uid}')">Add Friend</button>
                            </div>
                        `;
                        usersSection.appendChild(resultCard);
                    });
                    searchResults.appendChild(usersSection);
                }
                
                // Posts
                if (postSnap.exists()) {
                    hasResults = true;
                    const postsSection = document.createElement('div');
                    postsSection.innerHTML = '<h3 style="color: var(--secondary); margin-bottom: 20px; font-weight: 600;">Posts</h3>';
                    postSnap.forEach(async (child) => {
                        const post = child.val();
                        const postEl = await createPostElement(post);
                        postEl.style.marginBottom = '0';
                        postsSection.appendChild(postEl);
                    });
                    searchResults.appendChild(postsSection);
                }
                
                if (!hasResults) {
                    searchResults.innerHTML = `
                        <div class="no-contacts">
                            <i class="fas fa-search" style="font-size: 48px; color: var(--text-secondary); margin-bottom: 10px;"></i>
                            <p>No results found for "${searchTerm}".</p>
                        </div>
                    `;
                }
            }).catch((error) => {
                searchResults.innerHTML = '<div class="no-contacts">Error searching.</div>';
            });
        }

        // Stories Management
        function loadStories() {
            const storiesFeed = document.getElementById('storiesFeed');
            const storiesList = document.getElementById('storiesList');
            
            // Clear existing stories except "Your Story"
            while (storiesFeed.children.length > 1) storiesFeed.removeChild(storiesFeed.lastChild);
            while (storiesList.children.length > 1) storiesList.removeChild(storiesList.lastChild);
            
            db.ref(`friends/${currentUser.uid}`).once('value').then((friendsSnap) => {
                const friends = friendsSnap.val() ? Object.keys(friendsSnap.val()) : [];
                friends.push(currentUser.uid); // Include own stories
                
                db.ref('stories').orderByChild('timestamp').on('value', (snap) => {
                    const storiesMap = {};
                    
                    snap.forEach((child) => {
                        const story = child.val();
                        if (friends.includes(story.userId) && story.expiresAt > Date.now()) {
                            if (!storiesMap[story.userId] || story.timestamp > storiesMap[story.userId].timestamp) {
                                storiesMap[story.userId] = story;
                            }
                        } else if (story.expiresAt <= Date.now()) {
                            db.ref('stories/' + child.key).remove(); // Clean up expired stories
                        }
                    });
                    
                    Object.values(storiesMap).sort((a, b) => b.timestamp - a.timestamp).forEach((story) => {
                        const storyElement = document.createElement('div');
                        storyElement.className = 'story-item';
                        storyElement.innerHTML = `
                            <div class="story-avatar">${story.avatar}</div>
                            <div class="story-username">${story.username}</div>
                        `;
                        storyElement.addEventListener('click', () => openStoryModal(story));
                        storiesFeed.appendChild(storyElement);
                        storiesList.appendChild(storyElement.cloneNode(true));
                    });
                });
            });
        }

        function handleCreateStory(e) {
            e.preventDefault();
            
            const text = document.getElementById('storyText').value;
            
            if (!text) {
                alert('Please add text to your story');
                return;
            }
            
            const now = Date.now();
            const storyId = db.ref('stories').push().key;
            const newStory = {
                id: storyId,
                userId: currentUser.uid,
                username: currentUser.username,
                avatar: currentUser.avatar,
                text: text,
                timestamp: now,
                expiresAt: now + (24 * 60 * 60 * 1000), // 24 hours
                replies: 0
            };
            
            db.ref('stories/' + storyId).set(newStory)
                .then(() => {
                    document.getElementById('storyForm').reset();
                    alert('Story added successfully!');
                    loadStories(); // Reload to show immediately
                })
                .catch((error) => {
                    alert('Error creating story: ' + error.message);
                });
        }

        // Story Modal Functions
        function openStoryModal(story) {
            currentStoryId = story.id;
            document.getElementById('storyUsername').textContent = story.username + "'s Story";
            document.getElementById('storyContent').innerHTML = `<p>${story.text}</p>`;
            document.getElementById('storyModal').style.display = 'flex';
            setTimeout(() => document.querySelector('#storyModal .modal-content').classList.add('show'), 10);
            loadStoryReplies(story.id);
        }

        function closeStoryModal() {
            document.querySelector('#storyModal .modal-content').classList.remove('show');
            setTimeout(() => {
                document.getElementById('storyModal').style.display = 'none';
                currentStoryId = null;
            }, 400);
        }

        function addStoryReply() {
            const input = document.getElementById('storyReplyInput');
            const content = input.value.trim();
            if (!content) return;
            
            const replyId = db.ref(`storyReplies/${currentStoryId}`).push().key;
            db.ref(`storyReplies/${currentStoryId}/${replyId}`).set({
                id: replyId,
                storyId: currentStoryId,
                userId: currentUser.uid,
                username: currentUser.username,
                fullName: currentUser.fullName,
                avatar: currentUser.avatar,
                content,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                db.ref(`stories/${currentStoryId}/replies`).transaction(replies => (replies || 0) + 1);
                input.value = '';
            });
        }

        function loadStoryReplies(storyId) {
            const container = document.getElementById('storyReplies');
            db.ref(`storyReplies/${storyId}`).orderByChild('timestamp').limitToLast(20).on('value', (snap) => {
                container.innerHTML = '';
                snap.forEach((child) => {
                    const reply = child.val();
                    const replyEl = createReplyElement(reply);
                    container.appendChild(replyEl);
                });
            });
        }

        function createReplyElement(reply) {
            const el = document.createElement('div');
            el.className = 'comment-item';
            const time = new Date(reply.timestamp).toLocaleString();
            el.innerHTML = `
                <div class="comment-header">
                    <div class="comment-avatar">${reply.avatar}</div>
                    <div class="comment-author">${reply.fullName}</div>
                    <div class="comment-time">${time}</div>
                </div>
                <div class="comment-content">${reply.content}</div>
            `;
            return el;
        }

        // Notifications Management
        function loadNotifications() {
            const notificationsList = document.getElementById('notificationsList');
            notificationsList.innerHTML = '<div class="loading">Loading notifications...</div>';
            
            db.ref(`notifications/${currentUser.uid}`).orderByChild('timestamp').limitToLast(20).on('value', (snap) => {
                notificationsList.innerHTML = '';
                
                const notifs = [];
                snap.forEach((child) => {
                    const notif = child.val();
                    notif.id = child.key;
                    notifs.push(notif);
                });
                
                notifs.sort((a, b) => b.timestamp - a.timestamp);
                
                notifs.forEach((notif) => {
                    const fromUser = users[notif.from];
                    if (!fromUser) return;
                    
                    const notifElement = document.createElement('div');
                    notifElement.className = 'notification-item shadow-hover';
                    notifElement.innerHTML = `
                        <div class="notification-avatar">${fromUser.avatar}</div>
                        <div class="notification-content">
                            <div class="notification-text">${notif.text}</div>
                            <div class="notification-time">${new Date(notif.timestamp).toLocaleString()}</div>
                        </div>
                        <div class="notification-actions">
                            ${notif.type === 'friend_request' ? `
                                <button class="btn btn-success btn-sm" onclick="acceptFriend('${notif.from}')">Accept</button>
                                <button class="btn btn-danger btn-sm" onclick="declineFriend('${notif.from}')">Decline</button>
                            ` : ''}
                        </div>
                    `;
                    notificationsList.appendChild(notifElement);
                });
                
                if (notifs.length === 0) {
                    notificationsList.innerHTML = `
                        <div class="no-contacts">
                            <i class="fas fa-bell" style="font-size: 48px; color: var(--text-secondary); margin-bottom: 10px;"></i>
                            <p>No notifications yet.</p>
                        </div>
                    `;
                }
            });
        }

        // Messaging functions
        function loadMessagesContacts() {
            const contactsList = document.getElementById('contactsList');
            contactsList.innerHTML = '<div class="loading">Loading contacts...</div>';
            
            db.ref(`friends/${currentUser.uid}`).on('value', (snap) => {
                contactsList.innerHTML = '';
                
                if (!snap.exists()) {
                    contactsList.innerHTML = `
                        <div class="no-contacts">
                            <i class="fas fa-user-friends" style="font-size: 48px; color: var(--text-secondary); margin-bottom: 10px;"></i>
                            <p>You don't have any friends yet. Add friends to chat!</p>
                        </div>
                    `;
                    return;
                }
                
                snap.forEach((child) => {
                    const uid = child.key;
                    const user = users[uid];
                    if (user) {
                        const contactElement = document.createElement('div');
                        contactElement.className = 'contact-item';
                        contactElement.dataset.uid = uid;
                        contactElement.innerHTML = `
                            <div class="avatar-container">
                                <div class="contact-avatar">${user.avatar}</div>
                                ${isOnline(user.lastSeen) ? '<div class="online-indicator"></div>' : ''}
                            </div>
                            <div class="contact-info">
                                <div class="contact-name">${user.fullName}</div>
                                <div class="contact-last-msg">Start chatting!</div>
                            </div>
                        `;
                        
                        contactElement.addEventListener('click', () => {
                            selectChat({uid, ...user});
                            document.querySelectorAll('.contact-item').forEach(i => i.classList.remove('active'));
                            contactElement.classList.add('active');
                        });
                        
                        setupLongPress(contactElement, () => deleteChat(uid));
                        
                        contactsList.appendChild(contactElement);
                    }
                });
            });
        }

        function setupLongPress(element, callback) {
            let pressTimer;
            element.addEventListener('touchstart', () => {
                pressTimer = setTimeout(callback, 800);
            });
            element.addEventListener('touchend', () => clearTimeout(pressTimer));
            element.addEventListener('touchmove', () => clearTimeout(pressTimer));
            element.addEventListener('mousedown', () => {
                pressTimer = setTimeout(callback, 800);
            });
            element.addEventListener('mouseup', () => clearTimeout(pressTimer));
            element.addEventListener('mouseleave', () => clearTimeout(pressTimer));
        }

        function selectChat(contact) {
            currentChatUser = contact;
            
            const chatWindow = document.getElementById('chatWindow');
            chatWindow.innerHTML = `
                <div class="chat-header">
                    <div class="avatar-container">
                        <div class="contact-avatar">${contact.avatar}</div>
                        ${isOnline(contact.lastSeen) ? '<div class="online-indicator"></div>' : ''}
                    </div>
                    <div class="chat-header-info">
                        <h4>${contact.fullName}</h4>
                        <p>Last seen: ${new Date(contact.lastSeen).toLocaleString()}</p>
                    </div>
                    <button class="btn btn-sm btn-warning" onclick="toggleBlock('${contact.uid}')">Block/Unblock</button>
                </div>
                <div class="chat-messages" id="chatMessages">
                    <div class="loading">Loading messages...</div>
                </div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" placeholder="Type a message..." id="chatInput">
                    <button class="send-btn" id="sendBtn"><i class="fas fa-paper-plane"></i></button>
                </div>
            `;
            
            if (currentMessagesRef) {
                currentMessagesRef.off();
            }
            
            const chatId = getChatId(currentUser.uid, contact.uid);
            currentMessagesRef = db.ref(`messages/${chatId}`);
            
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            
            currentMessagesRef.orderByChild('timestamp').limitToLast(50).on('child_added', (child) => {
                const msg = child.val();
                const isSent = msg.sender === currentUser.uid;
                const time = new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
                
                let messageText = msg.text;
                
                const messageElement = document.createElement('div');
                messageElement.className = `message ${isSent ? 'sent' : 'received'}`;
                messageElement.innerHTML = `
                    <div class="message-bubble">${messageText}${isSent ? ` <button onclick="deleteMessage('${child.key}', '${chatId}')"><i class="fas fa-trash" style="font-size: 10px; color: #fff; margin-left: 5px;"></i></button>` : ''}</div>
                    <span class="message-time">${time}</span>
                `;
                
                if (isSent) {
                    setupLongPress(messageElement.querySelector('.message-bubble'), () => deleteMessage(child.key, chatId));
                }
                
                chatMessages.appendChild(messageElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });
            
            // Setup send listeners
            const sendBtn = document.getElementById('sendBtn');
            const chatInput = document.getElementById('chatInput');
            sendBtn.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            
            if (!text) return;
            
            currentMessagesRef.push({
              text: text,
              sender: currentUser.uid,
              timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            
            input.value = '';
        }

        function deleteMessage(messageId, chatId) {
            if (confirm('Are you sure you want to delete this message?')) {
                db.ref(`messages/${chatId}/${messageId}`).remove();
            }
        }

        function deleteChat(uid) {
            if (confirm('Are you sure you want to delete this entire chat?')) {
                const chatId = getChatId(currentUser.uid, uid);
                db.ref(`messages/${chatId}`).remove();
                if (currentChatUser && currentChatUser.uid === uid) {
                    document.getElementById('chatWindow').innerHTML = `
                        <div class="no-chat-selected">
                            <i class="fas fa-comment-dots" style="font-size: 48px; color: var(--text-secondary); margin-bottom: 10px;"></i>
                            <p>Select a friend to start chatting.</p>
                        </div>
                    `;
                    currentChatUser = null;
                    if (currentMessagesRef) currentMessagesRef.off();
                }
            }
        }

        function toggleBlock(uid) {
            db.ref(`blocked/${currentUser.uid}/${uid}`).once('value').then(snap => {
                const isBlocked = snap.val();
                db.ref(`blocked/${currentUser.uid}/${uid}`).set(!isBlocked);
                alert(isBlocked ? 'User unblocked!' : 'User blocked!');
            });
        }

        function openChatWith(uid) {
            const contact = {uid, ...users[uid]};
            showSection('messages');
            selectChat(contact);
        }

        function getChatId(uid1, uid2) {
            return uid1 < uid2 ? `${uid1}_${uid2}` : `${uid2}_${uid1}`;
        }

        function isOnline(lastSeen) {
            return Date.now() - lastSeen < 5 * 60 * 1000;
        }

        // EMS functions
        function validateUserSession() {
            if (!currentUser) {
                console.error("No user session found");
                handleLogout();
                return false;
            }
            return true;
        }

        function handleAddStudent(e) {
            e.preventDefault();
            if (!validateUserSession()) return;
            
            const name = document.getElementById('studentName').value;
            const grade = document.getElementById('studentGrade').value;
            const phone = document.getElementById('studentPhone').value;
            const fee = document.getElementById('studentFee').value;
            
            if (!phone.match(/^03\d{9}$/)) {
                alert('Please enter a valid Pakistani phone number (03XXXXXXXXX)');
                return;
            }
            
            const id = generateId();
            const newStudent = {
                name,
                grade: parseInt(grade),
                phone,
                fee: parseInt(fee),
                admissionDate: new Date().toISOString().split('T')[0],
                admissionBy: currentUser.username || currentUser.email
            };
            
            db.ref(`ems/${currentUser.uid}/students/${id}`).set(newStudent);
            
            const branding = currentUser.schoolName ? `${currentUser.schoolName}\nContact: ${currentUser.schoolPhone || currentUser.phone}\n` : '';
            const message = `Assalam-o-Alaikum! ${name} has been admitted to Grade ${grade}. Monthly fee: PKR ${fee}. \n${branding}Created by ${currentUser.fullName} (${currentUser.phone})`;
            openWhatsApp(phone, message);
            
            alert('Student added successfully! WhatsApp message ready to send.');
            document.getElementById('studentForm').reset();
        }

        function loadStudentsTable() {
            if (!validateUserSession()) return;
            
            const tbody = document.querySelector('#studentsTable tbody');
            tbody.innerHTML = '';

            const studentArray = Object.entries(students).map(([id, student]) => ({id, ...student}));

            const sortedStudents = studentArray.sort((a, b) => a.grade - b.grade || a.name.localeCompare(b.name));
            
            sortedStudents.forEach(student => {
                // Calculate fee status for this month
                const currentMonth = new Date().toISOString().slice(0, 7);
                const studentFees = Object.values(fees).filter(f => f.studentId === student.id && f.month === currentMonth);
                const totalPaid = studentFees.reduce((sum, fee) => sum + fee.amount, 0);
                const remaining = student.fee - totalPaid;
                
                let feeStatus = 'Pending';
                let statusClass = 'fee-pending';
                
                if (remaining <= 0) {
                    feeStatus = 'Paid';
                    statusClass = 'fee-paid';
                } else if (totalPaid > 0) {
                    feeStatus = `Partial (PKR ${remaining} due)`;
                    statusClass = 'fee-partial';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.id}</td>
                    <td>${student.name}</td>
                    <td>Grade ${student.grade}</td>
                    <td>${student.phone}</td>
                    <td><span class="currency">${student.fee}</span></td>
                    <td><span class="fee-status ${statusClass}">${feeStatus}</span></td>
                    <td class="action-buttons">
                        <button class="btn btn-danger btn-sm" onclick="deleteStudent('${student.id}')"><i class="fas fa-trash"></i> Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function deleteStudent(id) {
            if (!validateUserSession()) return;
            
            currentAction = 'deleteStudent';
            currentItemId = id;
            openPinModal();
        }

        function updateStudentDropdown() {
            if (!validateUserSession()) return;
            
            const dropdown = document.getElementById('feeStudent');
            dropdown.innerHTML = '<option value="">Select Student</option>';
            
            const studentArray = Object.entries(students).map(([id, student]) => ({id, ...student}));
            studentArray.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.name} (Grade ${student.grade}) - PKR ${student.fee}/month`;
                option.setAttribute('data-fee', student.fee);
                dropdown.appendChild(option);
            });
            updateFeeInfo();
        }

        function updateFeeInfo() {
            if (!validateUserSession()) return;
            
            const student = document.getElementById('feeStudent').value;
            const month = document.getElementById('feeMonth').value;
            
            const monthlyFeeDisplay = document.getElementById('monthlyFeeDisplay');
            const remainingFeeDisplay = document.getElementById('remainingFeeDisplay');
            const feeAmountInput = document.getElementById('feeAmount');
            
            if (!student || !month) {
                monthlyFeeDisplay.textContent = '0';
                remainingFeeDisplay.textContent = '0';
                feeAmountInput.max = null;
                feeAmountInput.value = '';
                return;
            }
            
            const studentData = students[student];
            if (!studentData) return;
            
            // Calculate already paid amount for this month
            const paidFees = Object.values(fees).filter(f => f.studentId === student && f.month === month);
            const totalPaid = paidFees.reduce((sum, f) => sum + f.amount, 0);
            const remaining = studentData.fee - totalPaid;
            
            // Update displays
            monthlyFeeDisplay.textContent = studentData.fee;
            remainingFeeDisplay.textContent = remaining < 0 ? 0 : remaining;
            
            // Set max value for fee amount input to the remaining fee
            feeAmountInput.max = remaining < 0 ? 0 : remaining;
            
            // Set default value for amount input (suggest full remaining amount)
            if (remaining > 0) {
                 feeAmountInput.value = remaining;
            } else {
                 feeAmountInput.value = 0;
            }
        }

        function handleFeeCollection(e) {
            e.preventDefault();
            if (!validateUserSession()) return;
            
            const studentId = document.getElementById('feeStudent').value;
            const month = document.getElementById('feeMonth').value;
            const amount = parseInt(document.getElementById('feeAmount').value);
            const datePaid = document.getElementById('feeDate').value;
            
            const student = students[studentId];
            if (!student) {
                alert('Please select a valid student');
                return;
            }
            
            // Recalculate remaining fee before processing
            const paidFees = Object.values(fees).filter(f => f.studentId === studentId && f.month === month);
            const totalPaid = paidFees.reduce((sum, fee) => sum + fee.amount, 0);
            const remaining = student.fee - totalPaid;
            
            if (amount > remaining) {
                alert(`Cannot collect more than the remaining fee amount (PKR ${remaining < 0 ? 0 : remaining})`);
                return;
            }
            
            if (amount <= 0) {
                alert('Please enter a valid amount greater than zero');
                return;
            }
            
            const id = generateId();
            const newFee = {
                studentId,
                studentName: student.name,
                month,
                amount: amount,
                datePaid,
                collectedBy: currentUser.username || currentUser.email
            };
            
            db.ref(`ems/${currentUser.uid}/fees/${id}`).set(newFee);
            
            // WhatsApp message content
            const totalPaidNow = totalPaid + amount;
            const remainingAfterPayment = student.fee - totalPaidNow;
            const status = remainingAfterPayment <= 0 ? 'Fully Paid' : `Partially Paid (PKR ${remainingAfterPayment} due)`;
            const branding = currentUser.schoolName ? `${currentUser.schoolName}\nContact: ${currentUser.schoolPhone || currentUser.phone}\n` : '';
            
            const message = `Fee Receipt - ${student.name}\n${branding}Month: ${month}\nAmount: PKR ${amount}\nStatus: ${status}\nDate: ${datePaid}\nThank you! - Created by ${currentUser.fullName} (${currentUser.phone})`;
            openWhatsApp(student.phone, message);
            
            alert('Fee collected successfully! WhatsApp receipt ready to send.');
            document.getElementById('feeForm').reset();
            document.getElementById('feeMonth').valueAsDate = new Date();
            document.getElementById('feeDate').value = new Date().toISOString().split('T')[0];
            updateFeeInfo();
        }

        function loadFeesTable() {
            if (!validateUserSession()) return;
            
            const tbody = document.querySelector('#feesTable tbody');
            tbody.innerHTML = '';
            
            const feeArray = Object.entries(fees).map(([id, fee]) => ({id, ...fee}));
            const sortedFees = feeArray.sort((a, b) => new Date(b.datePaid) - new Date(a.datePaid));
            
            sortedFees.forEach(fee => {
                const student = students[fee.studentId];
                if (!student) {
                    const rowDeleted = document.createElement('tr');
                    rowDeleted.innerHTML = `
                        <td>${fee.id}</td>
                        <td><span style="color:var(--danger); font-style:italic;">[DELETED] ${fee.studentName}</span></td>
                        <td>${fee.month}</td>
                        <td><span class="currency">${fee.amount}</span></td>
                        <td><span class="fee-status fee-pending">Archived</span></td>
                        <td>${fee.datePaid}</td>
                        <td class="action-buttons">
                            <button class="btn btn-danger btn-sm" onclick="deleteFee('${fee.id}')"><i class="fas fa-trash"></i> Delete</button>
                        </td>
                    `;
                    tbody.appendChild(rowDeleted);
                    return;
                }
                
                const totalMonthlyFee = student.fee;
                const paidFees = Object.values(fees).filter(f => f.studentId === fee.studentId && f.month === fee.month);
                const totalPaidForMonth = paidFees.reduce((sum, f) => sum + f.amount, 0);
                const remaining = totalMonthlyFee - totalPaidForMonth;
                
                let status = 'Partial';
                let statusClass = 'fee-partial';
                
                if (remaining <= 0) {
                    status = 'Paid';
                    statusClass = 'fee-paid';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${fee.id}</td>
                    <td>${fee.studentName}</td>
                    <td>${fee.month}</td>
                    <td><span class="currency">${fee.amount}</span></td>
                    <td><span class="fee-status ${statusClass}">${status}</span></td>
                    <td>${fee.datePaid}</td>
                    <td class="action-buttons">
                        <button class="btn btn-whatsapp btn-sm" onclick="resendReceipt('${fee.id}')"><i class="fab fa-whatsapp"></i> Resend</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteFee('${fee.id}')"><i class="fas fa-trash"></i> Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Update recent fees table on dashboard
            const recentFeesTbody = document.querySelector('#recentFeesTable tbody');
            recentFeesTbody.innerHTML = '';
            
            const recentFees = sortedFees.slice(0, 5);
            recentFees.forEach(fee => {
                const student = students[fee.studentId];
                if (!student) return;
                
                const paidFees = Object.values(fees).filter(f => f.studentId === fee.studentId && f.month === fee.month);
                const totalPaid = paidFees.reduce((sum, f) => sum + f.amount, 0);
                const remaining = student.fee - totalPaid;
                
                let status = remaining <= 0 ? 'Paid' : 'Partial';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${fee.studentName}</td>
                    <td><span class="currency">${fee.amount}</span></td>
                    <td><span class="fee-status ${status === 'Paid' ? 'fee-paid' : 'fee-partial'}">${status}</span></td>
                    <td>${fee.datePaid}</td>
                `;
                recentFeesTbody.appendChild(row);
            });
        }

        function resendReceipt(feeId) {
            if (!validateUserSession()) return;
            
            const fee = fees[feeId];
            const student = students[fee.studentId];
            
            if (!student) {
                alert("Student record not found. Cannot resend.");
                return;
            }

            const paidFees = Object.values(fees).filter(f => f.studentId === fee.studentId && f.month === fee.month);
            const totalPaid = paidFees.reduce((sum, f) => sum + f.amount, 0);
            const remaining = student.fee - totalPaid;
            const status = remaining <= 0 ? 'Fully Paid' : `Partially Paid (PKR ${remaining} due)`;
            const branding = currentUser.schoolName ? `${currentUser.schoolName}\nContact: ${currentUser.schoolPhone || currentUser.phone}\n` : '';
            
            const message = `Fee Receipt - ${student.name}\n${branding}Month: ${fee.month}\nAmount: PKR ${fee.amount}\nStatus: ${status}\nDate: ${fee.datePaid}\nThank you! - Created by ${currentUser.fullName} (${currentUser.phone})`;
            openWhatsApp(student.phone, message);
            
            alert('WhatsApp receipt ready to send!');
        }

        function deleteFee(id) {
            if (!validateUserSession()) return;
            
            currentAction = 'deleteFee';
            currentItemId = id;
            openPinModal();
        }

        // Attendance Management
        function toggleAttendance(studentId, isChecked) {
            if (!validateUserSession()) return;
            
            const student = students[studentId];
            if (!student) return;

            const date = document.getElementById('attendanceDate').value;
            const alertDiv = document.getElementById(`alert-status-${studentId}`);
            
            // Update the visual status
            if (isChecked) {
                alertDiv.innerHTML = '<span class="status-badge status-present">Present</span>';
            } else {
                alertDiv.innerHTML = '<span class="status-badge status-absent">Absent</span>';
                
                // Immediate WhatsApp Alert for Absent Student
                const branding = currentUser.schoolName ? `${currentUser.schoolName}\nContact: ${currentUser.schoolPhone || currentUser.phone}\n` : '';
                const message = `Attendance Alert: ${student.name} was marked absent on ${date}. Please contact the academy for more information. \n${branding}Created by ${currentUser.fullName} (${currentUser.phone})`;
                openWhatsApp(student.phone, message);
            }
        }

        function loadAttendanceForm() {
            if (!validateUserSession()) return;
            
            const container = document.getElementById('attendanceList');
            container.innerHTML = '';
            
            const studentArray = Object.entries(students).map(([id, student]) => ({id, ...student}));
            if (studentArray.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--text-secondary);">No students available. Please add students first.</p>';
                return;
            }
            
            const date = document.getElementById('attendanceDate').value;
            const existingRecord = attendance[date] || {present: [], absent: []};

            // Group students by grade
            const studentsByGrade = studentArray.reduce((acc, student) => {
                const grade = student.grade;
                if (!acc[grade]) acc[grade] = [];
                acc[grade].push(student);
                return acc;
            }, {});
            
            // Sort grades numerically
            const sortedGrades = Object.keys(studentsByGrade).sort((a, b) => parseInt(a) - parseInt(b));

            sortedGrades.forEach(grade => {
                const gradeContainer = document.createElement('div');
                gradeContainer.style.marginBottom = '25px';
                gradeContainer.innerHTML = `<h4 style="color: var(--secondary); border-bottom: 1px dashed rgba(255, 255, 255, 0.1); padding-bottom: 8px; margin-bottom: 20px; font-weight: 600;">Grade ${grade}</h4>`;
                
                // Sort students alphabetically within the grade
                studentsByGrade[grade].sort((a, b) => a.name.localeCompare(b.name));

                studentsByGrade[grade].forEach(student => {
                    // Determine initial status: checked if present in existing record, or default to present (true)
                    const isPresent = existingRecord.present.includes(student.id);
                    
                    const div = document.createElement('div');
                    div.style.display = 'flex';
                    div.style.alignItems = 'center';
                    div.style.marginBottom = '12px';
                    div.style.padding = '12px';
                    div.style.border = '1px solid rgba(255, 255, 255, 0.1)';
                    div.style.borderRadius = '8px';
                    div.style.backgroundColor = 'rgba(42, 42, 42, 0.5)';
                    div.setAttribute('data-student-id', student.id);
                    
                    const statusText = isPresent ? 'Present' : 'Absent';
                    const statusClass = isPresent ? 'status-present' : 'status-absent';

                    div.innerHTML = `
                        <input type="checkbox" id="attendance-${student.id}" class="attendance-checkbox" ${isPresent ? 'checked' : ''} style="display: none;">
                        <label style="margin: 0; flex-grow: 1; color: var(--text-primary); font-weight: 600;">${student.name}</label>
                        <div id="alert-status-${student.id}" style="margin-right: 15px;">
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        <div class="action-buttons" style="gap: 5px;">
                            <button type="button" class="btn btn-sm btn-success attendance-toggle-btn" data-id="${student.id}" data-action="present" title="Mark Present (✅)" style="padding: 8px; width: 35px; height: 35px;"><i class="fas fa-check"></i></button>
                            <button type="button" class="btn btn-sm btn-danger attendance-toggle-btn" data-id="${student.id}" data-action="absent" title="Mark Absent (❌)" style="padding: 8px; width: 35px; height: 35px;"><i class="fas fa-times"></i></button>
                        </div>
                    `;
                    
                    gradeContainer.appendChild(div);
                });
                
                container.appendChild(gradeContainer);
            });
            
            // Attach event listeners for the new toggle buttons
            document.querySelectorAll('.attendance-toggle-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const studentId = this.getAttribute('data-id');
                    const action = this.getAttribute('data-action');
                    const checkbox = document.getElementById(`attendance-${studentId}`);
                    
                    if (action === 'present') {
                        if (!checkbox.checked) {
                            checkbox.checked = true;
                            toggleAttendance(studentId, true); 
                        }
                    } else if (action === 'absent') {
                        if (checkbox.checked) {
                            checkbox.checked = false;
                            toggleAttendance(studentId, false); 
                        }
                    }
                });
            });
        }

        function handleAttendance(e) {
            e.preventDefault();
            if (!validateUserSession()) return;
            
            const date = document.getElementById('attendanceDate').value;
            
            const presentStudents = [];
            const absentStudents = [];
            
            const studentArray = Object.entries(students).map(([id, student]) => ({id, ...student}));
            studentArray.forEach(student => {
                // Read state from the hidden checkbox
                const checkbox = document.getElementById(`attendance-${student.id}`);
                if (checkbox && checkbox.checked) {
                    presentStudents.push(student.id);
                } else if (checkbox) {
                    absentStudents.push(student.id);
                }
            });
            
            if (studentArray.length === 0) {
                 alert('No students to mark attendance for.');
                 return;
            }

            const newAttendance = {
                present: presentStudents,
                absent: absentStudents,
                markedBy: currentUser.username || currentUser.email
            };
            
            db.ref(`ems/${currentUser.uid}/attendance/${date}`).set(newAttendance);
            
            alert('Attendance saved successfully! Absent student alerts were sent via WhatsApp upon marking.');
            
            // Reload form to reflect the changes
            loadAttendanceForm(); 
        }

        function resendAbsentAlerts(attendanceDate) {
            if (!validateUserSession()) return;
            
            const record = attendance[attendanceDate];
            
            if (!record) {
                alert("Attendance record not found.");
                return;
            }
            
            record.absent.forEach(studentId => {
                const student = students[studentId];
                if (student) {
                    const branding = currentUser.schoolName ? `${currentUser.schoolName}\nContact: ${currentUser.schoolPhone || currentUser.phone}\n` : '';
                    const message = `Attendance Alert: ${student.name} was absent on ${attendanceDate}. Please contact the academy for more info. \n${branding}Created by ${currentUser.fullName} (${currentUser.phone})`;
                    openWhatsApp(student.phone, message);
                }
            });
            
            alert('WhatsApp alerts ready to send for absent students!');
        }

        function deleteAttendance(date) {
            if (!validateUserSession()) return;
            
            currentAction = 'deleteAttendance';
            currentItemId = date;
            openPinModal();
        }
        
        function loadAttendanceTable() {
            if (!validateUserSession()) return;
            
            const tbody = document.querySelector('#attendanceTable tbody');
            tbody.innerHTML = '';
            
            const attendanceArray = Object.entries(attendance).map(([date, record]) => ({date, ...record}));
            const sortedAttendance = attendanceArray.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedAttendance.forEach(record => {
                const totalStudentsOnDate = Object.keys(students).length > 0 ? Object.keys(students).length : (record.present.length + record.absent.length);
                const percentage = totalStudentsOnDate > 0 ? Math.round((record.present.length / totalStudentsOnDate) * 100) : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.date}</td>
                    <td><span class="status-badge status-present">${record.present.length}</span></td>
                    <td><span class="status-badge status-absent">${record.absent.length}</span></td>
                    <td style="font-weight: 700; color: var(--${percentage >= 80 ? 'success' : percentage >= 50 ? 'warning' : 'danger'});">${percentage}%</td>
                    <td class="action-buttons">
                        <button class="btn btn-whatsapp btn-sm" onclick="resendAbsentAlerts('${record.date}')"><i class="fab fa-whatsapp"></i> Resend Alerts</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteAttendance('${record.date}')"><i class="fas fa-trash"></i> Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Update recent attendance table on dashboard
            const recentAttendanceTbody = document.querySelector('#recentAttendanceTable tbody');
            recentAttendanceTbody.innerHTML = '';
            
            const recentAttendance = sortedAttendance.slice(0, 5);
            recentAttendance.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.date}</td>
                    <td>${record.present.length}</td>
                    <td>${record.absent.length}</td>
                `;
                recentAttendanceTbody.appendChild(row);
            });
        }

        // WhatsApp Integration
        function openWhatsApp(phone, message) {
            let cleanPhone = phone.replace(/\D/g, '');
            if (cleanPhone.startsWith('03')) {
                cleanPhone = '92' + cleanPhone.substring(1);
            }
            
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/${cleanPhone}?text=${encodedMessage}`;
            
            window.open(whatsappUrl, '_blank');
        }

        // PIN Protected Actions
        function openPinModal() {
            if (!validateUserSession()) return;
            
            document.getElementById('pinModal').style.display = 'flex';
            setTimeout(() => document.querySelector('#pinModal .modal-content').classList.add('show'), 10);
            document.getElementById('pinInput').value = '';
            document.getElementById('pinInput').focus();
        }

        function closePinModal() {
            document.querySelector('#pinModal .modal-content').classList.remove('show');
            setTimeout(() => {
                document.getElementById('pinModal').style.display = 'none';
                currentAction = null;
                currentItemId = null;
            }, 400);
        }

        function verifyPin() {
            if (!validateUserSession()) return;
            
            const pin = document.getElementById('pinInput').value;
            
            if (!currentUser || !currentUser.pin) {
                alert('No admin PIN found. Login again.');
                closePinModal();
                return;
            }

            if (pin === currentUser.pin) {
                executeProtectedAction();
                closePinModal();
            } else {
                alert('Incorrect PIN. Please try again.');
                document.getElementById('pinInput').value = '';
                document.getElementById('pinInput').focus();
            }
        }

        function executeProtectedAction() {
            if (!currentItemId || !validateUserSession()) return;

            switch(currentAction) {
                case 'deleteStudent':
                    if (confirm('Are you sure you want to PERMANENTLY delete this student? Fee and attendance history will remain but be marked as archived.')) {
                        db.ref(`ems/${currentUser.uid}/students/${currentItemId}`).remove();
                        alert('Student deleted successfully');
                    }
                    break;
                case 'deleteFee':
                    if (confirm('Are you sure you want to PERMANENTLY delete this fee receipt?')) {
                        db.ref(`ems/${currentUser.uid}/fees/${currentItemId}`).remove();
                        alert('Fee record deleted successfully');
                    }
                    break;
                case 'deleteAttendance':
                    if (confirm('Are you sure you want to PERMANENTLY delete this attendance record?')) {
                        db.ref(`ems/${currentUser.uid}/attendance/${currentItemId}`).remove();
                        alert('Attendance record deleted successfully');
                    }
                    break;
                default:
                    alert('Action not defined for PIN protection.');
            }
        }

        // Utility functions
        function generateId() {
            return Math.random().toString(36).substr(2, 9).toUpperCase();
        }
    </script>
</body>
</html>