<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Popcorn - Complete Social Media Platform with EMS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        :root {
            --primary: #5e35b1;
            --primary-dark: #4527a0;
            --secondary: #00bcd4;
            --success: #66bb6a;
            --danger: #ef5350;
            --warning: #ffb300;
            --background: #121212;
            --surface: #1e1e1e;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --border: #333333;
            --sidebar-width: 280px;
            --header-height: 70px;
            --shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            --radius: 8px;
            --transition: all 0.3s ease-in-out;
        }

        body {
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .shadow-md {
            box-shadow: var(--shadow);
        }

        /* Auth Section */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-dark) 0%, #1a1a2e 100%);
            padding: 20px;
        }

        .auth-form {
            background: var(--surface);
            padding: 40px;
            border-radius: var(--radius);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6);
            width: 100%;
            max-width: 450px;
            border-top: 5px solid var(--primary);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-header h1 {
            color: var(--primary);
            font-size: 32px;
            margin-bottom: 10px;
        }

        .auth-header p {
            color: var(--text-secondary);
            font-size: 16px;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 25px;
            border-radius: 4px;
            overflow: hidden;
            background: var(--border);
        }

        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 14px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            color: var(--text-secondary);
        }

        .auth-tab.active {
            background: var(--primary);
            color: var(--text-primary);
            box-shadow: inset 0 -3px 0 var(--secondary);
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 16px;
            transition: var(--transition);
            background: #2b2b2b;
            color: var(--text-primary);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px var(--primary-dark);
        }

        .btn {
            display: inline-block;
            background: var(--primary);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: var(--transition);
            text-align: center;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .btn:hover {
            background: var(--primary-dark);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        }

        .btn-success {
            background: var(--success);
        }

        .btn-success:hover {
            background: #5cb860;
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-danger:hover {
            background: #e53935;
        }

        .btn-warning {
            background: var(--warning);
        }

        .btn-warning:hover {
            background: #fbc02d;
        }

        .btn-whatsapp {
            background: #25D366;
        }

        .btn-whatsapp:hover {
            background: #128C7E;
        }

        /* Main App */
        #appSection {
            display: none;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
            position: relative;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--surface);
            color: var(--text-primary);
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            z-index: 1000;
            box-shadow: var(--shadow);
            transform: translateX(-100%);
            overflow-y: auto;
        }
        
        .sidebar.open {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
            color: var(--secondary);
        }
        
        .logo-title {
            display: flex;
            align-items: center;
        }

        .sidebar-header h2 {
            font-size: 20px;
            margin-left: 10px;
            font-weight: 400;
        }
        
        .sidebar-close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            transition: color 0.3s;
        }
        
        .sidebar-close-btn:hover {
            color: var(--primary);
        }

        .sidebar-menu {
            list-style: none;
            padding: 10px 0;
        }

        .sidebar-menu li {
            padding: 14px 25px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            font-weight: 400;
            color: var(--text-secondary);
        }

        .sidebar-menu li i {
            margin-right: 15px;
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        .sidebar-menu li:hover {
            background: #2c2c2c;
            color: var(--text-primary);
        }

        .sidebar-menu li.active {
            background: var(--primary-dark);
            color: var(--text-primary);
            border-left: 4px solid var(--secondary);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 25px;
            margin-left: 0;
            transition: margin-left 0.3s ease;
        }
        
        .sidebar-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
            transition: opacity 0.3s;
        }
        
        .sidebar-backdrop.open {
            display: block;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 15px 25px;
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            position: sticky; 
            top: 0;
            z-index: 900;
        }
        
        .header-left-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .menu-toggle {
            font-size: 24px;
            cursor: pointer;
            background: var(--primary);
            color: var(--text-primary);
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .menu-toggle:hover {
            background: var(--primary-dark);
        }
        
        .three-dot-menu {
            font-size: 24px;
            cursor: pointer;
            color: var(--text-primary);
            padding: 5px;
            transition: color 0.3s;
            display: none;
        }
        
        #pageTitle {
            font-size: 16px;
            color: var(--secondary);
            font-weight: 500;
            margin: 0;
            flex-grow: 1;
            text-align: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--secondary);
            color: var(--surface);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }
        
        .user-info div:last-child {
            color: var(--text-secondary);
            display: flex;
            flex-direction: column; 
            gap: 5px;
        }
        
        /* Logout button specific styling on small screens */
        @media (max-width: 991px) {
            .user-info div:last-child > div {
                display: none;
            }
            #logoutBtn {
                margin: 0;
                padding: 5px 10px;
            }
            .user-info div:last-child {
                display: flex;
                flex-direction: column;
                justify-content: center;
            }
        }
        
        /* Content Sections */
        .content-section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            margin-bottom: 25px;
        }

        .section-header h2 {
            font-size: 24px;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .section-header p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Cards */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
            transition: transform 0.3s, box-shadow 0.3s;
            border-left: 5px solid var(--primary);
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.6);
        }

        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(94, 53, 177, 0.3);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            margin-bottom: 15px;
        }

        .card h3 {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 400;
        }

        .card-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .card-desc {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Forms */
        .form-container {
            background: var(--surface);
            padding: 25px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }
        
        .form-container h3 {
             color: var(--secondary);
             margin-bottom: 20px;
             border-bottom: 1px solid var(--border);
             padding-bottom: 10px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        /* Tables */
        .table-container {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }
        
        .table-container h3 {
             padding: 15px 20px;
             color: var(--text-primary);
             font-weight: 500;
             background-color: #2b2b2b;
        }

        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #2b2b2b;
            padding: 14px 20px;
            text-align: left;
            font-weight: 500;
            color: var(--secondary);
            border-bottom: 1px solid var(--border);
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
        }

        td {
            padding: 12px 20px;
            border-bottom: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 14px;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background: rgba(94, 53, 177, 0.1);
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-sm {
            padding: 8px 12px;
            font-size: 12px;
            border-radius: 3px;
            text-transform: none;
        }

        /* Messaging System Styles */
        .messaging-container {
            display: flex;
            height: calc(100vh - 150px);
            background: var(--surface);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .contacts-list {
            width: 300px;
            background: #2b2b2b;
            border-right: 1px solid var(--border);
            overflow-y: auto;
            padding: 0;
        }

        .contact-item {
            padding: 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .contact-item:hover,
        .contact-item.active {
            background: var(--primary);
            color: var(--text-primary);
        }

        .contact-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--secondary);
            color: var(--surface);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        .contact-info {
            flex: 1;
        }

        .contact-name {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .contact-last-msg {
            font-size: 12px;
            color: var(--text-secondary);
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            max-width: 180px;
        }

        .chat-window {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .chat-header {
            padding: 15px 20px;
            background: #2b2b2b;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-header .contact-avatar {
            margin: 0;
        }

        .chat-header-info h4 {
            font-size: 16px;
            margin-bottom: 2px;
        }

        .chat-header-info p {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: var(--surface);
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-end;
            gap: 10px;
            max-width: 70%;
            position: relative;
        }

        .message.sent {
            margin-left: auto;
            flex-direction: row-reverse;
        }

        .message-bubble {
            padding: 10px 15px;
            border-radius: var(--radius);
            max-width: 100%;
            word-wrap: break-word;
            position: relative;
        }

        .message.sent .message-bubble {
            background: var(--primary);
            color: var(--text-primary);
            border-bottom-right-radius: 4px;
        }

        .message.received .message-bubble {
            background: var(--secondary);
            color: var(--surface);
            border-bottom-left-radius: 4px;
        }

        .message-time {
            font-size: 10px;
            color: var(--text-secondary);
            margin-left: 5px;
        }

        .chat-input-container {
            padding: 15px 20px;
            background: #2b2b2b;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
            align-items: center;
            position: sticky;
            bottom: 0;
            z-index: 1;
        }

        .chat-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid var(--border);
            border-radius: 20px;
            background: var(--surface);
            color: var(--text-primary);
            font-size: 14px;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .send-btn:hover {
            background: var(--primary-dark);
        }

        .send-btn:disabled {
            background: var(--border);
            cursor: not-allowed;
        }

        .no-chat-selected {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-style: italic;
        }

        .no-contacts {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(8px);
        }

        .modal-content {
            background: var(--surface);
            padding: 30px;
            border-radius: var(--radius);
            width: 400px;
            max-width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            animation: modalFade 0.3s ease;
            border-top: 5px solid var(--secondary);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: var(--secondary);
            font-size: 22px;
        }

        .close-modal {
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: var(--transition);
        }

        .close-modal:hover {
            color: var(--text-primary);
        }

        /* Status Indicators */
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-present {
            background: rgba(102, 187, 106, 0.2);
            color: var(--success);
        }

        .status-absent {
            background: rgba(239, 83, 80, 0.2);
            color: var(--danger);
        }

        .status-pending {
            background: rgba(255, 179, 0, 0.2);
            color: var(--warning);
        }

        /* Fee Status */
        .fee-status {
            display: inline-block;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .fee-paid {
            background: rgba(102, 187, 106, 0.2);
            color: var(--success);
        }
        
        .fee-partial {
            background: rgba(255, 179, 0, 0.2);
            color: var(--warning);
        }
        
        .fee-pending {
            background: rgba(239, 83, 80, 0.2);
            color: var(--danger);
        }
        
        /* Currency Styling */
        .currency {
            font-weight: 700;
            color: var(--success);
        }

        .currency::before {
            content: "PKR ";
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        /* WhatsApp Notification */
        .whatsapp-notification {
            background: #25D366;
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .whatsapp-notification:hover {
            background: #128C7E;
        }
        
        /* Disclaimer Styling */
        .disclaimer-box {
            margin-top: 30px;
            padding: 15px;
            border: 1px solid var(--warning);
            border-radius: var(--radius);
            background-color: rgba(255, 179, 0, 0.1);
            color: var(--warning);
            font-size: 14px;
        }
        
        .disclaimer-box p {
            margin-bottom: 5px;
        }
        
        .disclaimer-box strong {
            color: var(--primary);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes modalFade {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        /* NEW SOCIAL MEDIA STYLES */
        
        /* Profile Section */
        .profile-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .profile-header {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: var(--secondary);
            color: var(--surface);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 48px;
            border: 5px solid var(--primary);
        }
        
        .profile-info {
            flex: 1;
        }
        
        .profile-name {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .profile-bio {
            color: var(--text-secondary);
            margin-bottom: 15px;
        }
        
        .profile-stats {
            display: flex;
            gap: 20px;
        }
        
        .profile-stat {
            text-align: center;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
        }
        
        .profile-actions {
            display: flex;
            gap: 10px;
        }
        
        /* Posts Section */
        .posts-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .post-card {
            background: #282c34;
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid #3b4048;
        }
        
        .post-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .post-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--secondary);
            color: var(--surface);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }
        
        .post-user-info {
            flex: 1;
        }
        
        .post-username {
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .post-time {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .post-content {
            margin-bottom: 15px;
            background: #1f232a;
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
            line-height: 1.5;
        }
        
        .post-actions {
            display: flex;
            gap: 15px;
            border-top: 1px solid var(--border);
            padding-top: 15px;
        }
        
        .post-action {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: var(--transition);
        }
        
        .post-action:hover {
            color: var(--primary);
        }
        
        .post-action.active {
            color: var(--primary);
        }

        /* Comments Section */
        .comments-section {
            margin-top: 15px;
            border-top: 1px solid var(--border);
            padding-top: 15px;
            display: none;
        }

        .comment-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .comment-input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 20px;
            background: var(--surface);
            color: var(--text-primary);
            font-size: 14px;
        }

        .comment-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .add-comment-btn {
            padding: 10px 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }

        .comment-item {
            background: #1f232a;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .comment-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        .comment-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--secondary);
            color: var(--surface);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .comment-author {
            font-weight: 600;
            font-size: 14px;
        }

        .comment-time {
            font-size: 11px;
            color: var(--text-secondary);
            margin-left: auto;
        }

        .comment-content {
            font-size: 14px;
            margin-bottom: 8px;
        }

        .comment-actions {
            display: flex;
            gap: 10px;
            font-size: 12px;
        }

        .comment-action {
            cursor: pointer;
            color: var(--text-secondary);
            transition: var(--transition);
        }

        .comment-action:hover {
            color: var(--primary);
        }

        .replies-container {
            margin-left: 40px;
            margin-top: 10px;
        }

        .reply-input-container {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .reply-input {
            flex: 1;
            padding: 5px;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: #2b2b2b;
            color: var(--text-primary);
            font-size: 12px;
        }

        .reply-btn {
            padding: 5px 10px;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .reply-item {
            background: #2b2b2b;
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 5px;
            font-size: 13px;
        }

        /* Share Menu */
        .share-menu {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            z-index: 3000;
            display: none;
            min-width: 200px;
            border: 1px solid var(--border);
        }

        .share-menu ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .share-menu li {
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .share-menu li:hover {
            background: var(--primary);
            color: var(--text-primary);
        }

        .share-menu li:last-child {
            border-bottom: none;
        }

        /* Stories Section */
        .stories-container {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding: 10px 0;
            margin-bottom: 20px;
        }
        
        .story-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }
        
        .story-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: var(--secondary);
            color: var(--surface);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
            border: 3px solid var(--primary);
            margin-bottom: 5px;
        }
        
        .story-username {
            font-size: 12px;
            color: var(--text-secondary);
            max-width: 70px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .story-add {
            border: 2px dashed var(--border);
            background: transparent;
            color: var(--text-secondary);
        }
        
        .story-card {
            background: #282c34;
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid #3b4048;
            margin-bottom: 20px;
        }

        .story-content {
            background: #1f232a;
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
            line-height: 1.5;
        }
        
        /* Friends Section */
        .friends-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .friend-card {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            text-align: center;
        }
        
        .friend-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--secondary);
            color: var(--surface);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 24px;
            margin: 0 auto 15px;
        }
        
        .friend-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .friend-username {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .friend-actions {
            display: flex;
            gap: 5px;
            justify-content: center;
        }
        
        /* Notifications */
        .notifications-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .notification-item {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 15px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .notification-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--secondary);
            color: var(--surface);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }
        
        .notification-content {
            flex: 1;
        }
        
        .notification-text {
            margin-bottom: 5px;
        }
        
        .notification-time {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .notification-actions {
            display: flex;
            gap: 5px;
        }
        
        /* Search Bar */
        .search-container {
            margin-bottom: 20px;
        }
        
        .search-bar {
            display: flex;
            gap: 10px;
        }
        
        .search-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--surface);
            color: var(--text-primary);
            font-size: 16px;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        /* Online Status */
        .online-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success);
            position: absolute;
            bottom: 0;
            right: 0;
            border: 2px solid var(--surface);
        }
        
        .avatar-container {
            position: relative;
            display: inline-block;
        }

        /* Branding Section Styles */
        .branding-container {
            max-width: 600px;
            margin: 0 auto;
        }

        .branding-preview {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            border-left: 5px solid var(--secondary);
            font-family: monospace;
            white-space: pre-line;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            font-size: 14px;
        }

        .branding-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .branding-form-row {
                grid-template-columns: 1fr;
            }
        }

        .save-status {
            text-align: center;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            display: none;
        }

        .save-status.success {
            background: rgba(102, 187, 106, 0.2);
            color: var(--success);
            display: block;
        }

        /* Switch Toggle for Settings */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--success);
        }

        input:focus + .slider {
            box-shadow: 0 0 1px var(--success);
        }

        input:checked + .slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }
        
        /* Responsive Fixes */
        @media (min-width: 992px) {
            .sidebar {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: var(--sidebar-width);
            }
            
            .sidebar-close-btn {
                display: none;
            }
            
            .three-dot-menu {
                display: block;
                color: var(--primary);
            }
            
            .menu-toggle {
                display: none;
            }
            
            .header {
                 justify-content: flex-start;
                 gap: 25px;
            }
            
             .user-info {
                margin-left: auto;
            }
            
            #pageTitle {
                text-align: left;
                flex-grow: 0;
            }

            .messaging-container {
                height: 70vh;
            }
        }
        
        @media (max-width: 991px) {
            .sidebar {
                width: 80vw;
                max-width: var(--sidebar-width);
                z-index: 1001;
            }
            
            .main-content {
                margin-left: 0;
                padding: 15px;
            }
            
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                gap: 10px;
                padding: 10px 15px;
            }
            
            .header-left-group {
                order: 1;
            }
            
            #pageTitle {
                order: 2;
                flex-grow: 1;
                text-align: center;
                display: block;
                font-size: 16px;
            }
            
            .user-info {
                order: 3;
                gap: 5px;
            }
            
            .menu-toggle {
                align-self: center;
                margin-bottom: 0;
            }
            
            .three-dot-menu {
                display: block;
                order: 4;
                color: var(--primary);
            }
            
            .user-info div:last-child > div:first-child {
                display: none;
            }
            
            .user-info div:last-child {
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }

            /* Responsive Table CSS */
            .table-container table,
            .table-container thead,
            .table-container tbody,
            .table-container th,
            .table-container td,
            .table-container tr {
                display: block;
            }

            .table-container thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            
            .table-container tr {
                border: 1px solid var(--border);
                margin-bottom: 10px;
                border-radius: var(--radius);
                overflow: hidden;
            }

            .table-container td {
                border: none;
                border-bottom: 1px solid var(--border);
                position: relative;
                padding-left: 50%;
                text-align: right;
            }
            
            .table-container td:last-child {
                border-bottom: none;
            }

            #studentsSection .table-container td:nth-of-type(1):before { content: "ID"; }
            #studentsSection .table-container td:nth-of-type(2):before { content: "Name"; }
            #studentsSection .table-container td:nth-of-type(3):before { content: "Grade"; }
            #studentsSection .table-container td:nth-of-type(4):before { content: "Phone"; }
            #studentsSection .table-container td:nth-of-type(5):before { content: "Monthly Fee"; }
            #studentsSection .table-container td:nth-of-type(6):before { content: "Fee Status"; }
            #studentsSection .table-container td:nth-of-type(7):before { content: "Actions"; }
            
            #feesSection .table-container td:nth-of-type(1):before { content: "Receipt ID"; }
            #feesSection .table-container td:nth-of-type(2):before { content: "Student Name"; }
            #feesSection .table-container td:nth-of-type(3):before { content: "Month"; }
            #feesSection .table-container td:nth-of-type(4):before { content: "Amount"; }
            #feesSection .table-container td:nth-of-type(5):before { content: "Status"; }
            #feesSection .table-container td:nth-of-type(6):before { content: "Date Paid"; }
            #feesSection .table-container td:nth-of-type(7):before { content: "Actions"; }

            .table-container td:before {
                position: absolute;
                top: 6px;
                left: 6px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: 500;
                color: var(--secondary);
                text-transform: uppercase;
                font-size: 12px;
            }

            .messaging-container {
                flex-direction: column;
                height: 70vh;
            }

            .contacts-list {
                width: 100%;
                max-height: 200px;
            }
            
            /* Mobile Social Media Styles */
            .profile-header {
                flex-direction: column;
                text-align: center;
            }
            
            .profile-stats {
                justify-content: center;
            }
            
            .profile-actions {
                justify-content: center;
            }
            
            .friends-container {
                grid-template-columns: 1fr;
            }
            
            /* Fix chat input on mobile */
            .chat-input-container {
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                padding: 10px;
                box-sizing: border-box;
                flex-wrap: nowrap;
            }

            .chat-input {
                min-width: 0;
            }

            .send-btn {
                flex-shrink: 0;
            }

            /* Fix search bar on mobile */
            .search-bar {
                flex-direction: row;
                align-items: center;
            }

            .search-input {
                min-width: 0;
            }

            .btn {
                flex-shrink: 0;
            }

            /* Mobile Comments */
            .replies-container {
                margin-left: 20px;
            }

            .comment-input-container, .reply-input-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div id="authSection" class="auth-container">
        <div class="auth-form shadow-md">
            <div class="auth-header">
                <h1><i class="fas fa-users"></i> Popcorn</h1>
                <p>Complete Social Media Platform</p>
            </div>
            
            <div class="auth-tabs">
                <div class="auth-tab active" id="loginTab">Login</div>
                <div class="auth-tab" id="registerTab">Register</div>
            </div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail"><i class="fas fa-envelope"></i> Email</label>
                    <input type="email" id="loginEmail" class="form-control" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword"><i class="fas fa-lock"></i> Password</label>
                    <input type="password" id="loginPassword" class="form-control" placeholder="Enter your password" required>
                </div>
                <button type="submit" class="btn">Login to Popcorn</button>
            </form>
            
            <form id="registerForm" style="display: none;">
                <div class="form-group">
                    <label for="registerUsername"><i class="fas fa-user"></i> Username</label>
                    <input type="text" id="registerUsername" class="form-control" placeholder="Choose a username" required>
                </div>
                <div class="form-group">
                    <label for="registerFullName"><i class="fas fa-id-card"></i> Full Name</label>
                    <input type="text" id="registerFullName" class="form-control" placeholder="Enter your full name" required>
                </div>
                <div class="form-group">
                    <label for="registerPhone"><i class="fas fa-phone"></i> Phone Number</label>
                    <input type="tel" id="registerPhone" class="form-control" placeholder="03XX-XXXXXXX" required>
                </div>
                <div class="form-group">
                    <label for="registerEmail"><i class="fas fa-envelope"></i> Email</label>
                    <input type="email" id="registerEmail" class="form-control" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="registerPassword"><i class="fas fa-lock"></i> Password</label>
                    <input type="password" id="registerPassword" class="form-control" placeholder="Create a password" required>
                </div>
                <div class="form-group">
                    <label for="registerPIN"><i class="fas fa-key"></i> Security PIN</label>
                    <input type="password" id="registerPIN" class="form-control" placeholder="4-digit PIN for security" maxlength="4" required>
                </div>
                <div class="form-group">
                    <label for="registerBio"><i class="fas fa-pen"></i> Bio</label>
                    <textarea id="registerBio" class="form-control" placeholder="Tell us about yourself" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-success">Create Account</button>
            </form>
            
            <div id="authMessage" style="margin-top: 20px;"></div>

            <div class="disclaimer-box">
                <p><strong>⚠️ Data Storage Disclaimer:</strong></p>
                <p><strong>English:</strong> This social media application uses Firebase Realtime Database for all data (users, posts, messages, stories). Your data is stored securely in the cloud.</p>
                <p><strong>اردو:</strong> یہ سوشل میڈیا ایپلیکیشن تمام ڈیٹا (صارفین، پوسٹس، میسجز، سٹوریز) کے لیے Firebase Realtime Database استعمال کرتی ہے۔ آپ کا ڈیٹا کلاؤڈ میں محفوظ طریقے سے محفوظ ہوتا ہے۔</p>
            </div>
        </div>
    </div>

    <div id="appSection" class="app-container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo-title">
                    <i class="fas fa-users fa-2x"></i>
                    <h2>Popcorn</h2>
                </div>
                <button class="sidebar-close-btn" id="sidebarCloseBtn" aria-label="Close menu">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <ul class="sidebar-menu">
                <li class="active" data-section="dashboard">
                    <i class="fas fa-home"></i> News Feed
                </li>
                <li data-section="profile">
                    <i class="fas fa-user"></i> My Profile
                </li>
                <li data-section="friends">
                    <i class="fas fa-user-friends"></i> Friends
                </li>
                <li data-section="messages">
                    <i class="fas fa-comments"></i> Messages
                </li>
                <li data-section="stories">
                    <i class="fas fa-history"></i> Stories
                </li>
                <li data-section="notifications">
                    <i class="fas fa-bell"></i> Notifications
                </li>
                <li data-section="search">
                    <i class="fas fa-search"></i> Search
                </li>
                <li data-section="emsDashboard">
                    <i class="fas fa-tachometer-alt"></i> EMS Dashboard
                </li>
                <li data-section="students">
                    <i class="fas fa-user-graduate"></i> Student Admission
                </li>
                <li data-section="fees">
                    <i class="fas fa-money-bill-wave"></i> Fee Collection
                </li>
                <li data-section="attendance">
                    <i class="fas fa-calendar-check"></i> Attendance
                </li>
                <li data-section="settings">
                    <i class="fas fa-cog"></i> Settings
                </li>
                <li data-section="branding">
                    <i class="fas fa-building"></i> Academy Branding
                </li>
            </ul>
        </div>
        
        <div class="sidebar-backdrop" id="sidebarBackdrop"></div>

        <div class="main-content" id="mainContent">
            <div class="header shadow-md">
                <div class="header-left-group">
                    <button class="menu-toggle" id="menuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>

                <h1 id="pageTitle">News Feed</h1>

                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div>
                        <div>Welcome, <strong id="loggedInUser">User</strong></div>
                        <button id="logoutBtn" class="btn btn-danger btn-sm">Logout</button>
                    </div>
                </div>
            </div>

            <div id="dashboardSection" class="content-section active">
                <div class="section-header">
                    <h2>News Feed</h2>
                    <p>Latest updates from your friends</p>
                </div>
                
                <div class="stories-container" id="storiesFeed">
                    <div class="story-item">
                        <div class="story-avatar story-add">
                            <i class="fas fa-plus"></i>
                        </div>
                        <div class="story-username">Your Story</div>
                    </div>
                </div>
                
                <div class="posts-container" id="postsFeed">
                    <div class="loading">Loading posts...</div>
                </div>
            </div>

            <div id="profileSection" class="content-section">
                <div class="section-header">
                    <h2>My Profile</h2>
                    <p>Manage your profile and settings</p>
                </div>
                
                <div class="profile-container">
                    <div class="profile-header">
                        <div class="profile-avatar" id="profileAvatar">U</div>
                        <div class="profile-info">
                            <h1 class="profile-name" id="profileName">User Name</h1>
                            <p class="profile-bio" id="profileBio">This is my bio</p>
                            <div class="profile-stats">
                                <div class="profile-stat">
                                    <div class="stat-value" id="profilePosts">0</div>
                                    <div class="stat-label">Posts</div>
                                </div>
                                <div class="profile-stat">
                                    <div class="stat-value" id="profileFriends">0</div>
                                    <div class="stat-label">Friends</div>
                                </div>
                                <div class="profile-stat">
                                    <div class="stat-value" id="profileFollowers">0</div>
                                    <div class="stat-label">Followers</div>
                                </div>
                            </div>
                        </div>
                        <div class="profile-actions">
                            <button class="btn" id="editProfileBtn">Edit Profile</button>
                            <button class="btn btn-success" id="createPostBtn">Create Post</button>
                        </div>
                    </div>
                    
                    <div class="posts-container" id="profilePostsContainer">
                        <div class="loading">Loading your posts...</div>
                    </div>
                </div>
            </div>

            <div id="friendsSection" class="content-section">
                <div class="section-header">
                    <h2>Friends</h2>
                    <p>Manage your friends and connections</p>
                </div>
                
                <div class="search-container">
                    <div class="search-bar">
                        <input type="text" class="search-input" id="friendSearch" placeholder="Search for friends...">
                        <button class="btn" id="searchFriendBtn">Search</button>
                    </div>
                </div>
                
                <div class="friends-container" id="friendsList">
                    <div class="loading">Loading friends...</div>
                </div>
                
                <div class="section-header" style="margin-top: 40px;">
                    <h3>Friend Requests</h3>
                </div>
                
                <div class="friends-container" id="friendRequestsList">
                    <div class="loading">Loading friend requests...</div>
                </div>
            </div>

            <div id="messagesSection" class="content-section">
                <div class="section-header">
                    <h2>Messages</h2>
                    <p>Chat with your friends in real-time</p>
                </div>
                <div class="messaging-container shadow-md">
                    <div class="contacts-list" id="contactsList">
                        <div class="loading">Loading contacts...</div>
                    </div>
                    <div class="chat-window" id="chatWindow">
                        <div class="no-chat-selected">
                            <i class="fas fa-comment-dots" style="font-size: 48px; color: var(--text-secondary); margin-bottom: 10px;"></i>
                            <p>Select a friend to start chatting.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="storiesSection" class="content-section">
                <div class="section-header">
                    <h2>Stories</h2>
                    <p>Share moments that disappear after 24 hours</p>
                </div>
                
                <div class="stories-container" id="storiesList">
                    <div class="story-item">
                        <div class="story-avatar story-add">
                            <i class="fas fa-plus"></i>
                        </div>
                        <div class="story-username">Your Story</div>
                    </div>
                </div>
                
                <div class="form-container shadow-md">
                    <h3>Create New Story</h3>
                    <form id="storyForm">
                        <div class="form-group">
                            <label for="storyText">Story Text</label>
                            <textarea id="storyText" class="form-control" placeholder="What's happening?" rows="3"></textarea>
                        </div>
                        <button type="submit" class="btn">Add to Story</button>
                    </form>
                </div>
            </div>

            <div id="notificationsSection" class="content-section">
                <div class="section-header">
                    <h2>Notifications</h2>
                    <p>Your recent activity and updates</p>
                </div>
                
                <div class="notifications-container" id="notificationsList">
                    <div class="loading">Loading notifications...</div>
                </div>
            </div>

            <div id="searchSection" class="content-section">
                <div class="section-header">
                    <h2>Search</h2>
                    <p>Find people and content</p>
                </div>
                
                <div class="search-container">
                    <div class="search-bar">
                        <input type="text" class="search-input" id="globalSearch" placeholder="Search for people, posts, or hashtags...">
                        <button class="btn" id="globalSearchBtn">Search</button>
                    </div>
                </div>
                
                <div class="friends-container" id="searchResults">
                    <div class="no-contacts">
                        <i class="fas fa-search" style="font-size: 48px; color: var(--text-secondary); margin-bottom: 10px;"></i>
                        <p>Enter a search term to find people and content.</p>
                    </div>
                </div>
            </div>

            <!-- EMS Sections -->
            <div id="emsDashboardSection" class="content-section">
                <div class="section-header">
                    <h2>EMS Dashboard Overview</h2>
                    <p>Welcome to your education management dashboard</p>
                </div>
                
                <div class="dashboard-cards">
                    <div class="card">
                        <div class="card-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <h3>Total Students</h3>
                        <div class="card-value" id="totalStudents">0</div>
                        <div class="card-desc">Registered in academy</div>
                    </div>
                    
                    <div class="card">
                        <div class="card-icon">
                            <i class="fas fa-coins"></i>
                        </div>
                        <h3>Fees Collected</h3>
                        <div class="card-value"><span class="currency" id="feesCollected">0</span></div>
                        <div class="card-desc">This month</div>
                    </div>
                    
                    <div class="card">
                        <div class="card-icon">
                            <i class="fas fa-clipboard-check"></i>
                        </div>
                        <h3>Today's Attendance</h3>
                        <div class="card-value" id="todayAttendance">0%</div>
                        <div class="card-desc">Present students</div>
                    </div>
                    
                    <div class="card">
                        <div class="card-icon">
                            <i class="fas fa-exclamation-circle"></i>
                        </div>
                        <h3>Pending Fees</h3>
                        <div class="card-value" id="pendingFees">0</div>
                        <div class="card-desc">For current month</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="table-container shadow-md">
                        <h3>Recent Fee Collections</h3>
                        <div class="table-responsive">
                            <table id="recentFeesTable">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="table-container shadow-md">
                        <h3>Recent Attendance</h3>
                         <div class="table-responsive">
                            <table id="recentAttendanceTable">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Present</th>
                                        <th>Absent</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="studentsSection" class="content-section">
                <div class="section-header">
                    <h2>Student Admission</h2>
                    <p>Manage student records and information</p>
                </div>
                
                <div class="form-container shadow-md">
                    <h3>Add New Student</h3>
                    <form id="studentForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="studentName">Student Name</label>
                                <input type="text" id="studentName" class="form-control" placeholder="Full name of student" required>
                            </div>
                            <div class="form-group">
                                <label for="studentGrade">Grade (1-12)</label>
                                <select id="studentGrade" class="form-control" required>
                                    <option value="">Select Grade</option>
                                    <option value="1">Grade 1</option>
                                    <option value="2">Grade 2</option>
                                    <option value="3">Grade 3</option>
                                    <option value="4">Grade 4</option>
                                    <option value="5">Grade 5</option>
                                    <option value="6">Grade 6</option>
                                    <option value="7">Grade 7</option>
                                    <option value="8">Grade 8</option>
                                    <option value="9">Grade 9</option>
                                    <option value="10">Grade 10</option>
                                    <option value="11">Grade 11</option>
                                    <option value="12">Grade 12</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="studentPhone">Parent's Phone</label>
                                <input type="tel" id="studentPhone" class="form-control" placeholder="03XX-XXXXXXX" required>
                            </div>
                            <div class="form-group">
                                <label for="studentFee">Monthly Fee (PKR)</label>
                                <input type="number" id="studentFee" class="form-control" placeholder="Monthly fee amount" required>
                            </div>
                        </div>
                        <button type="submit" class="btn" style="margin-top: 20px;"><i class="fas fa-plus-circle"></i> Add Student</button>
                    </form>
                </div>
                
                <div class="table-container shadow-md">
                    <h3>Student Records (History)</h3>
                    <div class="table-responsive">
                        <table id="studentsTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Grade</th>
                                    <th>Phone</th>
                                    <th>Monthly Fee</th>
                                    <th>Fee Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="feesSection" class="content-section">
                <div class="section-header">
                    <h2>Fee Collection</h2>
                    <p>Record and manage student fee payments</p>
                </div>
                
                <div class="form-container shadow-md">
                    <h3>Collect Fee</h3>
                    <form id="feeForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="feeStudent">Select Student</label>
                                <select id="feeStudent" class="form-control" required>
                                    <option value="">Select Student</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="feeMonth">Month</label>
                                <input type="month" id="feeMonth" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="feeAmount">Amount (PKR)</label>
                                <input type="number" id="feeAmount" class="form-control" placeholder="Amount to collect" required>
                                <small id="feeHelp" style="color: var(--text-secondary); font-weight: 500; margin-top: 5px; display: block;">
                                    Monthly Fee: <span class="currency" id="monthlyFeeDisplay" style="color: var(--success);">0</span> | 
                                    <span style="color: var(--danger);">Remaining/Due: <span class="currency" id="remainingFeeDisplay" style="color: var(--danger);">0</span></span>
                                </small>
                            </div>
                            <div class="form-group">
                                <label for="feeDate">Payment Date</label>
                                <input type="date" id="feeDate" class="form-control" required>
                            </div>
                        </div>
                        <button type="submit" class="btn" style="margin-top: 20px;"><i class="fas fa-money-check"></i> Collect Fee</button>
                    </form>
                </div>
                
                <div class="table-container shadow-md">
                    <h3>Fee Records (History)</h3>
                    <div class="table-responsive">
                        <table id="feesTable">
                            <thead>
                                <tr>
                                    <th>Receipt ID</th>
                                    <th>Student Name</th>
                                    <th>Month</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Date Paid</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="attendanceSection" class="content-section">
                <div class="section-header">
                    <h2>Attendance Management</h2>
                    <p>Track and manage student attendance</p>
                </div>
                
                <div class="form-container shadow-md">
                    <h3>Mark Attendance</h3>
                    <form id="attendanceForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="attendanceDate">Date</label>
                                <input type="date" id="attendanceDate" class="form-control" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Mark Attendance for Students</label>
                            <div id="attendanceList" style="max-height: 500px; overflow-y: auto; border: 1px solid var(--border); padding: 15px; border-radius: 8px; background-color: #2b2b2b;">
                                </div>
                        </div>
                        <button type="submit" class="btn" style="margin-top: 20px;"><i class="fas fa-save"></i> Save Attendance</button>
                    </form>
                </div>
                
                <div class="table-container shadow-md">
                    <h3>Attendance Records (History)</h3>
                    <div class="table-responsive">
                        <table id="attendanceTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Present</th>
                                    <th>Absent</th>
                                    <th>Percentage</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="settingsSection" class="content-section">
                <div class="section-header">
                    <h2>Settings</h2>
                    <p>Manage your account and preferences</p>
                </div>
                
                <div class="form-container shadow-md">
                    <h3>Account Settings</h3>
                    <form id="settingsForm">
                        <div class="form-group">
                            <label for="changePasswordEmail">Reset Password</label>
                            <input type="email" id="changePasswordEmail" class="form-control" placeholder="Enter email to send reset link" required>
                            <button type="button" class="btn btn-warning" onclick="sendPasswordReset()">Send Reset Link</button>
                        </div>
                        <div class="form-group">
                            <label>Notifications</label>
                            <label class="switch">
                                <input type="checkbox" id="notificationsToggle" checked>
                                <span class="slider"></span>
                            </label>
                            <small>Enable/disable push notifications</small>
                        </div>
                        <div class="form-group">
                            <label for="privacySetting">Privacy</label>
                            <select id="privacySetting" class="form-control">
                                <option value="public">Public</option>
                                <option value="friends">Friends Only</option>
                                <option value="private">Private</option>
                            </select>
                        </div>
                    </form>
                </div>
            </div>

            <div id="brandingSection" class="content-section">
                <div class="section-header">
                    <h2>Academy Branding</h2>
                    <p>Set up your school or academy details for WhatsApp receipts and alerts</p>
                </div>
                
                <div class="branding-container">
                    <div class="form-container shadow-md">
                        <h3>Branding Settings</h3>
                        <form id="brandingForm">
                            <div class="form-row branding-form-row">
                                <div class="form-group">
                                    <label for="schoolName"><i class="fas fa-school"></i> School/Academy Name</label>
                                    <input type="text" id="schoolName" class="form-control" placeholder="Enter your school or academy name">
                                </div>
                                <div class="form-group">
                                    <label for="schoolPhone"><i class="fas fa-phone"></i> Academy Phone Number</label>
                                    <input type="tel" id="schoolPhone" class="form-control" placeholder="03XX-XXXXXXX">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-success"><i class="fas fa-save"></i> Save Branding</button>
                            <div id="saveStatus" class="save-status"></div>
                        </form>
                    </div>
                    
                    <div class="form-container shadow-md">
                        <h3>WhatsApp Message Preview</h3>
                        <div id="brandingPreview" class="branding-preview">
                            Fee Receipt - Sample Student
                            
                            Month: 2025-10
                            Amount: PKR 5000
                            Status: Fully Paid
                            Date: 2025-10-12
                            
                            [Your Academy Name Here]
                            Contact: [Your Academy Phone Here]
                            
                            Thank you! - Created by Sample User
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Menu -->
    <div id="shareMenu" class="share-menu">
        <ul>
            <li onclick="copyPostLink(currentPostId)"><i class="fas fa-link"></i> Copy Link</li>
            <li onclick="savePost(currentPostId)"><i class="fas fa-bookmark"></i> Save Post</li>
            <li onclick="shareToWhatsApp(currentPostId)"><i class="fab fa-whatsapp"></i> Share to WhatsApp</li>
            <li onclick="closeShareMenu()"><i class="fas fa-times"></i> Cancel</li>
        </ul>
    </div>

    <!-- Create Post Modal -->
    <div id="postModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> Create Post</h3>
                <span class="close-modal" onclick="closePostModal()">×</span>
            </div>
            <form id="createPostForm">
                <div class="form-group">
                    <textarea id="postContent" class="form-control" placeholder="What's on your mind?" rows="5" required></textarea>
                </div>
                <div class="form-group">
                    <label for="fontSize">Font Size</label>
                    <select id="fontSize" class="form-control">
                        <option value="normal">Normal</option>
                        <option value="large">Large</option>
                    </select>
                </div>
                <div style="display: flex; justify-content: space-between; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-danger" onclick="closePostModal()">Cancel</button>
                    <button type="submit" class="btn btn-success">Post</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-edit"></i> Edit Profile</h3>
                <span class="close-modal" onclick="closeProfileModal()">×</span>
            </div>
            <form id="editProfileForm">
                <div class="form-group">
                    <label for="editFullName">Full Name</label>
                    <input type="text" id="editFullName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="editUsername">Username</label>
                    <input type="text" id="editUsername" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="editBio">Bio</label>
                    <textarea id="editBio" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="editAvatar">Avatar Initial</label>
                    <input type="text" id="editAvatar" class="form-control" maxlength="1" required>
                </div>
                <div style="display: flex; justify-content: space-between; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-danger" onclick="closeProfileModal()">Cancel</button>
                    <button type="submit" class="btn btn-success">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Story Viewer Modal -->
    <div id="storyModal" class="modal">
        <div class="modal-content" style="width: 500px; max-width: 90%;">
            <div class="modal-header">
                <h3 id="storyUsername"><i class="fas fa-history"></i> Story</h3>
                <span class="close-modal" onclick="closeStoryModal()">×</span>
            </div>
            <div class="story-content" id="storyContent"></div>
            <div class="comments-section" id="storyRepliesSection">
                <div class="comment-input-container">
                    <input type="text" class="comment-input" placeholder="Reply to this story..." id="storyReplyInput">
                    <button class="add-comment-btn" onclick="addStoryReply()">Reply</button>
                </div>
                <div id="storyReplies"></div>
            </div>
        </div>
    </div>

    <div id="pinModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-lock"></i> Enter Security PIN</h3>
                <span class="close-modal" onclick="closePinModal()">×</span>
            </div>
            <p style="margin-bottom: 15px; color: var(--text-secondary);">To perform this secure action (Delete/Edit), please enter your 4-digit PIN.</p>
            <div class="form-group">
                <input type="password" id="pinInput" class="form-control" placeholder="Enter your 4-digit PIN" maxlength="4">
            </div>
            <div style="display: flex; justify-content: space-between; gap: 10px; margin-top: 20px;">
                <button class="btn btn-danger" onclick="closePinModal()">Cancel</button>
                <button class="btn btn-success" onclick="verifyPin()">Verify PIN</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables for share menu
        let currentPostId = null;
        let currentStoryId = null;

        // ✅ FIXED Firebase Configuration - Database URL Updated
        const firebaseConfig = {
            apiKey: "AIzaSyAaM6vNyFpliNAgzujoG4xBDbTGmSB33no",
            authDomain: "ems-by-ali.firebaseapp.com",
            projectId: "ems-by-ali",
            storageBucket: "ems-by-ali.firebasestorage.app",
            messagingSenderId: "920434998465",
            appId: "1:920434998465:web:e52f12fdb9fa1d64cf6840",
            measurementId: "G-ZX7G5E1B45",
            databaseURL: "https://ems-by-ali-default-rtdb.asia-southeast1.firebasedatabase.app" // ✅ FIXED URL
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const storage = firebase.storage();

        // Application state
        let currentUser = null;
        let users = {};
        let currentChatUser = null;
        let currentMessagesRef = null;

        // EMS state
        let students = [];
        let fees = [];
        let attendance = [];
        let currentAction = null;
        let currentItemId = null;
        let calcExpression = '';

        // Sidebar Elements
        const sidebar = document.getElementById('sidebar');
        const backdrop = document.getElementById('sidebarBackdrop');

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is signed in
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = {
                        uid: user.uid,
                        email: user.email
                    };
                    
                    // Load user data from DB
                    db.ref('users/' + currentUser.uid).once('value').then((snap) => {
                        if (snap.exists()) {
                            const data = snap.val();
                            currentUser.username = data.username;
                            currentUser.fullName = data.fullName;
                            currentUser.phone = data.phone;
                            currentUser.schoolName = data.schoolName || '';
                            currentUser.schoolPhone = data.schoolPhone || '';
                            currentUser.bio = data.bio || '';
                            currentUser.avatar = data.avatar || currentUser.fullName.charAt(0).toUpperCase();
                            currentUser.createdAt = data.createdAt;
                            currentUser.pin = data.pin;
                        }
                        loadUserData();
                        showApp();
                    });
                } else {
                    currentUser = null;
                }
            });

            // Set up event listeners
            setupEventListeners();
            
            // Set current dates for EMS
            const today = new Date().toISOString().split('T')[0];
            if (document.getElementById('feeMonth')) document.getElementById('feeMonth').valueAsDate = new Date();
            if (document.getElementById('feeDate')) document.getElementById('feeDate').value = today;
            if (document.getElementById('attendanceDate')) document.getElementById('attendanceDate').value = today;
        });

        // Set up event listeners
        function setupEventListeners() {
            // Auth tabs
            document.getElementById('loginTab').addEventListener('click', () => switchAuthTab('login'));
            document.getElementById('registerTab').addEventListener('click', () => switchAuthTab('register'));
            
            // Auth forms
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', function(e) {
                e.preventDefault();
                handleLogout();
            });
            
            // Sidebar toggle and close
            document.getElementById('menuToggle').addEventListener('click', openSidebar); 
            document.getElementById('sidebarCloseBtn').addEventListener('click', closeSidebar);
            backdrop.addEventListener('click', closeSidebar);
            
            // Menu items
            document.querySelectorAll('.sidebar-menu li').forEach(item => {
                item.addEventListener('click', () => {
                    const section = item.getAttribute('data-section');
                    showSection(section);
                    
                    // Update active menu item
                    document.querySelectorAll('.sidebar-menu li').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    
                    // Close sidebar after selection
                    closeSidebar();
                });
            });
            
            // Post creation
            document.getElementById('createPostBtn').addEventListener('click', openPostModal);
            document.getElementById('createPostForm').addEventListener('submit', handleCreatePost);
            
            // Profile editing
            document.getElementById('editProfileBtn').addEventListener('click', openProfileModal);
            document.getElementById('editProfileForm').addEventListener('submit', handleEditProfile);
            
            // Friend search
            document.getElementById('searchFriendBtn').addEventListener('click', handleFriendSearch);
            document.getElementById('friendSearch').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleFriendSearch();
            });
            
            // Global search
            document.getElementById('globalSearchBtn').addEventListener('click', handleGlobalSearch);
            document.getElementById('globalSearch').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleGlobalSearch();
            });
            
            // Story creation
            document.getElementById('storyForm').addEventListener('submit', handleCreateStory);
            
            // Branding form
            document.getElementById('brandingForm').addEventListener('submit', handleBrandingSave);
            
            // EMS event listeners
            if (document.getElementById('studentForm')) document.getElementById('studentForm').addEventListener('submit', handleAddStudent);
            if (document.getElementById('feeForm')) document.getElementById('feeForm').addEventListener('submit', handleFeeCollection);
            if (document.getElementById('feeStudent')) document.getElementById('feeStudent').addEventListener('change', updateFeeInfo);
            if (document.getElementById('feeMonth')) document.getElementById('feeMonth').addEventListener('change', updateFeeInfo);
            if (document.getElementById('attendanceForm')) document.getElementById('attendanceForm').addEventListener('submit', handleAttendance);
            if (document.getElementById('attendanceDate')) document.getElementById('attendanceDate').addEventListener('change', loadAttendanceForm);
        }

        // Sidebar Control functions
        function openSidebar() {
            sidebar.classList.add('open');
            backdrop.classList.add('open');
        }

        function closeSidebar() {
            sidebar.classList.remove('open');
            backdrop.classList.remove('open');
        }

        // Authentication functions
        function switchAuthTab(tab) {
            document.getElementById('loginTab').classList.toggle('active', tab === 'login');
            document.getElementById('registerTab').classList.toggle('active', tab === 'register');
            document.getElementById('loginForm').style.display = tab === 'login' ? 'block' : 'none';
            document.getElementById('registerForm').style.display = tab === 'register' ? 'block' : 'none';
            document.getElementById('authMessage').innerHTML = '';
            
            if (tab === 'login') {
                document.getElementById('registerForm').reset();
            } else {
                document.getElementById('loginForm').reset();
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    showAuthMessage('Login successful! Redirecting to dashboard...', 'success');
                })
                .catch((error) => {
                    showAuthMessage('Invalid email or password. Please try again.', 'error');
                });
        }

        function handleRegister(e) {
            e.preventDefault();
            const username = document.getElementById('registerUsername').value;
            const fullName = document.getElementById('registerFullName').value;
            const phone = document.getElementById('registerPhone').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const bio = document.getElementById('registerBio').value;
            const pin = document.getElementById('registerPIN').value;
            
            if (!phone.match(/^03\d{9}$/)) {
                showAuthMessage('Please enter a valid Pakistani phone number (03XXXXXXXXX)', 'error');
                return;
            }
            
            if (pin.length !== 4 || isNaN(pin)) {
                showAuthMessage('PIN must be a 4-digit number', 'error');
                return;
            }
            
            // Check if username already exists
            db.ref('users').orderByChild('username').equalTo(username).once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        showAuthMessage('Username already exists. Please choose a different one.', 'error');
                    } else {
                        // Create user with email and password
                        auth.createUserWithEmailAndPassword(email, password)
                            .then((userCredential) => {
                                const user = userCredential.user;
                                
                                // Store user data in Firebase
                                db.ref('users/' + user.uid).set({
                                    username,
                                    usernameLower: username.toLowerCase(),
                                    fullName,
                                    phone,
                                    email,
                                    bio,
                                    avatar: fullName.charAt(0).toUpperCase(),
                                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                                    lastSeen: firebase.database.ServerValue.TIMESTAMP,
                                    pin
                                }).then(() => {
                                    showAuthMessage('Registration successful! You can now login with your credentials.', 'success');
                                    switchAuthTab('login');
                                    document.getElementById('registerForm').reset();
                                }).catch((dbError) => {
                                    showAuthMessage('Error saving user data: ' + dbError.message, 'error');
                                });
                            })
                            .catch((error) => {
                                const errorCode = error.code;
                                const errorMessage = error.message;
                                showAuthMessage('Error creating account: ' + errorMessage, 'error');
                            });
                    }
                });
        }

        function showAuthMessage(message, type) {
            const messageDiv = document.getElementById('authMessage');
            const style = type === 'success' ? 'background: #5cb860; color: white; padding: 10px; border-radius: 4px;' : 
                                               'background: #e53935; color: white; padding: 10px; border-radius: 4px;';
            messageDiv.innerHTML = `<div style="${style}">${message}</div>`;
        }

        // Handle logout with proper cleanup
        function handleLogout() {
            if (currentMessagesRef) {
                currentMessagesRef.off();
            }
            
            // Update last seen timestamp
            if (currentUser) {
                db.ref('users/' + currentUser.uid + '/lastSeen').set(firebase.database.ServerValue.TIMESTAMP);
                saveUserData();
            }
            
            auth.signOut().then(() => {
                clearUserData();
                
                // Reset forms
                document.getElementById('loginForm').reset();
                document.getElementById('registerForm').reset();
                
                // Show auth section and hide app section
                document.getElementById('authSection').style.display = 'flex';
                document.getElementById('appSection').style.display = 'none';
                
                // Switch to login tab
                switchAuthTab('login');
                
                // Clear any auth messages
                document.getElementById('authMessage').innerHTML = '';
                
                console.log("User logged out successfully");
            }).catch((error) => {
                console.error("Error signing out:", error);
            });
        }

        // Utility function for EMS data
        function getUserDataKey(keyName) {
            if (!currentUser || !currentUser.uid) return null;
            return `${keyName}_${currentUser.uid}`;
        }

        // Load user-specific EMS data
        function loadUserData() {
            if (!currentUser) return;
            
            const studentKey = getUserDataKey('students');
            const feesKey = getUserDataKey('fees');
            const attendanceKey = getUserDataKey('attendance');
            
            students = JSON.parse(localStorage.getItem(studentKey)) || [];
            fees = JSON.parse(localStorage.getItem(feesKey)) || [];
            attendance = JSON.parse(localStorage.getItem(attendanceKey)) || [];
            
            updateDashboard();
            updateStudentDropdown();
            loadStudentsTable();
            loadFeesTable();
            loadAttendanceTable();
            updateBrandingPreview();
        }

        // Save user-specific EMS data
        function saveUserData() {
            if (!currentUser) return;
            
            const studentKey = getUserDataKey('students');
            const feesKey = getUserDataKey('fees');
            const attendanceKey = getUserDataKey('attendance');
            
            localStorage.setItem(studentKey, JSON.stringify(students));
            localStorage.setItem(feesKey, JSON.stringify(fees));
            localStorage.setItem(attendanceKey, JSON.stringify(attendance));
        }

        // Clear EMS data on logout
        function clearUserData() {
            students = [];
            fees = [];
            attendance = [];
            currentUser = null;
            if (currentMessagesRef) {
                currentMessagesRef.off();
            }
        }

        // UI Navigation functions
        function showApp() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('appSection').style.display = 'block';
            
            // Handle display for logged-in user
            const userName = currentUser.fullName || currentUser.username || currentUser.email.split('@')[0];
            document.getElementById('loggedInUser').textContent = userName;
            document.getElementById('userAvatar').textContent = currentUser.avatar;
            document.getElementById('changePasswordEmail').value = currentUser.email;
            
            // Update profile section
            updateProfileSection();
            
            // Load branding form
            document.getElementById('schoolName').value = currentUser.schoolName;
            document.getElementById('schoolPhone').value = currentUser.schoolPhone;
            
            showSection('dashboard');
            
            // Load users in real-time
            db.ref('users').on('value', (snap) => {
                users = {};
                snap.forEach((child) => {
                    users[child.key] = child.val();
                });
                if (document.getElementById('messagesSection').classList.contains('active')) {
                    loadMessagesContacts();
                }
            });
            
            // Set up presence
            const myPresenceRef = db.ref('users/' + currentUser.uid + '/lastSeen');
            db.ref('.info/connected').on('value', (snap) => {
                if (snap.val()) {
                    myPresenceRef.onDisconnect().set(firebase.database.ServerValue.TIMESTAMP);
                    myPresenceRef.set(firebase.database.ServerValue.TIMESTAMP);
                }
            });
            setInterval(() => {
                myPresenceRef.set(firebase.database.ServerValue.TIMESTAMP);
            }, 60000); // Update every minute
        }

        function showSection(section) {
            document.querySelectorAll('.content-section').forEach(sec => {
                sec.classList.remove('active');
            });
            
            document.getElementById(`${section}Section`).classList.add('active');
            
            const titles = {
                dashboard: 'News Feed',
                profile: 'My Profile',
                friends: 'Friends',
                messages: 'Messages',
                stories: 'Stories',
                notifications: 'Notifications',
                search: 'Search',
                emsDashboard: 'EMS Dashboard Overview',
                students: 'Student Admission',
                fees: 'Fee Collection',
                attendance: 'Attendance Management',
                settings: 'Settings',
                branding: 'Academy Branding'
            };
            document.getElementById('pageTitle').textContent = titles[section] || section;
            
            if (section === 'dashboard') {
                loadNewsFeed();
                loadStories();
            } else if (section === 'profile') {
                loadProfilePosts();
            } else if (section === 'friends') {
                loadFriends();
                loadFriendRequests();
            } else if (section === 'messages') {
                loadMessagesContacts();
            } else if (section === 'stories') {
                loadStories();
            } else if (section === 'notifications') {
                loadNotifications();
            } else if (section === 'search') {
                // Clear search results
                document.getElementById('searchResults').innerHTML = `
                    <div class="no-contacts">
                        <i class="fas fa-search" style="font-size: 48px; color: var(--text-secondary); margin-bottom: 10px;"></i>
                        <p>Enter a search term to find people and content.</p>
                    </div>
                `;
            } else if (section === 'emsDashboard') {
                updateDashboard();
            } else if (section === 'students') {
                loadStudentsTable();
            } else if (section === 'fees') {
                loadFeesTable();
            } else if (section === 'attendance') {
                loadAttendanceForm();
            } else if (section === 'settings') {
                // Settings loaded statically
            } else if (section === 'branding') {
                updateBrandingPreview();
            }
        }

        // Settings functions
        function sendPasswordReset() {
            const email = document.getElementById('changePasswordEmail').value;
            auth.sendPasswordResetEmail(email).then(() => {
                alert('Password reset email sent!');
            }).catch(error => {
                alert('Error: ' + error.message);
            });
        }

        // Branding Management
        function handleBrandingSave(e) {
            e.preventDefault();
            
            const schoolName = document.getElementById('schoolName').value.trim();
            const schoolPhone = document.getElementById('schoolPhone').value.trim();
            
            if (schoolPhone && !schoolPhone.match(/^03\d{9}$/)) {
                alert('Please enter a valid Pakistani phone number (03XXXXXXXXX)');
                return;
            }
            
            db.ref('users/' + currentUser.uid).update({
                schoolName,
                schoolPhone
            }).then(() => {
                // Update local user data
                currentUser.schoolName = schoolName;
                currentUser.schoolPhone = schoolPhone;
                
                // Show success
                const saveStatus = document.getElementById('saveStatus');
                saveStatus.textContent = 'Branding saved successfully!';
                saveStatus.className = 'save-status success';
                setTimeout(() => {
                    saveStatus.style.display = 'none';
                }, 3000);
                
                updateBrandingPreview();
                alert('Branding updated! It will now appear in WhatsApp receipts and alerts.');
            }).catch((error) => {
                alert('Error saving branding: ' + error.message);
            });
        }

        function updateBrandingPreview() {
            const preview = document.getElementById('brandingPreview');
            const branding = currentUser.schoolName ? `${currentUser.schoolName}\n` : '';
            const contact = currentUser.schoolPhone ? `Contact: ${currentUser.schoolPhone}\n` : '';
            preview.textContent = `Fee Receipt - Sample Student

Month: 2025-10
Amount: PKR 5000
Status: Fully Paid
Date: 2025-10-12

${branding}${contact}Thank you! - Created by Sample User`;
        }

        // Profile Management
        function updateProfileSection() {
            document.getElementById('profileName').textContent = currentUser.fullName;
            document.getElementById('profileBio').textContent = currentUser.bio || 'No bio yet';
            document.getElementById('profileAvatar').textContent = currentUser.avatar;
            
            // Followers same as friends for simplicity
            document.getElementById('profileFollowers').textContent = document.getElementById('profileFriends').textContent;
        }

        function openProfileModal() {
            document.getElementById('editFullName').value = currentUser.fullName;
            document.getElementById('editUsername').value = currentUser.username;
            document.getElementById('editBio').value = currentUser.bio || '';
            document.getElementById('editAvatar').value = currentUser.avatar;
            
            document.getElementById('profileModal').style.display = 'flex';
        }

        function closeProfileModal() {
            document.getElementById('profileModal').style.display = 'none';
        }

        function handleEditProfile(e) {
            e.preventDefault();
            
            const fullName = document.getElementById('editFullName').value;
            const username = document.getElementById('editUsername').value;
            const bio = document.getElementById('editBio').value;
            const avatar = document.getElementById('editAvatar').value;
            
            // Check if username changed and if it's available
            if (username !== currentUser.username) {
                db.ref('users').orderByChild('username').equalTo(username).once('value')
                    .then((snapshot) => {
                        if (snapshot.exists()) {
                            alert('Username already exists. Please choose a different one.');
                        } else {
                            updateProfileData(fullName, username, bio, avatar);
                        }
                    });
            } else {
                updateProfileData(fullName, username, bio, avatar);
            }
        }

        function updateProfileData(fullName, username, bio, avatar) {
            db.ref('users/' + currentUser.uid).update({
                fullName,
                username,
                usernameLower: username.toLowerCase(),
                bio,
                avatar: avatar.charAt(0).toUpperCase()
            }).then(() => {
                // Update local user data
                currentUser.fullName = fullName;
                currentUser.username = username;
                currentUser.bio = bio;
                currentUser.avatar = avatar.charAt(0).toUpperCase();
                
                // Update UI
                updateProfileSection();
                document.getElementById('loggedInUser').textContent = currentUser.fullName;
                document.getElementById('userAvatar').textContent = currentUser.avatar;
                
                closeProfileModal();
                alert('Profile updated successfully!');
            }).catch((error) => {
                alert('Error updating profile: ' + error.message);
            });
        }

        // Post Management
        function openPostModal() {
            document.getElementById('postContent').value = '';
            document.getElementById('fontSize').value = 'normal';
            document.getElementById('postModal').style.display = 'flex';
        }

        function closePostModal() {
            document.getElementById('postModal').style.display = 'none';
        }

        function handleCreatePost(e) {
            e.preventDefault();
            
            const content = document.getElementById('postContent').value;
            const fontSize = document.getElementById('fontSize').value;
            
            if (!content.trim()) {
                alert('Please enter some content for your post');
                return;
            }
            
            const postId = db.ref('posts').push().key;
            const newPost = {
                id: postId,
                userId: currentUser.uid,
                username: currentUser.username,
                fullName: currentUser.fullName,
                avatar: currentUser.avatar,
                content: content,
                fontSize: fontSize,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                likes: 0,
                comments: 0,
                shares: 0
            };
            
            db.ref('posts/' + postId).set(newPost)
                .then(() => {
                    closePostModal();
                    alert('Post created successfully!');
                    
                    // Refresh posts feed
                    if (document.getElementById('dashboardSection').classList.contains('active')) {
                        loadNewsFeed();
                    }
                    if (document.getElementById('profileSection').classList.contains('active')) {
                        loadProfilePosts();
                    }
                })
                .catch((error) => {
                    alert('Error creating post: ' + error.message);
                });
        }

        function loadNewsFeed() {
            const postsFeed = document.getElementById('postsFeed');
            postsFeed.innerHTML = '<div class="loading">Loading posts...</div>';
            
            db.ref('posts').orderByChild('timestamp').on('value', (snapshot) => {
                postsFeed.innerHTML = '';
                
                if (!snapshot.exists()) {
                    postsFeed.innerHTML = `
                        <div class="no-contacts">
                            <i class="fas fa-newspaper" style="font-size: 48px; color: var(--text-secondary); margin-bottom: 10px;"></i>
                            <p>No posts yet. Be the first to post!</p>
                        </div>
                    `;
                    return;
                }
                
                const posts = [];
                snapshot.forEach((child) => {
                    posts.push(child.val());
                });
                
                // Sort by timestamp (newest first)
                posts.sort((a, b) => b.timestamp - a.timestamp);
                
                posts.forEach(post => {
                    const postElement = createPostElement(post);
                    postsFeed.appendChild(postElement);
                });
            });
        }

        function loadProfilePosts() {
            const profilePostsContainer = document.getElementById('profilePostsContainer');
            profilePostsContainer.innerHTML = '<div class="loading">Loading your posts...</div>';
            
            db.ref('posts').orderByChild('userId').equalTo(currentUser.uid).on('value', (snapshot) => {
                profilePostsContainer.innerHTML = '';
                
                if (!snapshot.exists()) {
                    profilePostsContainer.innerHTML = `
                        <div class="no-contacts">
                            <i class="fas fa-newspaper" style="font-size: 48px; color: var(--text-secondary); margin-bottom: 10px;"></i>
                            <p>You haven't posted anything yet.</p>
                        </div>
                    `;
                    return;
                }
                
                const posts = [];
                snapshot.forEach((child) => {
                    posts.push(child.val());
                });
                
                // Sort by timestamp (newest first)
                posts.sort((a, b) => b.timestamp - a.timestamp);
                
                // Update post count
                document.getElementById('profilePosts').textContent = posts.length;
                
                posts.forEach(post => {
                    const postElement = createPostElement(post);
                    profilePostsContainer.appendChild(postElement);
                });
            });
        }

        function createPostElement(post) {
            const postElement = document.createElement('div');
            postElement.className = 'post-card';
            
            const time = new Date(post.timestamp).toLocaleString();
            
            const fontStyle = post.fontSize === 'large' ? 'font-size: 20px;' : '';
            
            postElement.innerHTML = `
                <div class="post-header">
                    <div class="avatar-container">
                        <div class="post-avatar">${post.avatar}</div>
                    </div>
                    <div class="post-user-info">
                        <div class="post-username">${post.fullName}</div>
                        <div class="post-time">${time}</div>
                    </div>
                </div>
                <div class="post-content" style="${fontStyle}">
                    <p>${post.content}</p>
                </div>
                <div class="post-actions">
                    <div class="post-action ${post.userLiked ? 'active' : ''}" onclick="toggleLikePost('${post.id}')">
                        <i class="fas fa-heart"></i>
                        <span>${post.likes || 0}</span>
                    </div>
                    <div class="post-action" onclick="toggleComments('${post.id}')">
                        <i class="fas fa-comment"></i>
                        <span>${post.comments || 0}</span>
                    </div>
                    <div class="post-action" onclick="showShareMenu('${post.id}')">
                        <i class="fas fa-share"></i>
                        <span>${post.shares || 0}</span>
                    </div>
                    ${post.userId === currentUser.uid ? `
                    <div class="post-action" onclick="deletePost('${post.id}')" style="margin-left: auto; color: var(--danger);">
                        <i class="fas fa-trash"></i>
                        <span>Delete</span>
                    </div>
                    ` : ''}
                </div>
                <div class="comments-section" id="comments-section-${post.id}">
                    <div class="comment-input-container">
                        <input type="text" class="comment-input" placeholder="Write a comment..." id="comment-input-${post.id}">
                        <button class="add-comment-btn" onclick="addComment('${post.id}')">Comment</button>
                    </div>
                    <div id="comments-${post.id}"></div>
                </div>
            `;
            
            // Load comments
            loadComments(post.id);
            
            // Load likes for current user
            db.ref(`postLikes/${currentUser.uid}/${post.id}`).once('value').then(snap => {
                if (snap.exists()) {
                    post.userLiked = true;
                    document.querySelector(`#comments-section-${post.id} .post-action:first-child`).classList.add('active');
                }
            });
            
            return postElement;
        }

        function toggleComments(postId) {
            const section = document.getElementById(`comments-section-${postId}`);
            if (section.style.display === 'none' || section.style.display === '') {
                section.style.display = 'block';
                loadComments(postId); // Ensure comments are loaded
            } else {
                section.style.display = 'none';
            }
        }

        function showShareMenu(postId) {
            currentPostId = postId;
            const menu = document.getElementById('shareMenu');
            menu.style.display = 'block';
        }

        function closeShareMenu() {
            document.getElementById('shareMenu').style.display = 'none';
            currentPostId = null;
        }

        function copyPostLink(postId) {
            const currentUrl = window.location.href;
            const postLink = `${currentUrl}#post-${postId}`;
            navigator.clipboard.writeText(postLink).then(() => {
                alert('Post link copied to clipboard!');
                closeShareMenu();
            }).catch(() => {
                prompt('Copy this link:', postLink);
                closeShareMenu();
            });
        }

        function savePost(postId) {
            db.ref(`savedPosts/${currentUser.uid}/${postId}`).set(true).then(() => {
                alert('Post saved to your collection!');
                closeShareMenu();
            });
        }

        function shareToWhatsApp(postId) {
            db.ref(`posts/${postId}`).once('value').then(snap => {
                const post = snap.val();
                const message = `Check out this post: "${post.content}" by ${post.fullName}`;
                openWhatsApp(currentUser.phone, message);
                closeShareMenu();
            });
        }

        function toggleLikePost(postId) {
            db.ref(`postLikes/${currentUser.uid}/${postId}`).once('value').then((snap) => {
                if (snap.exists()) {
                    db.ref(`postLikes/${currentUser.uid}/${postId}`).remove();
                    db.ref(`posts/${postId}/likes`).transaction(likes => (likes || 0) - 1);
                } else {
                    db.ref(`postLikes/${currentUser.uid}/${postId}`).set(true);
                    db.ref(`posts/${postId}/likes`).transaction(likes => (likes || 0) + 1);
                }
            });
        }

        function addComment(postId) {
            const input = document.getElementById(`comment-input-${postId}`);
            const content = input.value.trim();
            if (!content) return;
            
            const commentId = db.ref(`comments/${postId}`).push().key;
            db.ref(`comments/${postId}/${commentId}`).set({
                id: commentId,
                postId,
                userId: currentUser.uid,
                username: currentUser.username,
                fullName: currentUser.fullName,
                avatar: currentUser.avatar,
                content,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                likes: 0,
                replies: 0
            }).then(() => {
                db.ref(`posts/${postId}/comments`).transaction(comments => (comments || 0) + 1);
                input.value = '';
            });
        }

        function loadComments(postId) {
            const container = document.getElementById(`comments-${postId}`);
            if (!container) return;
            
            db.ref(`comments/${postId}`).orderByChild('timestamp').on('value', (snap) => {
                container.innerHTML = '';
                snap.forEach((child) => {
                    const comment = child.val();
                    const commentEl = createCommentElement(comment, postId, child.key);
                    container.appendChild(commentEl);
                });
            });
        }

        function createCommentElement(comment, postId, commentId) {
            const commentEl = document.createElement('div');
            commentEl.className = 'comment-item';
            const time = new Date(comment.timestamp).toLocaleString();
            
            commentEl.innerHTML = `
                <div class="comment-header">
                    <div class="comment-avatar">${comment.avatar}</div>
                    <div class="comment-author">${comment.fullName}</div>
                    <div class="comment-time">${time}</div>
                </div>
                <div class="comment-content">${comment.content}</div>
                <div class="comment-actions">
                    <span class="comment-action ${comment.userLiked ? 'active' : ''}" onclick="toggleLikeComment('${postId}', '${commentId}')">
                        <i class="fas fa-heart"></i> ${comment.likes || 0}
                    </span>
                    <span class="comment-action" onclick="toggleReply('${postId}', '${commentId}')">
                        <i class="fas fa-reply"></i> Reply (${comment.replies || 0})
                    </span>
                    ${comment.userId === currentUser.uid ? `
                    <span class="comment-action" style="margin-left: auto; color: var(--danger);" onclick="deleteComment('${postId}', '${commentId}')">
                        <i class="fas fa-trash"></i> Delete
                    </span>
                    ` : ''}
                </div>
                <div class="replies-container" id="replies-${commentId}"></div>
                <div class="reply-input-container" id="reply-input-${commentId}" style="display: none; margin-top: 8px;">
                    <input type="text" class="reply-input" placeholder="Write a reply..." id="reply-input-text-${commentId}">
                    <button class="reply-btn" onclick="addReply('${postId}', '${commentId}')">Reply</button>
                </div>
            `;
            
            // Load replies
            loadReplies(postId, commentId);
            
            // Check if user liked this comment
            db.ref(`commentLikes/${currentUser.uid}/${postId}/${commentId}`).once('value').then(snap => {
                if (snap.exists()) {
                    comment.userLiked = true;
                    commentEl.querySelector('.comment-action:first-child').classList.add('active');
                }
            });
            
            return commentEl;
        }

        function toggleLikeComment(postId, commentId) {
            db.ref(`commentLikes/${currentUser.uid}/${postId}/${commentId}`).once('value').then((snap) => {
                if (snap.exists()) {
                    db.ref(`commentLikes/${currentUser.uid}/${postId}/${commentId}`).remove();
                    db.ref(`comments/${postId}/${commentId}/likes`).transaction(likes => (likes || 0) - 1);
                } else {
                    db.ref(`commentLikes/${currentUser.uid}/${postId}/${commentId}`).set(true);
                    db.ref(`comments/${postId}/${commentId}/likes`).transaction(likes => (likes || 0) + 1);
                }
            });
        }

        function toggleReply(postId, commentId) {
            const container = document.getElementById(`reply-input-${commentId}`);
            container.style.display = container.style.display === 'none' ? 'flex' : 'none';
        }

        function addReply(postId, commentId) {
            const input = document.getElementById(`reply-input-text-${commentId}`);
            const content = input.value.trim();
            if (!content) return;
            
            const replyId = db.ref(`replies/${postId}/${commentId}`).push().key;
            db.ref(`replies/${postId}/${commentId}/${replyId}`).set({
                id: replyId,
                postId,
                commentId,
                userId: currentUser.uid,
                username: currentUser.username,
                fullName: currentUser.fullName,
                avatar: currentUser.avatar,
                content,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                db.ref(`comments/${postId}/${commentId}/replies`).transaction(replies => (replies || 0) + 1);
                input.value = '';
                document.getElementById(`reply-input-${commentId}`).style.display = 'none';
            });
        }

        function loadReplies(postId, commentId) {
            const container = document.getElementById(`replies-${commentId}`);
            if (!container) return;
            
            db.ref(`replies/${postId}/${commentId}`).orderByChild('timestamp').on('value', (snap) => {
                container.innerHTML = '';
                snap.forEach((child) => {
                    const reply = child.val();
                    const replyEl = document.createElement('div');
                    replyEl.className = 'reply-item';
                    const time = new Date(reply.timestamp).toLocaleString();
                    replyEl.innerHTML = `
                        <strong>${reply.fullName}</strong> <small style="color: var(--text-secondary);">${time}</small><br>
                        ${reply.content}
                        ${reply.userId === currentUser.uid ? ` <button onclick="deleteReply('${postId}', '${commentId}', '${child.key}')" style="background: none; border: none; color: var(--danger); cursor: pointer; font-size: 12px;"><i class="fas fa-trash"></i></button>` : ''}
                    `;
                    container.appendChild(replyEl);
                });
            });
        }

        function deleteComment(postId, commentId) {
            if (confirm('Are you sure you want to delete this comment?')) {
                db.ref(`comments/${postId}/${commentId}`).remove().then(() => {
                    db.ref(`posts/${postId}/comments`).transaction(comments => (comments || 0) - 1);
                });
            }
        }

        function deleteReply(postId, commentId, replyId) {
            if (confirm('Are you sure you want to delete this reply?')) {
                db.ref(`replies/${postId}/${commentId}/${replyId}`).remove().then(() => {
                    db.ref(`comments/${postId}/${commentId}/replies`).transaction(replies => (replies || 0) - 1);
                });
            }
        }

        function sharePost(postId) {
            db.ref(`posts/${postId}`).once('value').then(snap => {
                const post = snap.val();
                const shareContent = `Check out this post: "${post.content}" shared by ${post.fullName}`;
                const shareId = db.ref('posts').push().key;
                db.ref(`posts/${shareId}`).set({
                    id: shareId,
                    userId: currentUser.uid,
                    username: currentUser.username,
                    fullName: currentUser.fullName,
                    avatar: currentUser.avatar,
                    content: shareContent,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    likes: 0,
                    comments: 0,
                    shares: 1,
                    originalPostId: postId
                }).then(() => {
                    db.ref(`posts/${postId}/shares`).transaction(shares => (shares || 0) + 1);
                    alert('Post shared successfully!');
                });
            });
        }

        function deletePost(postId) {
            if (confirm('Are you sure you want to delete this post?')) {
                db.ref('posts/' + postId).remove()
                    .then(() => {
                        alert('Post deleted successfully!');
                    })
                    .catch((error) => {
                        alert('Error deleting post: ' + error.message);
                    });
            }
        }

        // Friends Management
        function loadFriends() {
            const friendsList = document.getElementById('friendsList');
            friendsList.innerHTML = '<div class="loading">Loading friends...</div>';
            
            db.ref(`friends/${currentUser.uid}`).on('value', (snap) => {
                friendsList.innerHTML = '';
                
                if (!snap.exists()) {
                    friendsList.innerHTML = `
                        <div class="no-contacts">
                            <i class="fas fa-user-friends" style="font-size: 48px; color: var(--text-secondary); margin-bottom: 10px;"></i>
                            <p>You don't have any friends yet. Search for people to connect with!</p>
                        </div>
                    `;
                    document.getElementById('profileFriends').textContent = 0;
                    return;
                }
                
                let friendCount = 0;
                snap.forEach((child) => {
                    const friendUid = child.key;
                    const user = users[friendUid];
                    if (user) {
                        const friendElement = createFriendElement(user, friendUid);
                        friendsList.appendChild(friendElement);
                        friendCount++;
                    }
                });
                document.getElementById('profileFriends').textContent = friendCount;
            });
        }

        function createFriendElement(user, uid) {
            const friendCard = document.createElement('div');
            friendCard.className = 'friend-card';
            friendCard.innerHTML = `
                <div class="friend-avatar">${user.avatar}</div>
                <div class="friend-name">${user.fullName}</div>
                <div class="friend-username">@${user.username}</div>
                <div class="friend-actions">
                    <button class="btn btn-sm btn-success" onclick="openChatWith('${uid}')">Message</button>
                    <button class="btn btn-sm btn-danger" onclick="unfriend('${uid}')">Unfriend</button>
                    <button class="btn btn-sm btn-warning" onclick="toggleBlock('${uid}')">Block/Unblock</button>
                </div>
            `;
            return friendCard;
        }

        function unfriend(uid) {
            if (confirm('Are you sure you want to unfriend this user?')) {
                db.ref(`friends/${currentUser.uid}/${uid}`).remove();
                db.ref(`friends/${uid}/${currentUser.uid}`).remove();
            }
        }

        function loadFriendRequests() {
            const friendRequestsList = document.getElementById('friendRequestsList');
            friendRequestsList.innerHTML = '<div class="loading">Loading friend requests...</div>';
            
            db.ref(`friendRequests/${currentUser.uid}`).on('value', (snap) => {
                friendRequestsList.innerHTML = '';
                
                if (!snap.exists()) {
                    friendRequestsList.innerHTML = `
                        <div class="no-contacts">
                            <p>No pending friend requests.</p>
                        </div>
                    `;
                    return;
                }
                
                snap.forEach((child) => {
                    const senderUid = child.key;
                    const request = child.val();
                    if (request.status === 'pending') {
                        const user = users[senderUid];
                        if (user) {
                            const requestElement = document.createElement('div');
                            requestElement.className = 'friend-card';
                            requestElement.innerHTML = `
                                <div class="friend-avatar">${user.avatar}</div>
                                <div class="friend-name">${user.fullName}</div>
                                <div class="friend-username">@${user.username}</div>
                                <div class="friend-actions">
                                    <button class="btn btn-sm btn-success" onclick="acceptFriend('${senderUid}')">Accept</button>
                                    <button class="btn btn-sm btn-danger" onclick="declineFriend('${senderUid}')">Decline</button>
                                </div>
                            `;
                            friendRequestsList.appendChild(requestElement);
                        }
                    }
                });
            });
        }

        function acceptFriend(senderUid) {
            db.ref(`friendRequests/${currentUser.uid}/${senderUid}`).update({status: 'accepted'});
            db.ref(`friends/${currentUser.uid}/${senderUid}`).set(true);
            db.ref(`friends/${senderUid}/${currentUser.uid}`).set(true);
            
            // Send notification to sender
            db.ref(`notifications/${senderUid}`).push({
                type: 'friend_accept',
                from: currentUser.uid,
                text: `${currentUser.fullName} accepted your friend request`,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                read: false
            });
        }

        function declineFriend(senderUid) {
            db.ref(`friendRequests/${currentUser.uid}/${senderUid}`).remove();
        }

        function handleFriendSearch() {
            const searchTerm = document.getElementById('friendSearch').value.trim().toLowerCase();
            const friendsList = document.getElementById('friendsList');
            friendsList.innerHTML = '<div class="loading">Searching...</div>';
            
            db.ref('users').orderByChild('usernameLower').startAt(searchTerm).endAt(searchTerm + '\uf8ff').once('value')
                .then((snap) => {
                    friendsList.innerHTML = '';
                    
                    if (!snap.exists()) {
                        friendsList.innerHTML = `
                            <div class="no-contacts">
                                <i class="fas fa-search" style="font-size: 48px; color: var(--text-secondary); margin-bottom: 10px;"></i>
                                <p>No users found matching "${searchTerm}".</p>
                            </div>
                        `;
                        return;
                    }
                    
                    snap.forEach((child) => {
                        const uid = child.key;
                        if (uid === currentUser.uid) return;
                        const user = child.val();
                        const friendCard = document.createElement('div');
                        friendCard.className = 'friend-card';
                        friendCard.innerHTML = `
                            <div class="friend-avatar">${user.avatar}</div>
                            <div class="friend-name">${user.fullName}</div>
                            <div class="friend-username">@${user.username}</div>
                            <div class="friend-actions">
                                <button class="btn btn-sm btn-primary" onclick="sendFriendRequest('${uid}')">Add Friend</button>
                            </div>
                        `;
                        friendsList.appendChild(friendCard);
                    });
                })
                .catch((error) => {
                    friendsList.innerHTML = '<div class="no-contacts">Error searching users.</div>';
                });
        }

        function sendFriendRequest(uid) {
            db.ref(`friendRequests/${uid}/${currentUser.uid}`).set({
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                status: 'pending'
            });
            
            // Send notification to receiver
            db.ref(`notifications/${uid}`).push({
                type: 'friend_request',
                from: currentUser.uid,
                text: `${currentUser.fullName} sent you a friend request`,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                read: false
            });
            
            alert('Friend request sent!');
        }

        function handleGlobalSearch() {
            const searchTerm = document.getElementById('globalSearch').value.trim().toLowerCase();
            const searchResults = document.getElementById('searchResults');
            searchResults.innerHTML = '<div class="loading">Searching...</div>';
            
            // Search users by username or fullName, and posts by content
            const userQuery = db.ref('users').orderByChild('usernameLower').startAt(searchTerm).endAt(searchTerm + '\uf8ff');
            const postQuery = db.ref('posts').orderByChild('contentLower').startAt(searchTerm).endAt(searchTerm + '\uf8ff');
            
            Promise.all([userQuery.once('value'), postQuery.once('value')]).then(([userSnap, postSnap]) => {
                searchResults.innerHTML = '';
                let hasResults = false;
                
                // Users
                if (userSnap.exists()) {
                    hasResults = true;
                    const usersSection = document.createElement('div');
                    usersSection.innerHTML = '<h3 style="color: var(--secondary); margin-bottom: 15px;">People</h3>';
                    userSnap.forEach((child) => {
                        const uid = child.key;
                        if (uid === currentUser.uid) return;
                        const user = child.val();
                        const resultCard = document.createElement('div');
                        resultCard.className = 'friend-card';
                        resultCard.innerHTML = `
                            <div class="friend-avatar">${user.avatar}</div>
                            <div class="friend-name">${user.fullName}</div>
                            <div class="friend-username">@${user.username}</div>
                            <div class="friend-actions">
                                <button class="btn btn-sm btn-primary" onclick="sendFriendRequest('${uid}')">Add Friend</button>
                            </div>
                        `;
                        usersSection.appendChild(resultCard);
                    });
                    searchResults.appendChild(usersSection);
                }
                
                // Posts
                if (postSnap.exists()) {
                    hasResults = true;
                    const postsSection = document.createElement('div');
                    postsSection.innerHTML = '<h3 style="color: var(--secondary); margin-bottom: 15px;">Posts</h3>';
                    postSnap.forEach((child) => {
                        const post = child.val();
                        const postEl = createPostElement(post);
                        postEl.style.marginBottom = '0';
                        postsSection.appendChild(postEl);
                    });
                    searchResults.appendChild(postsSection);
                }
                
                if (!hasResults) {
                    searchResults.innerHTML = `
                        <div class="no-contacts">
                            <i class="fas fa-search" style="font-size: 48px; color: var(--text-secondary); margin-bottom: 10px;"></i>
                            <p>No results found for "${searchTerm}".</p>
                        </div>
                    `;
                }
            }).catch((error) => {
                searchResults.innerHTML = '<div class="no-contacts">Error searching.</div>';
            });
        }

        // Stories Management
        function loadStories() {
            const storiesFeed = document.getElementById('storiesFeed');
            const storiesList = document.getElementById('storiesList');
            
            // Clear existing stories except "Your Story"
            while (storiesFeed.children.length > 1) storiesFeed.removeChild(storiesFeed.lastChild);
            while (storiesList.children.length > 1) storiesList.removeChild(storiesList.lastChild);
            
            db.ref(`friends/${currentUser.uid}`).once('value').then((friendsSnap) => {
                const friends = friendsSnap.val() ? Object.keys(friendsSnap.val()) : [];
                friends.push(currentUser.uid); // Include own stories
                
                db.ref('stories').orderByChild('timestamp').on('value', (snap) => {
                    const storiesMap = {};
                    
                    snap.forEach((child) => {
                        const story = child.val();
                        if (friends.includes(story.userId) && story.expiresAt > Date.now()) {
                            if (!storiesMap[story.userId] || story.timestamp > storiesMap[story.userId].timestamp) {
                                storiesMap[story.userId] = story;
                            }
                        } else if (story.expiresAt <= Date.now()) {
                            db.ref('stories/' + child.key).remove(); // Clean up expired stories
                        }
                    });
                    
                    Object.values(storiesMap).sort((a, b) => b.timestamp - a.timestamp).forEach((story) => {
                        const storyElement = document.createElement('div');
                        storyElement.className = 'story-item';
                        storyElement.innerHTML = `
                            <div class="story-avatar">${story.avatar}</div>
                            <div class="story-username">${story.username}</div>
                        `;
                        storyElement.addEventListener('click', () => openStoryModal(story));
                        storiesFeed.appendChild(storyElement);
                        storiesList.appendChild(storyElement.cloneNode(true));
                    });
                });
            });
        }

        function handleCreateStory(e) {
            e.preventDefault();
            
            const text = document.getElementById('storyText').value;
            
            if (!text) {
                alert('Please add text to your story');
                return;
            }
            
            const now = Date.now();
            const storyId = db.ref('stories').push().key;
            const newStory = {
                id: storyId,
                userId: currentUser.uid,
                username: currentUser.username,
                avatar: currentUser.avatar,
                text: text,
                timestamp: now,
                expiresAt: now + (24 * 60 * 60 * 1000), // 24 hours
                replies: 0
            };
            
            db.ref('stories/' + storyId).set(newStory)
                .then(() => {
                    document.getElementById('storyForm').reset();
                    alert('Story added successfully!');
                    loadStories(); // Reload to show immediately
                })
                .catch((error) => {
                    alert('Error creating story: ' + error.message);
                });
        }

        // Story Modal Functions
        function openStoryModal(story) {
            currentStoryId = story.id;
            document.getElementById('storyUsername').textContent = story.username + "'s Story";
            document.getElementById('storyContent').innerHTML = `<p>${story.text}</p>`;
            document.getElementById('storyModal').style.display = 'flex';
            loadStoryReplies(story.id);
        }

        function closeStoryModal() {
            document.getElementById('storyModal').style.display = 'none';
            currentStoryId = null;
        }

        function addStoryReply() {
            const input = document.getElementById('storyReplyInput');
            const content = input.value.trim();
            if (!content) return;
            
            const replyId = db.ref(`storyReplies/${currentStoryId}`).push().key;
            db.ref(`storyReplies/${currentStoryId}/${replyId}`).set({
                id: replyId,
                storyId: currentStoryId,
                userId: currentUser.uid,
                username: currentUser.username,
                fullName: currentUser.fullName,
                avatar: currentUser.avatar,
                content,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                db.ref(`stories/${currentStoryId}/replies`).transaction(replies => (replies || 0) + 1);
                input.value = '';
            });
        }

        function loadStoryReplies(storyId) {
            const container = document.getElementById('storyReplies');
            db.ref(`storyReplies/${storyId}`).orderByChild('timestamp').on('value', (snap) => {
                container.innerHTML = '';
                snap.forEach((child) => {
                    const reply = child.val();
                    const replyEl = createReplyElement(reply);
                    container.appendChild(replyEl);
                });
            });
        }

        function createReplyElement(reply) {
            const el = document.createElement('div');
            el.className = 'comment-item';
            const time = new Date(reply.timestamp).toLocaleString();
            el.innerHTML = `
                <div class="comment-header">
                    <div class="comment-avatar">${reply.avatar}</div>
                    <div class="comment-author">${reply.fullName}</div>
                    <div class="comment-time">${time}</div>
                </div>
                <div class="comment-content">${reply.content}</div>
            `;
            return el;
        }

        // Notifications Management
        function loadNotifications() {
            const notificationsList = document.getElementById('notificationsList');
            notificationsList.innerHTML = '<div class="loading">Loading notifications...</div>';
            
            db.ref(`notifications/${currentUser.uid}`).orderByChild('timestamp').limitToLast(20).on('value', (snap) => {
                notificationsList.innerHTML = '';
                
                const notifs = [];
                snap.forEach((child) => {
                    const notif = child.val();
                    notif.id = child.key;
                    notifs.push(notif);
                });
                
                notifs.sort((a, b) => b.timestamp - a.timestamp);
                
                notifs.forEach((notif) => {
                    const fromUser = users[notif.from];
                    if (!fromUser) return;
                    
                    const notifElement = document.createElement('div');
                    notifElement.className = 'notification-item';
                    notifElement.innerHTML = `
                        <div class="notification-avatar">${fromUser.avatar}</div>
                        <div class="notification-content">
                            <div class="notification-text">${notif.text}</div>
                            <div class="notification-time">${new Date(notif.timestamp).toLocaleString()}</div>
                        </div>
                        <div class="notification-actions">
                            ${notif.type === 'friend_request' ? `
                                <button class="btn btn-success btn-sm" onclick="acceptFriend('${notif.from}')">Accept</button>
                                <button class="btn btn-danger btn-sm" onclick="declineFriend('${notif.from}')">Decline</button>
                            ` : ''}
                        </div>
                    `;
                    notificationsList.appendChild(notifElement);
                });
                
                if (notifs.length === 0) {
                    notificationsList.innerHTML = `
                        <div class="no-contacts">
                            <i class="fas fa-bell" style="font-size: 48px; color: var(--text-secondary); margin-bottom: 10px;"></i>
                            <p>No notifications yet.</p>
                        </div>
                    `;
                }
            });
        }

        // Messaging functions
        function loadMessagesContacts() {
            const contactsList = document.getElementById('contactsList');
            contactsList.innerHTML = '<div class="loading">Loading contacts...</div>';
            
            db.ref(`friends/${currentUser.uid}`).on('value', (snap) => {
                contactsList.innerHTML = '';
                
                if (!snap.exists()) {
                    contactsList.innerHTML = `
                        <div class="no-contacts">
                            <i class="fas fa-user-friends" style="font-size: 48px; color: var(--text-secondary); margin-bottom: 10px;"></i>
                            <p>You don't have any friends yet. Add friends to chat!</p>
                        </div>
                    `;
                    return;
                }
                
                snap.forEach((child) => {
                    const uid = child.key;
                    const user = users[uid];
                    if (user) {
                        const contactElement = document.createElement('div');
                        contactElement.className = 'contact-item';
                        contactElement.dataset.uid = uid;
                        contactElement.innerHTML = `
                            <div class="avatar-container">
                                <div class="contact-avatar">${user.avatar}</div>
                            </div>
                            <div class="contact-info">
                                <div class="contact-name">${user.fullName}</div>
                                <div class="contact-last-msg">Start chatting!</div>
                            </div>
                        `;
                        
                        contactElement.addEventListener('click', () => {
                            selectChat({uid, ...user});
                            document.querySelectorAll('.contact-item').forEach(i => i.classList.remove('active'));
                            contactElement.classList.add('active');
                        });
                        
                        setupLongPress(contactElement, () => deleteChat(uid));
                        
                        contactsList.appendChild(contactElement);
                    }
                });
            });
        }

        function setupLongPress(element, callback) {
            let pressTimer;
            element.addEventListener('touchstart', () => {
                pressTimer = setTimeout(callback, 800);
            });
            element.addEventListener('touchend', () => clearTimeout(pressTimer));
            element.addEventListener('touchmove', () => clearTimeout(pressTimer));
            element.addEventListener('mousedown', () => {
                pressTimer = setTimeout(callback, 800);
            });
            element.addEventListener('mouseup', () => clearTimeout(pressTimer));
            element.addEventListener('mouseleave', () => clearTimeout(pressTimer));
        }

        function selectChat(contact) {
            currentChatUser = contact;
            
            const chatWindow = document.getElementById('chatWindow');
            chatWindow.innerHTML = `
                <div class="chat-header">
                    <div class="avatar-container">
                        <div class="contact-avatar">${contact.avatar}</div>
                    </div>
                    <div class="chat-header-info">
                        <h4>${contact.fullName}</h4>
                        <p>Last seen: ${new Date(contact.lastSeen).toLocaleString()}</p>
                    </div>
                    <button class="btn btn-sm btn-warning" onclick="toggleBlock('${contact.uid}')">Block/Unblock</button>
                </div>
                <div class="chat-messages" id="chatMessages">
                    <div class="loading">Loading messages...</div>
                </div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" placeholder="Type a message..." id="chatInput">
                    <button class="send-btn" id="sendBtn"><i class="fas fa-paper-plane"></i></button>
                </div>
            `;
            
            if (currentMessagesRef) {
                currentMessagesRef.off();
            }
            
            const chatId = getChatId(currentUser.uid, contact.uid);
            currentMessagesRef = db.ref(`messages/${chatId}`);
            
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            
            currentMessagesRef.orderByChild('timestamp').on('child_added', (snap) => {
                const msg = snap.val();
                const isSent = msg.sender === currentUser.uid;
                const time = new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
                
                const messageElement = document.createElement('div');
                messageElement.className = `message ${isSent ? 'sent' : 'received'}`;
                messageElement.innerHTML = `
                    <div class="message-bubble">${msg.text}${isSent ? ` <button onclick="deleteMessage('${snap.key}', '${chatId}')"><i class="fas fa-trash" style="font-size: 10px; color: #fff;"></i></button>` : ''}</div>
                    <span class="message-time">${time}</span>
                `;
                
                if (isSent) {
                    setupLongPress(messageElement.querySelector('.message-bubble'), () => deleteMessage(snap.key, chatId));
                }
                
                chatMessages.appendChild(messageElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });
            
            // Setup send listeners
            const sendBtn = document.getElementById('sendBtn');
            const chatInput = document.getElementById('chatInput');
            sendBtn.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            
            if (!text) return;
            
            currentMessagesRef.push({
                text,
                sender: currentUser.uid,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            
            input.value = '';
        }

        function deleteMessage(messageId, chatId) {
            if (confirm('Are you sure you want to delete this message?')) {
                db.ref(`messages/${chatId}/${messageId}`).remove();
            }
        }

        function deleteChat(uid) {
            if (confirm('Are you sure you want to delete this entire chat?')) {
                const chatId = getChatId(currentUser.uid, uid);
                db.ref(`messages/${chatId}`).remove();
                if (currentChatUser && currentChatUser.uid === uid) {
                    document.getElementById('chatWindow').innerHTML = `
                        <div class="no-chat-selected">
                            <i class="fas fa-comment-dots" style="font-size: 48px; color: var(--text-secondary); margin-bottom: 10px;"></i>
                            <p>Select a friend to start chatting.</p>
                        </div>
                    `;
                    currentChatUser = null;
                    if (currentMessagesRef) currentMessagesRef.off();
                }
            }
        }

        function toggleBlock(uid) {
            db.ref(`blocked/${currentUser.uid}/${uid}`).once('value').then(snap => {
                const isBlocked = snap.val();
                db.ref(`blocked/${currentUser.uid}/${uid}`).set(!isBlocked);
                alert(isBlocked ? 'User unblocked!' : 'User blocked!');
            });
        }

        function openChatWith(uid) {
            const contact = {uid, ...users[uid]};
            showSection('messages');
            selectChat(contact);
        }

        function getChatId(uid1, uid2) {
            return uid1 < uid2 ? `${uid1}_${uid2}` : `${uid2}_${uid1}`;
        }

        function isOnline(lastSeen) {
            return Date.now() - lastSeen < 5 * 60 * 1000;
        }

        // EMS functions
        function validateUserSession() {
            if (!currentUser) {
                console.error("No user session found");
                handleLogout();
                return false;
            }
            return true;
        }

        function handleAddStudent(e) {
            e.preventDefault();
            if (!validateUserSession()) return;
            
            const name = document.getElementById('studentName').value;
            const grade = document.getElementById('studentGrade').value;
            const phone = document.getElementById('studentPhone').value;
            const fee = document.getElementById('studentFee').value;
            
            if (!phone.match(/^03\d{9}$/)) {
                alert('Please enter a valid Pakistani phone number (03XXXXXXXXX)');
                return;
            }
            
            const newStudent = {
                id: generateId(),
                name,
                grade: parseInt(grade),
                phone,
                fee: parseInt(fee),
                admissionDate: new Date().toISOString().split('T')[0],
                createdBy: currentUser.username || currentUser.email
            };
            
            students.push(newStudent);
            saveUserData();
            
            const branding = currentUser.schoolName ? `${currentUser.schoolName}\nContact: ${currentUser.schoolPhone || currentUser.phone}\n` : '';
            const message = `Assalam-o-Alaikum! ${name} has been admitted to Grade ${grade}. Monthly fee: PKR ${fee}. \n${branding}Created by ${currentUser.fullName} (${currentUser.phone})`;
            openWhatsApp(phone, message);
            
            alert('Student added successfully! WhatsApp message ready to send.');
            document.getElementById('studentForm').reset();
            loadStudentsTable();
            updateStudentDropdown();
            updateDashboard();
        }

        function loadStudentsTable() {
            if (!validateUserSession()) return;
            
            const tbody = document.querySelector('#studentsTable tbody');
            tbody.innerHTML = '';

            const sortedStudents = [...students].sort((a, b) => a.grade - b.grade || a.name.localeCompare(b.name));
            
            sortedStudents.forEach(student => {
                // Calculate fee status for this month
                const currentMonth = new Date().toISOString().slice(0, 7);
                const studentFees = fees.filter(f => f.studentId === student.id && f.month === currentMonth);
                const totalPaid = studentFees.reduce((sum, fee) => sum + fee.amount, 0);
                const remaining = student.fee - totalPaid;
                
                let feeStatus = 'Pending';
                let statusClass = 'fee-pending';
                
                if (remaining <= 0) {
                    feeStatus = 'Paid';
                    statusClass = 'fee-paid';
                } else if (totalPaid > 0) {
                    feeStatus = `Partial (PKR ${remaining} due)`;
                    statusClass = 'fee-partial';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.id}</td>
                    <td>${student.name}</td>
                    <td>Grade ${student.grade}</td>
                    <td>${student.phone}</td>
                    <td><span class="currency">${student.fee}</span></td>
                    <td><span class="fee-status ${statusClass}">${feeStatus}</span></td>
                    <td class="action-buttons">
                        <button class="btn btn-danger btn-sm" onclick="deleteStudent('${student.id}')"><i class="fas fa-trash"></i> Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function deleteStudent(id) {
            if (!validateUserSession()) return;
            
            currentAction = 'deleteStudent';
            currentItemId = id;
            openPinModal();
        }

        function updateStudentDropdown() {
            if (!validateUserSession()) return;
            
            const dropdown = document.getElementById('feeStudent');
            dropdown.innerHTML = '<option value="">Select Student</option>';
            
            students.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.name} (Grade ${student.grade}) - PKR ${student.fee}/month`;
                option.setAttribute('data-fee', student.fee);
                dropdown.appendChild(option);
            });
            updateFeeInfo();
        }

        function updateFeeInfo() {
            if (!validateUserSession()) return;
            
            const studentId = document.getElementById('feeStudent').value;
            const month = document.getElementById('feeMonth').value;
            
            const monthlyFeeDisplay = document.getElementById('monthlyFeeDisplay');
            const remainingFeeDisplay = document.getElementById('remainingFeeDisplay');
            const feeAmountInput = document.getElementById('feeAmount');
            
            if (!studentId || !month) {
                monthlyFeeDisplay.textContent = '0';
                remainingFeeDisplay.textContent = '0';
                feeAmountInput.max = null;
                feeAmountInput.value = '';
                return;
            }
            
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            // Calculate already paid amount for this month
            const paidFees = fees.filter(f => f.studentId === studentId && f.month === month);
            const totalPaid = paidFees.reduce((sum, fee) => sum + fee.amount, 0);
            const remaining = student.fee - totalPaid;
            
            // Update displays
            monthlyFeeDisplay.textContent = student.fee;
            remainingFeeDisplay.textContent = remaining < 0 ? 0 : remaining;
            
            // Set max value for fee amount input to the remaining fee
            feeAmountInput.max = remaining < 0 ? 0 : remaining;
            
            // Set default value for amount input (suggest full remaining amount)
            if (remaining > 0) {
                 feeAmountInput.value = remaining;
            } else {
                 feeAmountInput.value = 0;
            }
        }

        function handleFeeCollection(e) {
            e.preventDefault();
            if (!validateUserSession()) return;
            
            const studentId = document.getElementById('feeStudent').value;
            const month = document.getElementById('feeMonth').value;
            const amount = parseInt(document.getElementById('feeAmount').value);
            const datePaid = document.getElementById('feeDate').value;
            
            const student = students.find(s => s.id === studentId);
            if (!student) {
                alert('Please select a valid student');
                return;
            }
            
            // Recalculate remaining fee before processing
            const paidFees = fees.filter(f => f.studentId === studentId && f.month === month);
            const totalPaid = paidFees.reduce((sum, fee) => sum + fee.amount, 0);
            const remaining = student.fee - totalPaid;
            
            if (amount > remaining) {
                alert(`Cannot collect more than the remaining fee amount (PKR ${remaining < 0 ? 0 : remaining})`);
                return;
            }
            
            if (amount <= 0) {
                alert('Please enter a valid amount greater than zero');
                return;
            }
            
            const newFee = {
                id: generateId(),
                studentId,
                studentName: student.name,
                month,
                amount: amount,
                datePaid,
                collectedBy: currentUser.username || currentUser.email
            };
            
            fees.push(newFee);
            saveUserData();
            
            // WhatsApp message content
            const totalPaidNow = totalPaid + amount;
            const remainingAfterPayment = student.fee - totalPaidNow;
            const status = remainingAfterPayment <= 0 ? 'Fully Paid' : `Partially Paid (PKR ${remainingAfterPayment} due)`;
            const branding = currentUser.schoolName ? `${currentUser.schoolName}\nContact: ${currentUser.schoolPhone || currentUser.phone}\n` : '';
            
            const message = `Fee Receipt - ${student.name}\n${branding}Month: ${month}\nAmount: PKR ${amount}\nStatus: ${status}\nDate: ${datePaid}\nThank you! - Created by ${currentUser.fullName} (${currentUser.phone})`;
            openWhatsApp(student.phone, message);
            
            alert('Fee collected successfully! WhatsApp receipt ready to send.');
            document.getElementById('feeForm').reset();
            document.getElementById('feeMonth').valueAsDate = new Date();
            document.getElementById('feeDate').value = new Date().toISOString().split('T')[0];
            loadFeesTable();
            loadStudentsTable();
            updateDashboard();
            updateFeeInfo();
        }

        function loadFeesTable() {
            if (!validateUserSession()) return;
            
            const tbody = document.querySelector('#feesTable tbody');
            tbody.innerHTML = '';
            
            const sortedFees = [...fees].sort((a, b) => new Date(b.datePaid) - new Date(a.datePaid));
            
            sortedFees.forEach(fee => {
                const student = students.find(s => s.id === fee.studentId);
                if (!student) {
                    const rowDeleted = document.createElement('tr');
                    rowDeleted.innerHTML = `
                        <td>${fee.id}</td>
                        <td><span style="color:var(--danger); font-style:italic;">[DELETED] ${fee.studentName}</span></td>
                        <td>${fee.month}</td>
                        <td><span class="currency">${fee.amount}</span></td>
                        <td><span class="fee-status fee-pending">Archived</span></td>
                        <td>${fee.datePaid}</td>
                        <td class="action-buttons">
                            <button class="btn btn-danger btn-sm" onclick="deleteFee('${fee.id}')"><i class="fas fa-trash"></i> Delete</button>
                        </td>
                    `;
                    tbody.appendChild(rowDeleted);
                    return;
                }
                
                const totalMonthlyFee = student.fee;
                const paidFees = fees.filter(f => f.studentId === fee.studentId && f.month === fee.month);
                const totalPaidForMonth = paidFees.reduce((sum, f) => sum + f.amount, 0);
                const remaining = totalMonthlyFee - totalPaidForMonth;
                
                let status = 'Partial';
                let statusClass = 'fee-partial';
                
                if (remaining <= 0) {
                    status = 'Paid';
                    statusClass = 'fee-paid';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${fee.id}</td>
                    <td>${fee.studentName}</td>
                    <td>${fee.month}</td>
                    <td><span class="currency">${fee.amount}</span></td>
                    <td><span class="fee-status ${statusClass}">${status}</span></td>
                    <td>${fee.datePaid}</td>
                    <td class="action-buttons">
                        <button class="btn btn-whatsapp btn-sm" onclick="resendReceipt('${fee.id}')"><i class="fab fa-whatsapp"></i> Resend</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteFee('${fee.id}')"><i class="fas fa-trash"></i> Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Update recent fees table on dashboard
            const recentFeesTbody = document.querySelector('#recentFeesTable tbody');
            recentFeesTbody.innerHTML = '';
            
            const recentFees = sortedFees.slice(0, 5);
            recentFees.forEach(fee => {
                const student = students.find(s => s.id === fee.studentId);
                if (!student) return;
                
                const paidFees = fees.filter(f => f.studentId === fee.studentId && f.month === fee.month);
                const totalPaid = paidFees.reduce((sum, f) => sum + f.amount, 0);
                const remaining = student.fee - totalPaid;

                let status = remaining <= 0 ? 'Paid' : 'Partial';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${fee.studentName}</td>
                    <td><span class="currency">${fee.amount}</span></td>
                    <td><span class="fee-status ${status === 'Paid' ? 'fee-paid' : 'fee-partial'}">${status}</span></td>
                    <td>${fee.datePaid}</td>
                `;
                recentFeesTbody.appendChild(row);
            });
        }

        function resendReceipt(feeId) {
            if (!validateUserSession()) return;
            
            const fee = fees.find(f => f.id === feeId);
            const student = students.find(s => s.id === fee.studentId);
            
            if (!student) {
                alert("Student record not found. Cannot resend.");
                return;
            }

            const paidFees = fees.filter(f => f.studentId === fee.studentId && f.month === fee.month);
            const totalPaid = paidFees.reduce((sum, f) => sum + f.amount, 0);
            const remaining = student.fee - totalPaid;
            const status = remaining <= 0 ? 'Fully Paid' : `Partially Paid (PKR ${remaining} due)`;
            const branding = currentUser.schoolName ? `${currentUser.schoolName}\nContact: ${currentUser.schoolPhone || currentUser.phone}\n` : '';
            
            const message = `Fee Receipt - ${student.name}\n${branding}Month: ${fee.month}\nAmount: PKR ${fee.amount}\nStatus: ${status}\nDate: ${fee.datePaid}\nThank you! - Created by ${currentUser.fullName} (${currentUser.phone})`;
            openWhatsApp(student.phone, message);
            
            alert('WhatsApp receipt ready to send!');
        }

        function deleteFee(id) {
            if (!validateUserSession()) return;
            
            currentAction = 'deleteFee';
            currentItemId = id;
            openPinModal();
        }

        // Attendance Management
        function toggleAttendance(studentId, isChecked) {
            if (!validateUserSession()) return;
            
            const student = students.find(s => s.id === studentId);
            if (!student) return;

            const date = document.getElementById('attendanceDate').value;
            const alertDiv = document.getElementById(`alert-status-${studentId}`);
            
            // Update the visual status
            if (isChecked) {
                alertDiv.innerHTML = '<span class="status-badge status-present">Present</span>';
            } else {
                alertDiv.innerHTML = '<span class="status-badge status-absent">Absent</span>';
                
                // Immediate WhatsApp Alert for Absent Student
                const branding = currentUser.schoolName ? `${currentUser.schoolName}\nContact: ${currentUser.schoolPhone || currentUser.phone}\n` : '';
                const message = `Attendance Alert: ${student.name} was marked absent on ${date}. Please contact the academy for more information. \n${branding}Created by ${currentUser.fullName} (${currentUser.phone})`;
                openWhatsApp(student.phone, message);
            }
        }

        function loadAttendanceForm() {
            if (!validateUserSession()) return;
            
            const container = document.getElementById('attendanceList');
            container.innerHTML = '';
            
            if (students.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--text-secondary);">No students available. Please add students first.</p>';
                return;
            }
            
            const date = document.getElementById('attendanceDate').value;
            const existingRecord = attendance.find(a => a.date === date);

            // Group students by grade
            const studentsByGrade = students.reduce((acc, student) => {
                const grade = student.grade;
                if (!acc[grade]) acc[grade] = [];
                acc[grade].push(student);
                return acc;
            }, {});
            
            // Sort grades numerically
            const sortedGrades = Object.keys(studentsByGrade).sort((a, b) => parseInt(a) - parseInt(b));

            sortedGrades.forEach(grade => {
                const gradeContainer = document.createElement('div');
                gradeContainer.style.marginBottom = '20px';
                gradeContainer.innerHTML = `<h4 style="color: var(--secondary); border-bottom: 1px dashed var(--border); padding-bottom: 5px; margin-bottom: 15px;">Grade ${grade}</h4>`;
                
                // Sort students alphabetically within the grade
                studentsByGrade[grade].sort((a, b) => a.name.localeCompare(b.name));

                studentsByGrade[grade].forEach(student => {
                    // Determine initial status: checked if present in existing record, or default to present (true)
                    const isPresent = existingRecord ? existingRecord.present.includes(student.id) : true;
                    
                    const div = document.createElement('div');
                    div.style.display = 'flex';
                    div.style.alignItems = 'center';
                    div.style.marginBottom = '10px';
                    div.style.padding = '10px';
                    div.style.border = '1px solid var(--border)';
                    div.style.borderRadius = '6px';
                    div.style.backgroundColor = 'var(--surface)'; 
                    div.setAttribute('data-student-id', student.id);
                    
                    const statusText = isPresent ? 'Present' : 'Absent';
                    const statusClass = isPresent ? 'status-present' : 'status-absent';

                    div.innerHTML = `
                        <input type="checkbox" id="attendance-${student.id}" class="attendance-checkbox" ${isPresent ? 'checked' : ''} style="display: none;">
                        <label style="margin: 0; flex-grow: 1; color: var(--text-primary); font-weight: 500;">${student.name}</label>
                        <div id="alert-status-${student.id}" style="margin-right: 15px;">
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        <div class="action-buttons" style="gap: 5px;">
                            <button type="button" class="btn btn-sm btn-success attendance-toggle-btn" data-id="${student.id}" data-action="present" title="Mark Present (✅)" style="padding: 8px; width: 35px; height: 35px;"><i class="fas fa-check"></i></button>
                            <button type="button" class="btn btn-sm btn-danger attendance-toggle-btn" data-id="${student.id}" data-action="absent" title="Mark Absent (❌)" style="padding: 8px; width: 35px; height: 35px;"><i class="fas fa-times"></i></button>
                        </div>
                    `;
                    
                    gradeContainer.appendChild(div);
                });
                
                container.appendChild(gradeContainer);
            });
            
            // Attach event listeners for the new toggle buttons
            document.querySelectorAll('.attendance-toggle-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const studentId = this.getAttribute('data-id');
                    const action = this.getAttribute('data-action');
                    const checkbox = document.getElementById(`attendance-${studentId}`);
                    
                    if (action === 'present') {
                        if (!checkbox.checked) {
                            checkbox.checked = true;
                            toggleAttendance(studentId, true); 
                        }
                    } else if (action === 'absent') {
                        if (checkbox.checked) {
                            checkbox.checked = false;
                            toggleAttendance(studentId, false); 
                        }
                    }
                });
            });
        }

        function handleAttendance(e) {
            e.preventDefault();
            if (!validateUserSession()) return;
            
            const date = document.getElementById('attendanceDate').value;
            
            // Remove existing attendance before adding new one
            attendance = attendance.filter(a => a.date !== date);
            
            const presentStudents = [];
            const absentStudents = [];
            
            students.forEach(student => {
                // Read state from the hidden checkbox
                const checkbox = document.getElementById(`attendance-${student.id}`);
                if (checkbox && checkbox.checked) {
                    presentStudents.push(student.id);
                } else if (checkbox) {
                    absentStudents.push(student.id);
                }
            });
            
            if (students.length === 0) {
                 alert('No students to mark attendance for.');
                 return;
            }

            const newAttendance = {
                id: generateId(),
                date,
                present: presentStudents,
                absent: absentStudents,
                markedBy: currentUser.username || currentUser.email
            };
            
            attendance.push(newAttendance);
            saveUserData();
            
            alert('Attendance saved successfully! Absent student alerts were sent via WhatsApp upon marking.');
            
            // Reload form to reflect newly saved data/reset the state
            loadAttendanceForm(); 
            loadAttendanceTable();
            updateDashboard();
        }

        function resendAbsentAlerts(attendanceId) {
            if (!validateUserSession()) return;
            
            const record = attendance.find(a => a.id === attendanceId);
            
            if (!record) {
                alert("Attendance record not found.");
                return;
            }
            
            record.absent.forEach(studentId => {
                const student = students.find(s => s.id === studentId);
                if (student) {
                    const branding = currentUser.schoolName ? `${currentUser.schoolName}\nContact: ${currentUser.schoolPhone || currentUser.phone}\n` : '';
                    const message = `Attendance Alert: ${student.name} was absent on ${record.date}. Please contact the academy for more info. \n${branding}Created by ${currentUser.fullName} (${currentUser.phone})`;
                    openWhatsApp(student.phone, message);
                }
            });
            
            alert('WhatsApp alerts ready to send for absent students!');
        }

        function deleteAttendance(id) {
            if (!validateUserSession()) return;
            
            currentAction = 'deleteAttendance';
            currentItemId = id;
            openPinModal();
        }
        
        function loadAttendanceTable() {
            if (!validateUserSession()) return;
            
            const tbody = document.querySelector('#attendanceTable tbody');
            tbody.innerHTML = '';
            
            const sortedAttendance = [...attendance].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedAttendance.forEach(record => {
                const totalStudentsOnDate = students.length > 0 ? students.length : (record.present.length + record.absent.length);
                const percentage = totalStudentsOnDate > 0 ? Math.round((record.present.length / totalStudentsOnDate) * 100) : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.date}</td>
                    <td><span class="status-badge status-present">${record.present.length}</span></td>
                    <td><span class="status-badge status-absent">${record.absent.length}</span></td>
                    <td>${percentage}%</td>
                    <td class="action-buttons">
                        <button class="btn btn-whatsapp btn-sm" onclick="resendAbsentAlerts('${record.id}')"><i class="fab fa-whatsapp"></i> Resend Alerts</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteAttendance('${record.id}')"><i class="fas fa-trash"></i> Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Update recent attendance table on dashboard
            const recentAttendanceTbody = document.querySelector('#recentAttendanceTable tbody');
            recentAttendanceTbody.innerHTML = '';
            
            const recentAttendance = sortedAttendance.slice(0, 5);
            recentAttendance.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.date}</td>
                    <td>${record.present.length}</td>
                    <td>${record.absent.length}</td>
                `;
                recentAttendanceTbody.appendChild(row);
            });
        }

        // WhatsApp Integration
        function openWhatsApp(phone, message) {
            let cleanPhone = phone.replace(/\D/g, '');
            if (cleanPhone.startsWith('03')) {
                cleanPhone = '92' + cleanPhone.substring(1);
            }
            
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/${cleanPhone}?text=${encodedMessage}`;
            
            window.open(whatsappUrl, '_blank');
        }

        // PIN Protected Actions
        function openPinModal() {
            if (!validateUserSession()) return;
            
            document.getElementById('pinModal').style.display = 'flex';
            document.getElementById('pinInput').value = '';
            document.getElementById('pinInput').focus();
        }

        function closePinModal() {
            document.getElementById('pinModal').style.display = 'none';
            currentAction = null;
            currentItemId = null;
        }

        function verifyPin() {
            if (!validateUserSession()) return;
            
            const pin = document.getElementById('pinInput').value;
            
            if (!currentUser || !currentUser.pin) {
                alert('No admin PIN found. Login again.');
                closePinModal();
                return;
            }

            if (pin === currentUser.pin) {
                executeProtectedAction();
                closePinModal();
            } else {
                alert('Incorrect PIN. Please try again.');
                document.getElementById('pinInput').value = '';
                document.getElementById('pinInput').focus();
            }
        }

        function executeProtectedAction() {
            if (!currentItemId || !validateUserSession()) return;

            switch(currentAction) {
                case 'deleteStudent':
                    if (confirm('Are you sure you want to PERMANENTLY delete this student? Fee and attendance history will remain but be marked as archived.')) {
                        students = students.filter(s => s.id !== currentItemId);
                        saveUserData();
                        loadStudentsTable();
                        updateStudentDropdown();
                        updateDashboard();
                        alert('Student deleted successfully');
                    }
                    break;
                case 'deleteFee':
                    if (confirm('Are you sure you want to PERMANENTLY delete this fee receipt?')) {
                        fees = fees.filter(f => f.id !== currentItemId);
                        saveUserData();
                        loadFeesTable();
                        loadStudentsTable();
                        updateDashboard();
                        alert('Fee record deleted successfully');
                    }
                    break;
                case 'deleteAttendance':
                    if (confirm('Are you sure you want to PERMANENTLY delete this attendance record?')) {
                        attendance = attendance.filter(a => a.id !== currentItemId);
                        saveUserData();
                        loadAttendanceTable();
                        updateDashboard();
                        alert('Attendance record deleted successfully');
                    }
                    break;
                default:
                    alert('Action not defined for PIN protection.');
            }
        }

        // EMS Dashboard Update
        function updateDashboard() {
            if (!validateUserSession()) return;
            
            document.getElementById('totalStudents').textContent = students.length;
            
            const currentMonth = new Date().toISOString().slice(0, 7);
            const monthlyFees = fees.filter(f => f.month === currentMonth)
                                   .reduce((sum, fee) => sum + fee.amount, 0);
            document.getElementById('feesCollected').textContent = monthlyFees;
            
            const today = new Date().toISOString().split('T')[0];
            const todayRecord = attendance.find(a => a.date === today);
            
            if (todayRecord) {
                const totalRegisteredStudents = students.length; 
                let percentage = 0;
                if (totalRegisteredStudents > 0) {
                     percentage = Math.round((todayRecord.present.length / totalRegisteredStudents) * 100);
                }
                document.getElementById('todayAttendance').textContent = `${percentage}%`;
            } else {
                document.getElementById('todayAttendance').textContent = 'Not taken';
            }
            
            let pendingCount = 0;
            students.forEach(student => {
                const studentFees = fees.filter(f => f.studentId === student.id && f.month === currentMonth);
                const totalPaid = studentFees.reduce((sum, fee) => sum + fee.amount, 0);
                if (totalPaid < student.fee) {
                    pendingCount++;
                }
            });
            document.getElementById('pendingFees').textContent = pendingCount;
        }

        // Utility functions
        function generateId() {
            return Math.random().toString(36).substr(2, 9).toUpperCase();
        }
    </script>
</body>
</html>