<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Popcorn - EMS</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        :root {
            --primary: #1877f2;
            --primary-dark: #0d65d8;
            --secondary: #05a5d1;
            --success: #42b72a;
            --danger: #ea3c53;
            --warning: #ffba00;
            --background: #f0f2f5;
            --surface: #ffffff;
            --text-primary: #050505;
            --text-secondary: #65676b;
            --border: #dddfe2;
            --sidebar-width: 280px;
            --header-height: 56px;
            --shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            --shadow-hover: 0 1px 4px rgba(0, 0, 0, 0.2);
            --radius: 8px;
            --transition: all 0.2s ease-in-out;
            --animation-duration: 0.3s;
        }

        body {
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .shadow-md {
            box-shadow: var(--shadow);
        }

        .shadow-hover {
            transition: var(--transition);
        }

        .shadow-hover:hover {
            box-shadow: var(--shadow-hover);
        }

        /* Auth Section */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: var(--background);
            padding: 20px;
            position: relative;
        }

        .auth-form {
            background: var(--surface);
            padding: 50px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 450px;
            border: 1px solid var(--border);
            position: relative;
            z-index: 1;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 35px;
        }

        .auth-header h1 {
            color: var(--primary-dark);
            font-size: 36px;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .auth-header p {
            color: var(--text-secondary);
            font-size: 16px;
            opacity: 0.8;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 30px;
            border-radius: var(--radius);
            overflow: hidden;
            background: #f0f2f5;
            border: 1px solid var(--border);
        }

        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 16px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            color: var(--text-secondary);
            position: relative;
        }

        .auth-tab::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--secondary);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .auth-tab.active {
            background: #e4e6eb;
            color: var(--text-primary);
        }

        .auth-tab.active::after {
            transform: scaleX(1);
        }

        .form-group {
            margin-bottom: 25px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 14px;
            opacity: 0.9;
        }

        .form-control {
            width: 100%;
            padding: 16px 20px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 16px;
            transition: var(--transition);
            background: #f0f2f5;
            color: var(--text-primary);
            position: relative;
        }

        .form-control::placeholder {
            color: rgba(0, 0, 0, 0.5);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(24, 119, 242, 0.1);
            background: #f0f2f5;
        }

        .btn {
            display: inline-block;
            background: var(--primary);
            color: white;
            border: none;
            padding: 16px 28px;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: var(--transition);
            text-align: center;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .btn-success {
            background: var(--success);
        }

        .btn-success:hover {
            background: #5cb860;
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-danger:hover {
            background: #e53935;
        }

        .btn-warning {
            background: var(--warning);
        }

        .btn-warning:hover {
            background: #fbc02d;
        }

        .btn-whatsapp {
            background: #25D366;
        }

        .btn-whatsapp:hover {
            background: #128C7E;
        }

        /* Main App */
        #appSection {
            display: none;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
            position: relative;
            background: var(--background);
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--surface);
            color: var(--text-primary);
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            transition: var(--transition);
            z-index: 1000;
            box-shadow: var(--shadow);
            transform: translateX(-100%);
            overflow-y: auto;
            border-right: 1px solid var(--border);
        }
        
        .sidebar.open {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
            color: var(--secondary);
            position: sticky;
            top: 0;
            background: inherit;
        }
        
        .logo-title {
            display: flex;
            align-items: center;
        }

        .logo-title i {
            color: var(--primary);
            margin-right: 12px;
        }

        .sidebar-header h2 {
            font-size: 22px;
            margin-left: 10px;
            font-weight: 600;
            color: var(--primary);
        }
        
        .sidebar-close-btn {
            background: #e4e6eb;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: var(--transition);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .sidebar-close-btn:hover {
            background: var(--danger);
            color: white;
            transform: rotate(90deg);
        }

        .sidebar-menu {
            list-style: none;
            padding:20px 0;
        }

        .sidebar-menu li {
            padding: 16px 30px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            font-weight: 500;
            color: var(--text-secondary);
            position: relative;
            overflow: hidden;
        }

        .sidebar-menu li::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--primary);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .sidebar-menu li i {
            margin-right: 15px;
            font-size: 18px;
            width: 24px;
            text-align: center;
            transition: var(--transition);
        }

        .sidebar-menu li:hover {
            background: #e4e6eb;
            color: var(--text-primary);
            padding-left: 35px;
        }

        .sidebar-menu li:hover::before {
            transform: scaleY(1);
        }

        .sidebar-menu li:hover i {
            transform: scale(1.1);
        }

        .sidebar-menu li.active {
            background: #e4e6eb;
            color: var(--text-primary);
            border-left: 4px solid var(--primary);
        }

        .sidebar-menu li.active::before {
            transform: scaleY(1);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 30px;
            margin-left: 0;
            transition: var(--transition);
        }
        
        .sidebar-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            transition: var(--transition);
        }
        
        .sidebar-backdrop.open {
            display: block;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 35px;
            padding: 20px 30px;
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            position: sticky; 
            top: 0;
            z-index: 900;
            border: 1px solid var(--border);
        }
        
        .header-left-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .menu-toggle {
            font-size: 20px;
            cursor: pointer;
            background: var(--surface);
            color: var(--text-primary);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .menu-toggle:hover {
            background: #e4e6eb;
            transform: rotate(90deg);
        }
        
        #pageTitle {
            font-size: 18px;
            color: var(--primary);
            font-weight: 600;
            margin: 0;
            flex-grow: 1;
            text-align: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: #e4e6eb;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .user-avatar:hover {
            transform: scale(1.1);
        }
        
        .user-info div:last-child {
            color: var(--text-secondary);
            display: flex;
            flex-direction: column; 
            gap: 5px;
        }
        
        /* Logout button specific styling on small screens */
        @media (max-width: 991px) {
            .user-info div:last-child > div {
                display: none;
            }
            #logoutBtn {
                margin: 0;
                padding: 5px 10px;
            }
            .user-info div:last-child {
                display: flex;
                flex-direction: column;
                justify-content: center;
            }
        }
        
        /* Content Sections */
        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            margin-bottom: 30px;
            position: relative;
        }

        .section-header::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 0;
            width: 50px;
            height: 3px;
            background: var(--primary);
            border-radius: 2px;
        }

        .section-header h2 {
            font-size: 28px;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-weight: 700;
        }

        .section-header p {
            color: var(--text-secondary);
            font-size: 15px;
            opacity: 0.8;
        }

        /* Cards */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 35px;
        }

        .card {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 30px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: var(--shadow-hover);
        }

        .card-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #e4e6eb;
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 20px;
            transition: var(--transition);
        }

        .card:hover .card-icon {
            background: #e4e6eb;
            transform: rotate(360deg);
        }

        .card h3 {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
        }

        .card-value {
            font-size: 32px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 8px;
            color: var(--primary);
        }

        .card-desc {
            font-size: 14px;
            color: var(--text-secondary);
            opacity: 0.8;
        }

        /* Forms */
        .form-container {
            background: var(--surface);
            padding: 30px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 35px;
            border: 1px solid var(--border);
        }
        
        .form-container h3 {
             color: var(--text-primary);
             margin-bottom: 25px;
             border-bottom: 1px solid var(--border);
             padding-bottom: 15px;
             font-weight: 600;
             position: relative;
        }

        .form-container h3::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 40px;
            height: 2px;
            background: var(--primary);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        /* Tables */
        .table-container {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 35px;
            border: 1px solid var(--border);
            overflow: hidden;
        }
        
        .table-container h3 {
             padding: 20px 25px;
             color: var(--text-primary);
             font-weight: 600;
             background: #f0f2f5;
             border-bottom: 1px solid var(--border);
        }

        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f0f2f5;
            padding: 16px 25px;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border);
            text-transform: uppercase;
            font-size: 13px;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 15px 25px;
            border-bottom: 1px solid var(--border);
            color: var(--text-primary);
            font-size: 15px;
            transition: var(--transition);
        }

        tr:nth-child(even) {
            background: #f0f2f5;
        }

        tr:hover {
            background: #e4e6eb;
            transform: scale(1.01);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .btn-sm {
            padding: 10px 15px;
            font-size: 13px;
            border-radius: 6px;
            text-transform: none;
            transition: var(--transition);
        }

        .btn-sm:hover {
            transform: translateY(-1px);
        }

        .loading {
            text-align: center;
            padding: 30px;
            color: var(--text-secondary);
            font-style: italic;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(0, 0, 0, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--surface);
            padding: 35px;
            border-radius: var(--radius);
            width: 450px;
            max-width: 90%;
            box-shadow: var(--shadow-hover);
            border: 1px solid var(--border);
            transform: scale(0.9);
            transition: var(--transition);
        }

        .modal-content.show {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h3 {
            color: var(--primary);
            font-size: 24px;
            font-weight: 600;
        }

        .close-modal {
            font-size: 28px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: var(--transition);
            padding: 5px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-modal:hover {
            background: #e4e6eb;
            color: var(--danger);
        }

        /* Status Indicators */
        .status-badge {
            display: inline-block;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .status-present {
            background: rgba(66, 183, 42, 0.2);
            color: var(--success);
            border: 1px solid rgba(66, 183, 42, 0.3);
        }

        .status-absent {
            background: rgba(234, 60, 83, 0.2);
            color: var(--danger);
            border: 1px solid rgba(234, 60, 83, 0.3);
        }

        .status-pending {
            background: rgba(255, 186, 0, 0.2);
            color: var(--warning);
            border: 1px solid rgba(255, 186, 0, 0.3);
        }

        /* Fee Status */
        .fee-status {
            display: inline-block;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .fee-paid {
            background: rgba(66, 183, 42, 0.2);
            color: var(--success);
            border: 1px solid rgba(66, 183, 42, 0.3);
        }
        
        .fee-partial {
            background: rgba(255, 186, 0, 0.2);
            color: var(--warning);
            border: 1px solid rgba(255, 186, 0, 0.3);
        }
        
        .fee-pending {
            background: rgba(234, 60, 83, 0.2);
            color: var(--danger);
            border: 1px solid rgba(234, 60, 83, 0.3);
        }
        
        /* Currency Styling */
        .currency {
            font-weight: 800;
            color: var(--success);
        }

        .currency::before {
            content: "PKR ";
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        /* WhatsApp Notification */
        .whatsapp-notification {
            background: #25D366;
            color: white;
            padding: 12px 18px;
            border-radius: var(--radius);
            margin-top: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }
        
        .whatsapp-notification:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }
        
        /* Terms and Conditions Styling */
        .terms-container {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: #f9f9f9;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .terms-container h4 {
            margin-bottom: 10px;
            color: var(--primary);
            font-size: 16px;
        }
        
        .terms-container p {
            font-size: 13px;
            line-height: 1.4;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }
        
        .terms-checkbox {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-top: 15px;
            font-size: 14px;
        }
        
        .terms-checkbox input[type="checkbox"] {
            margin-top: 2px;
            accent-color: var(--primary);
        }

        /* Branding Section Styles */
        .branding-container {
            max-width: 700px;
            margin: 0 auto;
        }

        .branding-preview {
            background: #f0f2f5;
            border-radius: var(--radius);
            padding: 25px;
            margin-bottom: 35px;
            box-shadow: var(--shadow);
            border-left: 5px solid var(--secondary);
            font-family: 'Courier New', monospace;
            white-space: pre-line;
            color: var(--text-primary);
            font-size: 15px;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .branding-preview::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--secondary);
        }

        .branding-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        @media (max-width: 768px) {
            .branding-form-row {
                grid-template-columns: 1fr;
            }
        }

        .save-status {
            text-align: center;
            padding: 12px;
            border-radius: var(--radius);
            margin-top: 15px;
            display: none;
            font-weight: 500;
        }

        .save-status.success {
            background: rgba(66, 183, 42, 0.2);
            color: var(--success);
            border: 1px solid rgba(66, 183, 42, 0.3);
            display: block;
        }

        /* Switch Toggle for Settings */
        .switch {
            position: relative;
            display: inline-block;
            width: 70px;
            height: 38px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #f0f2f5;
            border: 1px solid var(--border);
            transition: .4s;
            border-radius: 38px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 30px;
            width: 30px;
            left: 4px;
            bottom: 4px;
            background: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        input:checked + .slider {
            background: var(--success);
            border-color: var(--success);
        }

        input:checked + .slider:before {
            transform: translateX(36px);
        }
        
        /* Responsive Fixes */
        @media (min-width: 992px) {
            .sidebar {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: var(--sidebar-width);
            }
            
            .sidebar-close-btn {
                display: none;
            }
            
            .menu-toggle {
                display: none;
            }
            
            .header {
                 justify-content: flex-start;
                 gap: 30px;
            }
            
             .user-info {
                margin-left: auto;
            }
            
            #pageTitle {
                text-align: left;
                flex-grow: 0;
            }
        }
        
        @media (max-width: 991px) {
            .sidebar {
                width: 85vw;
                max-width: var(--sidebar-width);
                z-index: 1001;
            }
            
            .main-content {
                margin-left: 0;
                padding: 20px;
            }
            
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: row;
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                gap: 12px;
                padding: 15px 20px;
            }
            
            .header-left-group {
                order: 1;
            }
            
            #pageTitle {
                order: 2;
                flex-grow: 1;
                text-align: center;
                display: block;
                font-size: 18px;
            }
            
            .user-info {
                order: 3;
                gap: 8px;
            }
            
            .menu-toggle {
                align-self: center;
                margin-bottom: 0;
            }
            
            .user-info div:last-child > div {
                display: none;
            }
            
            .user-info div:last-child {
                display: flex;
                flex-direction: row;
                gap: 5px;
            }

            #logoutBtn {
                padding: 5px 10px;
                font-size: 14px;
            }


            /* Responsive Table CSS */
            .table-container table,
            .table-container thead,
            .table-container tbody,
            .table-container th,
            .table-container td,
            .table-container tr {
                display: block;
            }

            .table-container thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            
            .table-container tr {
                border: 1px solid var(--border);
                margin-bottom: 15px;
                border-radius: var(--radius);
                overflow: hidden;
                background: #f0f2f5;
                box-shadow: var(--shadow);
            }

            .table-container td {
                border: none;
                border-bottom: 1px solid var(--border);
                position: relative;
                padding: 15px 20px 15px 50%;
                text-align: right;
                min-height: 50px;
            }
            
            .table-container td:last-child {
                border-bottom: none;
                padding: 15px 20px;
                text-align: center;
            }

            .table-container td:before {
                position: absolute;
                top: 15px;
                left: 15px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: 600;
                color: var(--text-primary);
                text-transform: uppercase;
                font-size: 13px;
                opacity: 0.8;
            }

            #studentsSection .table-container td:nth-of-type(1):before { content: "ID"; }
            #studentsSection .table-container td:nth-of-type(2):before { content: "Name"; }
            #studentsSection .table-container td:nth-of-type(3):before { content: "Grade"; }
            #studentsSection .table-container td:nth-of-type(4):before { content: "Phone"; }
            #studentsSection .table-container td:nth-of-type(5):before { content: "Monthly Fee"; }
            #studentsSection .table-container td:nth-of-type(6):before { content: "Fee Status"; }
            #studentsSection .table-container td:nth-of-type(7):before { content: "Actions"; }
            
            #feesSection .table-container td:nth-of-type(1):before { content: "Receipt ID"; }
            #feesSection .table-container td:nth-of-type(2):before { content: "Student Name"; }
            #feesSection .table-container td:nth-of-type(3):before { content: "Month"; }
            #feesSection .table-container td:nth-of-type(4):before { content: "Amount"; }
            #feesSection .table-container td:nth-of-type(5):before { content: "Status"; }
            #feesSection .table-container td:nth-of-type(6):before { content: "Date Paid"; }
            #feesSection .table-container td:nth-of-type(7):before { content: "Actions"; }

            /* Auth form mobile */
            .auth-form {
                padding: 30px 20px;
                margin: 10px;
            }

            .auth-header h1 {
                font-size: 32px;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }
    </style>
</head>
<body>
<div class="auth-container" id="authSection">
<div class="auth-form shadow-md">
<div class="auth-header">
<h1><i class="fas fa-users"></i> Popcorn</h1>
<p>EMS</p>
</div>
<div class="auth-tabs">
<div class="auth-tab active" id="loginTab">Login</div>
<div class="auth-tab" id="registerTab">Register</div>
</div>
<form id="loginForm">
<div class="form-group">
<label for="loginEmail"><i class="fas fa-envelope"></i> Email</label>
<input class="form-control" id="loginEmail" placeholder="Enter your email" required="" type="email"/>
</div>
<div class="form-group">
<label for="loginPassword"><i class="fas fa-lock"></i> Password</label>
<input class="form-control" id="loginPassword" placeholder="Enter your password" required="" type="password"/>
</div>
<button class="btn" type="submit">Login to Popcorn</button>
</form>
<form id="registerForm" style="display: none;">
<div class="form-group">
<label for="registerUsername"><i class="fas fa-user"></i> Username</label>
<input class="form-control" id="registerUsername" placeholder="Choose a username" required="" type="text"/>
</div>
<div class="form-group">
<label for="registerFullName"><i class="fas fa-id-card"></i> Full Name</label>
<input class="form-control" id="registerFullName" placeholder="Enter your full name" required="" type="text"/>
</div>
<div class="form-group">
<label for="registerPhone"><i class="fas fa-phone"></i> Phone Number</label>
<input class="form-control" id="registerPhone" placeholder="03XX-XXXXXXX" required="" type="tel"/>
</div>
<div class="form-group">
<label for="registerEmail"><i class="fas fa-envelope"></i> Email</label>
<input class="form-control" id="registerEmail" placeholder="Enter your email" required="" type="email"/>
</div>
<div class="form-group">
<label for="registerPassword"><i class="fas fa-lock"></i> Password</label>
<input class="form-control" id="registerPassword" placeholder="Create a password" required="" type="password"/>
</div>
<div class="form-group">
<label for="registerPIN"><i class="fas fa-key"></i> Security PIN</label>
<input class="form-control" id="registerPIN" maxlength="4" placeholder="4-digit PIN for security" required="" type="password"/>
</div>
<div class="form-group">
<label for="registerBio"><i class="fas fa-pen"></i> Bio</label>
<textarea class="form-control" id="registerBio" placeholder="Tell us about yourself" rows="3"></textarea>
</div>
<div class="terms-container">
<h4>Terms and Conditions</h4>
<p><strong>English:</strong> This education management application uses Firebase Realtime Database for all data (users, students, fees, attendance). Your data is stored securely in the cloud. By registering, you agree to our privacy policy and terms of service.</p>
<p><strong>اردو:</strong> یہ ایجوکیشن مینجمنٹ ایپلیکیشن تمام ڈیٹا (صارفین، طلباء، فیس، حاضری) کے لیے Firebase Realtime Database استعمال کرتی ہے۔ آپ کا ڈیٹا کلاؤڈ میں محفوظ طریقے سے محفوظ ہوتا ہے۔ رجسٹریشن کرکے آپ ہماری پرائیویسی پالیسی اور شرائط و ضوابط سے اتفاق کرتے ہیں۔</p>
</div>
<div class="form-group terms-checkbox">
<input type="checkbox" id="acceptTerms" required />
<label for="acceptTerms">I accept the terms and conditions</label>
</div>
<button class="btn btn-success" type="submit">Create Account</button>
</form>
<div id="authMessage" style="margin-top: 20px;"></div>
</div>
</div>
<div class="app-container" id="appSection">
<div class="sidebar" id="sidebar">
<div class="sidebar-header">
<div class="logo-title">
<i class="fas fa-users fa-2x"></i>
<h2>Popcorn</h2>
</div>
<button aria-label="Close menu" class="sidebar-close-btn" id="sidebarCloseBtn">
<i class="fas fa-times"></i>
</button>
</div>
<ul class="sidebar-menu">
<li class="active" data-section="emsDashboard">
<i class="fas fa-tachometer-alt"></i> EMS Dashboard
                </li>
<li data-section="students">
<i class="fas fa-user-graduate"></i> Student Admission
                </li>
<li data-section="fees">
<i class="fas fa-money-bill-wave"></i> Fee Collection
                </li>
<li data-section="attendance">
<i class="fas fa-calendar-check"></i> Attendance
                </li>
<li data-section="settings">
<i class="fas fa-cog"></i> Settings
                </li>
<li data-section="branding">
<i class="fas fa-building"></i> Academy Branding
                </li>
</ul>
</div>
<div class="sidebar-backdrop" id="sidebarBackdrop"></div>
<div class="main-content" id="mainContent">
<div class="header shadow-md">
<div class="header-left-group">
<button class="menu-toggle" id="menuToggle">
<i class="fas fa-bars"></i>
</button>
</div>
<h1 id="pageTitle">EMS Dashboard</h1>
<div class="user-info">
<div class="user-avatar" id="userAvatar">U</div>
<div>
<div>Welcome, <strong id="loggedInUser">User</strong></div>
<button class="btn btn-danger btn-sm" id="logoutBtn">Logout</button>
</div>
</div>
</div>
<div class="content-section active" id="emsDashboardSection">
<div class="section-header">
<h2>EMS Dashboard Overview</h2>
<p>Welcome to your education management dashboard</p>
</div>
<div class="dashboard-cards">
<div class="card shadow-hover">
<div class="card-icon">
<i class="fas fa-users"></i>
</div>
<h3>Total Students</h3>
<div class="card-value" id="totalStudents">0</div>
<div class="card-desc">Registered in academy</div>
</div>
<div class="card shadow-hover">
<div class="card-icon">
<i class="fas fa-coins"></i>
</div>
<h3>Fees Collected</h3>
<div class="card-value"><span class="currency" id="feesCollected">0</span></div>
<div class="card-desc">This month</div>
</div>
<div class="card shadow-hover">
<div class="card-icon">
<i class="fas fa-clipboard-check"></i>
</div>
<h3>Today's Attendance</h3>
<div class="card-value" id="todayAttendance">0%</div>
<div class="card-desc">Present students</div>
</div>
<div class="card shadow-hover">
<div class="card-icon">
<i class="fas fa-exclamation-circle"></i>
</div>
<h3>Pending Fees</h3>
<div class="card-value" id="pendingFees">0</div>
<div class="card-desc">For current month</div>
</div>
</div>
<div class="form-row">
<div class="table-container shadow-md">
<h3>Recent Fee collections</h3>
<div class="table-responsive">
<table id="recentFeesTable">
<thead>
<tr>
<th>Student</th>
<th>Amount</th>
<th>Status</th>
<th>Date</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</div>
</div>
<div class="table-container shadow-md">
<h3>Recent Attendance</h3>
<div class="table-responsive">
<table id="recentAttendanceTable">
<thead>
<tr>
<th>Date</th>
<th>Present</th>
<th>Absent</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="content-section" id="studentsSection">
<div class="section-header">
<h2>Student Admission</h2>
<p>Manage student records and information</p>
</div>
<div class="form-container shadow-md">
<h3>Add New Student</h3>
<form id="studentForm">
<div class="form-row">
<div class="form-group">
<label for="studentName">Student Name</label>
<input class="form-control" id="studentName" placeholder="Full name of student" required="" type="text"/>
</div>
<div class="form-group">
<label for="studentGrade">Grade (1-12)</label>
<select class="form-control" id="studentGrade" required="">
<option value="">Select Grade</option>
<option value="1">Grade 1</option>
<option value="2">Grade 2</option>
<option value="3">Grade 3</option>
<option value="4">Grade 4</option>
<option value="5">Grade 5</option>
<option value="6">Grade 6</option>
<option value="7">Grade 7</option>
<option value="8">Grade 8</option>
<option value="9">Grade 9</option>
<option value="10">Grade 10</option>
<option value="11">Grade 11</option>
<option value="12">Grade 12</option>
</select>
</div>
<div class="form-group">
<label for="studentPhone">Parent's Phone</label>
<input class="form-control" id="studentPhone" placeholder="03XX-XXXXXXX" required="" type="tel"/>
</div>
<div class="form-group">
<label for="studentFee">Monthly Fee (PKR)</label>
<input class="form-control" id="studentFee" placeholder="Monthly fee amount" required="" type="number"/>
</div>
</div>
<button class="btn" style="margin-top: 20px;" type="submit"><i class="fas fa-plus-circle"></i> Add Student</button>
</form>
</div>
<div class="table-container shadow-md">
<h3>Student Records (History)</h3>
<div class="table-responsive">
<table id="studentsTable">
<thead>
<tr>
<th>ID</th>
<th>Name</th>
<th>Grade</th>
<th>Phone</th>
<th>Monthly Fee</th>
<th>Fee Status</th>
<th>Actions</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</div>
</div>
</div>
<div class="content-section" id="feesSection">
<div class="section-header">
<h2>Fee Collection</h2>
<p>Record and manage student fee payments</p>
</div>
<div class="form-container shadow-md">
<h3>Collect Fee</h3>
<form id="feeForm">
<div class="form-row">
<div class="form-group">
<label for="feeStudent">Select Student</label>
<select class="form-control" id="feeStudent" required="">
<option value="">Select Student</option>
</select>
</div>
<div class="form-group">
<label for="feeMonth">Month</label>
<input class="form-control" id="feeMonth" required="" type="month"/>
</div>
<div class="form-group">
<label for="feeAmount">Amount (PKR)</label>
<input class="form-control" id="feeAmount" placeholder="Amount to collect" required="" type="number"/>
<small id="feeHelp" style="color: var(--text-secondary); font-weight: 500; margin-top: 5px; display: block;">
                                    Monthly Fee: <span class="currency" id="monthlyFeeDisplay" style="color: var(--success);">0</span> | 
                                    <span style="color: var(--danger);">Remaining/Due: <span class="currency" id="remainingFeeDisplay" style="color: var(--danger);">0</span></span>
</small>
</div>
<div class="form-group">
<label for="feeDate">Payment Date</label>
<input class="form-control" id="feeDate" required="" type="date"/>
</div>
</div>
<button class="btn" style="margin-top: 20px;" type="submit"><i class="fas fa-money-check"></i> Collect Fee</button>
</form>
</div>
<div class="table-container shadow-md">
<h3>Fee Records (History)</h3>
<div class="table-responsive">
<table id="feesTable">
<thead>
<tr>
<th>Receipt ID</th>
<th>Student Name</th>
<th>Month</th>
<th>Amount</th>
<th>Status</th>
<th>Date Paid</th>
<th>Actions</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</div>
</div>
</div>
<div class="content-section" id="attendanceSection">
<div class="section-header">
<h2>Attendance Management</h2>
<p>Track and manage student attendance</p>
</div>
<div class="form-container shadow-md">
<h3>Mark Attendance</h3>
<form id="attendanceForm">
<div class="form-row">
<div class="form-group">
<label for="attendanceDate">Date</label>
<input class="form-control" id="attendanceDate" required="" type="date"/>
</div>
</div>
<div class="form-group">
<label>Mark Attendance for Students</label>
<div id="attendanceList" style="max-height: 500px; overflow-y: auto; border: 1px solid var(--border); padding: 20px; border-radius: var(--radius); background: #f0f2f5;">
</div>
</div>
<button class="btn" style="margin-top: 20px;" type="submit"><i class="fas fa-save"></i> Save Attendance</button>
</form>
</div>
<div class="table-container shadow-md">
<h3>Attendance Records (History)</h3>
<div class="table-responsive">
<table id="attendanceTable">
<thead>
<tr>
<th>Date</th>
<th>Present</th>
<th>Absent</th>
<th>Percentage</th>
<th>Actions</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</div>
</div>
</div>
<div class="content-section" id="settingsSection">
<div class="section-header">
<h2>Settings</h2>
<p>Manage your account and preferences</p>
</div>
<div class="form-container shadow-md">
<h3>Account Settings</h3>
<form id="settingsForm">
<div class="form-group">
<label for="changePasswordEmail">Reset Password</label>
<input class="form-control" id="changePasswordEmail" placeholder="Enter email to send reset link" required="" type="email"/>
<button class="btn btn-warning" onclick="sendPasswordReset()" type="button">Send Reset Link</button>
</div>
<div class="form-group">
<label>Notifications</label>
<label class="switch">
<input checked="" id="notificationsToggle" type="checkbox"/>
<span class="slider"></span>
</label>
<small>Enable/disable push notifications</small>
</div>
<div class="form-group">
<label for="privacySetting">Privacy</label>
<select class="form-control" id="privacySetting">
<option value="public">Public</option>
<option value="friends">Friends Only</option>
<option value="private">Private</option>
</select>
</div>
</form>
</div>
</div>
<div class="content-section" id="brandingSection">
<div class="section-header">
<h2>Academy Branding</h2>
<p>Set up your school or academy details for WhatsApp receipts and alerts</p>
</div>
<div class="branding-container">
<div class="form-container shadow-md">
<h3>Branding Settings</h3>
<form id="brandingForm">
<div class="form-row branding-form-row">
<div class="form-group">
<label for="schoolName"><i class="fas fa-school"></i> School/Academy Name</label>
<input class="form-control" disabled="" id="schoolName" placeholder="Enter your school or academy name" type="text"/>
</div>
<div class="form-group">
<label for="schoolPhone"><i class="fas fa-phone"></i> Academy Phone Number</label>
<input class="form-control" disabled="" id="schoolPhone" placeholder="03XX-XXXXXXX" type="tel"/>
</div>
</div>
<button class="btn btn-success" disabled="" type="submit"><i class="fas fa-save"></i> Save Branding</button>
<div class="save-status" id="saveStatus"></div>
</form>
</div>
<div class="form-container shadow-md">
<h3>WhatsApp Message Preview</h3>
<div class="branding-preview" id="brandingPreview">
                            Fee Receipt - Sample Student
                            
                            Month: 2025-10
                            Amount: PKR 5000
                            Status: Fully Paid
                            Date: 2025-10-12
                            
                            [Your Academy Name Here]
                            Contact: [Your Academy Phone Here]
                            
                            Thank you! - Created by Sample User
                        </div>
</div>
</div>
</div>
</div>
</div>
<div class="modal" id="pinModal">
<div class="modal-content">
<div class="modal-header">
<h3><i class="fas fa-lock"></i> Enter Security PIN</h3>
<span class="close-modal" onclick="closePinModal()">×</span>
</div>
<p style="margin-bottom: 15px; color: var(--text-secondary);">To perform this secure action (Delete/Edit), please enter your 4-digit PIN.</p>
<div class="form-group">
<input class="form-control" id="pinInput" maxlength="4" placeholder="Enter your 4-digit PIN" type="password"/>
</div>
<div style="display: flex; justify-content: space-between; gap: 12px; margin-top: 25px;">
<button class="btn btn-danger" onclick="closePinModal()" type="button">Cancel</button>
<button class="btn btn-success" onclick="verifyPin()">Verify PIN</button>
</div>
</div>
</div>
<script>
        // FIXED Firebase Configuration - Database URL Updated
        const firebaseConfig = {
            apiKey: "AIzaSyAaM6vNyFpliNAgzujoG4xBDbTGmSB33no",
            authDomain: "ems-by-ali.firebaseapp.com",
            projectId: "ems-by-ali",
            storageBucket: "ems-by-ali.firebasestorage.app",
            messagingSenderId: "920434998465",
            appId: "1:920434998465:web:e52f12fdb9fa1d64cf6840",
            measurementId: "G-ZX7G5E1B45",
            databaseURL: "https://ems-by-ali-default-rtdb.asia-southeast1.firebasedatabase.app" // FIXED URL
        };

        // Initialize Firebase (FIX: Use Compat Syntax)
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const storage = firebase.storage(); // Note: Storage is not fully implemented in the code, but the variable is set

        // Application state
        let currentUser = null;

        // EMS state
        let students = {};
        let fees = {};
        let attendance = {};
        let currentAction = null;
        let currentItemId = null;

        // Default branding (locked)
        const defaultSchoolName = "Powered by Ali ® 2025 03091539086";
        const defaultSchoolPhone = "03091539086";

        // Sidebar Elements
        const sidebar = document.getElementById('sidebar');
        const backdrop = document.getElementById('sidebarBackdrop');

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is signed in (FIX: Use compat onAuthStateChanged)
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = {
                        uid: user.uid,
                        email: user.email
                    };
                    
                    // Load user data from DB (FIX: Use compat ref and on)
                    db.ref('users/' + currentUser.uid).on('value', (snap) => {
                        if (snap.exists()) {
                            const data = snap.val();
                            currentUser.username = data.username;
                            currentUser.fullName = data.fullName;
                            currentUser.phone = data.phone;
                            currentUser.schoolName = data.schoolName || defaultSchoolName;
                            currentUser.schoolPhone = data.schoolPhone || defaultSchoolPhone;
                            currentUser.bio = data.bio || '';
                            currentUser.avatar = data.avatar || currentUser.fullName.charAt(0).toUpperCase();
                            currentUser.createdAt = data.createdAt;
                            currentUser.pin = data.pin;
                            currentUser.brandingUnlocked = data.brandingUnlocked || false;
                            const dbToken = data.sessionToken;
                            const localToken = localStorage.getItem('sessionToken');
                            if (dbToken && localToken !== dbToken) {
                                auth.signOut();
                                alert('Logged out: Session active on another device.');
                                return;
                            }
                            loadUserData();
                            showApp();
                        }
                    });
                } else {
                    currentUser = null;
                    showAuth();
                }
            });

            // Set up event listeners
            setupEventListeners();
            
            // Set current dates for EMS
            const today = new Date().toISOString().split('T')[0];
            if (document.getElementById('feeMonth')) document.getElementById('feeMonth').valueAsDate = new Date();
            if (document.getElementById('feeDate')) document.getElementById('feeDate').value = today;
            if (document.getElementById('attendanceDate')) document.getElementById('attendanceDate').value = today;
        });

        // Set up event listeners
        function setupEventListeners() {
            // Auth tabs
            document.getElementById('loginTab').addEventListener('click', () => switchAuthTab('login'));
            document.getElementById('registerTab').addEventListener('click', () => switchAuthTab('register'));
            
            // Auth forms
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', function(e) {
                e.preventDefault();
                handleLogout();
            });
            
            // Sidebar toggle and close
            document.getElementById('menuToggle').addEventListener('click', openSidebar); 
            document.getElementById('sidebarCloseBtn').addEventListener('click', closeSidebar);
            backdrop.addEventListener('click', closeSidebar);
            
            // Menu items
            document.querySelectorAll('.sidebar-menu li').forEach(item => {
                item.addEventListener('click', () => {
                    const section = item.getAttribute('data-section');
                    showSection(section);
                    
                    // Update active menu item
                    document.querySelectorAll('.sidebar-menu li').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    
                    // Close sidebar after selection
                    closeSidebar();
                });
            });
            
            // EMS event listeners
            if (document.getElementById('studentForm')) document.getElementById('studentForm').addEventListener('submit', handleAddStudent);
            if (document.getElementById('feeForm')) document.getElementById('feeForm').addEventListener('submit', handleFeeCollection);
            if (document.getElementById('feeStudent')) document.getElementById('feeStudent').addEventListener('change', updateFeeInfo);
            if (document.getElementById('feeMonth')) document.getElementById('feeMonth').addEventListener('change', updateFeeInfo);
            if (document.getElementById('attendanceForm')) document.getElementById('attendanceForm').addEventListener('submit', handleAttendance);
            if (document.getElementById('attendanceDate')) document.getElementById('attendanceDate').addEventListener('change', loadAttendanceForm);
        }

        // Sidebar Control functions
        function openSidebar() {
            sidebar.classList.add('open');
            backdrop.classList.add('open');
        }

        function closeSidebar() {
            sidebar.classList.remove('open');
            backdrop.classList.remove('open');
        }

        // Authentication functions
        function showAuth() {
            document.getElementById('authSection').style.display = 'flex';
            document.getElementById('appSection').style.display = 'none';
        }

        function switchAuthTab(tab) {
            document.getElementById('loginTab').classList.toggle('active', tab === 'login');
            document.getElementById('registerTab').classList.toggle('active', tab === 'register');
            document.getElementById('loginForm').style.display = tab === 'login' ? 'block' : 'none';
            document.getElementById('registerForm').style.display = tab === 'register' ? 'block' : 'none';
            document.getElementById('authMessage').innerHTML = '';
            
            if (tab === 'login') {
                document.getElementById('registerForm').reset();
            } else {
                document.getElementById('loginForm').reset();
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            // FIX: Use compat signInWithEmailAndPassword
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const sessionToken = generateId();
                    // FIX: Use compat set
                    db.ref('users/' + userCredential.user.uid + '/sessionToken').set(sessionToken);
                    localStorage.setItem('sessionToken', sessionToken);
                    showAuthMessage('Login successful! Redirecting to dashboard...', 'success');
                })
                .catch((error) => {
                    showAuthMessage('Invalid email or password. Please try again.', 'error');
                });
        }

        function handleRegister(e) {
            e.preventDefault();
            const acceptTerms = document.getElementById('acceptTerms').checked;
            if (!acceptTerms) {
                showAuthMessage('You must accept the terms and conditions to register.', 'error');
                return;
            }
            const username = document.getElementById('registerUsername').value;
            const fullName = document.getElementById('registerFullName').value;
            const phone = document.getElementById('registerPhone').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const bio = document.getElementById('registerBio').value;
            const pin = document.getElementById('registerPIN').value;
            
            if (!phone.match(/^03\d{9}$/)) {
                showAuthMessage('Please enter a valid Pakistani phone number (03XXXXXXXXX)', 'error');
                return;
            }
            
            if (pin.length !== 4 || isNaN(pin)) {
                showAuthMessage('PIN must be a 4-digit number', 'error');
                return;
            }
            
            // Check if username already exists (FIX: Use compat query and once)
            db.ref('users').orderByChild('username').equalTo(username).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    showAuthMessage('Username already exists. Please choose a different one.', 'error');
                } else {
                    // Create user with email and password (FIX: Use compat createUserWithEmailAndPassword)
                    auth.createUserWithEmailAndPassword(email, password)
                        .then((userCredential) => {
                            const user = userCredential.user;
                            
                            // Store user data in Firebase (FIX: Use compat ref, set, and ServerValue.TIMESTAMP)
                            db.ref('users/' + user.uid).set({
                                username,
                                usernameLower: username.toLowerCase(),
                                fullName,
                                phone,
                                email,
                                bio,
                                avatar: fullName.charAt(0).toUpperCase(),
                                createdAt: firebase.database.ServerValue.TIMESTAMP,
                                lastSeen: firebase.database.ServerValue.TIMESTAMP,
                                pin,
                                brandingUnlocked: false,
                                schoolName: defaultSchoolName,
                                schoolPhone: defaultSchoolPhone
                            }).then(() => {
                                const sessionToken = generateId();
                                db.ref('users/' + user.uid + '/sessionToken').set(sessionToken);
                                localStorage.setItem('sessionToken', sessionToken);
                                showAuthMessage('Registration successful! Loading dashboard...', 'success');
                                document.getElementById('registerForm').reset();
                            }).catch((dbError) => {
                                showAuthMessage('Error saving user data: ' + dbError.message, 'error');
                            });
                        })
                        .catch((error) => {
                            const errorCode = error.code;
                            const errorMessage = error.message;
                            showAuthMessage('Error creating account: ' + errorMessage, 'error');
                        });
                }
            });
        }

        function showAuthMessage(message, type) {
            const messageDiv = document.getElementById('authMessage');
            const style = type === 'success' ? 'background: rgba(66,183,42,0.2); color: var(--success); padding: 12px; border-radius: var(--radius); box-shadow: var(--shadow);' : 
                                               'background: rgba(234,60,83,0.2); color: var(--danger); padding: 12px; border-radius: var(--radius); box-shadow: var(--shadow);';
            messageDiv.innerHTML = `<div style="${style}">${message}</div>`;
        }

        // Handle logout with proper cleanup (FIX: Use compat signOut)
        function handleLogout() {
            
            // Update last seen timestamp (FIX: Use compat update and ServerValue.TIMESTAMP)
            if (currentUser) {
                db.ref('users/' + currentUser.uid).update({lastSeen: firebase.database.ServerValue.TIMESTAMP});
            }
            
            auth.signOut().then(() => {
                clearUserData();
                
                // Reset forms
                document.getElementById('loginForm').reset();
                document.getElementById('registerForm').reset();
                
                // Show auth section and hide app section
                document.getElementById('authSection').style.display = 'flex';
                document.getElementById('appSection').style.display = 'none';
                
                // Switch to login tab
                switchAuthTab('login');
                
                // Clear any auth messages
                document.getElementById('authMessage').innerHTML = '';
                
                console.log("User logged out successfully");
            }).catch((error) => {
                console.error("Error signing out:", error);
            });
        }

        // Clear EMS data on logout
        function clearUserData() {
            students = {};
            fees = {};
            attendance = {};
            currentUser = null;
        }

        // Load user-specific EMS data from Firebase (FIX: Use compat on)
        function loadUserData() {
            if (!currentUser) return;

            // Load students
            db.ref(`ems/${currentUser.uid}/students`).on('value', (snap) => {
                students = snap.val() || {};
                updateDashboard();
                updateStudentDropdown();
                loadStudentsTable();
            });

            // Load fees
            db.ref(`ems/${currentUser.uid}/fees`).on('value', (snap) => {
                fees = snap.val() || {};
                loadFeesTable();
                updateDashboard();
            });

            // Load attendance
            db.ref(`ems/${currentUser.uid}/attendance`).on('value', (snap) => {
                attendance = snap.val() || {};
                loadAttendanceTable();
                updateDashboard();
            });

            updateBrandingPreview();
        }

        // UI Navigation functions
        function showApp() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('appSection').style.display = 'block';
            
            // Handle display for logged-in user
            const userName = currentUser.fullName || currentUser.username || currentUser.email.split('@')[0];
            document.getElementById('loggedInUser').textContent = userName;
            document.getElementById('userAvatar').textContent = currentUser.avatar;
            document.getElementById('changePasswordEmail').value = currentUser.email;
            
            // Update branding form (locked, show default)
            document.getElementById('schoolName').value = currentUser.schoolName;
            document.getElementById('schoolPhone').value = currentUser.schoolPhone;
            
            showSection('emsDashboard');
        }

        function showSection(section) {
            document.querySelectorAll('.content-section').forEach(sec => {
                sec.classList.remove('active');
            });
            
            document.getElementById(`${section}Section`).classList.add('active');
            
            const titles = {
                emsDashboard: 'EMS Dashboard Overview',
                students: 'Student Admission',
                fees: 'Fee Collection',
                attendance: 'Attendance Management',
                settings: 'Settings',
                branding: 'Academy Branding'
            };
            document.getElementById('pageTitle').textContent = titles[section] || section;
            
            if(section === 'branding') {
                loadBrandingSection();
            } else if (section === 'emsDashboard') {
                updateDashboard();
            } else if (section === 'students') {
                loadStudentsTable();
            } else if (section === 'fees') {
                loadFeesTable();
            } else if (section === 'attendance') {
                loadAttendanceForm();
            } else if (section === 'settings') {
                // Settings loaded statically
            } else if (section === 'branding') {
                updateBrandingPreview();
            }
        }

        // Settings functions
        function sendPasswordReset() {
            const email = document.getElementById('changePasswordEmail').value;
            // FIX: Use compat sendPasswordResetEmail
            auth.sendPasswordResetEmail(email).then(() => {
                alert('Password reset email sent!');
            }).catch(error => {
                alert('Error: ' + error.message);
            });
        }

        // Branding Management (locked)
        function updateBrandingPreview() {
            const preview = document.getElementById('brandingPreview');
            const branding = currentUser.schoolName ? `${currentUser.schoolName}\n` : '';
            const contact = currentUser.schoolPhone ? `Contact: ${currentUser.schoolPhone}\n` : '';
            preview.textContent = `Fee Receipt - Sample Student

Month: 2025-10
Amount: PKR 5000
Status: Fully Paid
Date: 2025-10-12

${branding}${contact}Thank you! - Created by Sample User`;
        }

        function loadBrandingSection() {
            document.getElementById('schoolName').value = currentUser.schoolName;
            document.getElementById('schoolPhone').value = currentUser.schoolPhone;
            updateBrandingPreview();

            const form = document.getElementById('brandingForm');
            const button = form.querySelector('button');
            const inputs = form.querySelectorAll('input');
            const container = document.querySelector('.branding-container .form-container');

            // Remove existing message if any
            let existingMsg = container.querySelector('.unlock-message');
            if (existingMsg) existingMsg.remove();

            if (currentUser.brandingUnlocked) {
                inputs.forEach(inp => inp.disabled = false);
                button.disabled = false;
                if (!form.hasListener) {
                    form.addEventListener('submit', handleSaveBranding);
                    form.hasListener = true;
                }
            } else {
                inputs.forEach(inp => inp.disabled = true);
                button.disabled = true;

                const unlockMessage = document.createElement('div');
                unlockMessage.className = 'unlock-message';
                unlockMessage.style.marginTop = '25px';
                unlockMessage.innerHTML = `
                    <p style="color:var(--warning); text-align: center; font-weight: 500;">Custom branding is a paid feature.</p>
                    <p style="text-align: center; opacity: 0.8;">To unlock, contact Ali for payment.</p>
                    <button class="btn btn-whatsapp" style="display: block; margin: 15px auto;" onclick="contactAdmin()">Contact on WhatsApp</button>
                `;
                container.appendChild(unlockMessage);
            }
        }

        function handleSaveBranding(e) {
            e.preventDefault();
            const schoolName = document.getElementById('schoolName').value;
            const schoolPhone = document.getElementById('schoolPhone').value;

            // FIX: Use compat update
            db.ref('users/' + currentUser.uid).update({
                schoolName,
                schoolPhone
            }).then(() => {
                currentUser.schoolName = schoolName;
                currentUser.schoolPhone = schoolPhone;
                updateBrandingPreview();
                showSaveStatus('Branding saved successfully!');
            });
        }

        function showSaveStatus(msg) {
            const status = document.getElementById('saveStatus');
            status.textContent = msg;
            status.classList.add('success');
            status.style.display = 'block';
            setTimeout(() => {
                status.style.display = 'none';
                status.classList.remove('success');
            }, 3000);
        }

        function contactAdmin() {
            const adminPhone = '03091539086';
            const message = 'Hello Ali, I want to unlock custom branding for Popcorn app.';
            openWhatsApp(adminPhone, message);
        }

        // EMS functions
        function validateUserSession() {
            if (!currentUser) {
                console.error("No user session found");
                handleLogout();
                return false;
            }
            return true;
        }

        function handleAddStudent(e) {
            e.preventDefault();
            if (!validateUserSession()) return;
            
            const name = document.getElementById('studentName').value;
            const grade = document.getElementById('studentGrade').value;
            const phone = document.getElementById('studentPhone').value;
            const fee = document.getElementById('studentFee').value;
            
            if (!phone.match(/^03\d{9}$/)) {
                alert('Please enter a valid Pakistani phone number (03XXXXXXXXX)');
                return;
            }
            
            const id = generateId();
            const newStudent = {
                name,
                grade: parseInt(grade),
                phone,
                fee: parseInt(fee),
                admissionDate: new Date().toISOString().split('T')[0],
                admissionBy: currentUser.username || currentUser.email
            };
            
            // FIX: Use compat set
            db.ref(`ems/${currentUser.uid}/students/${id}`).set(newStudent);
            
            const branding = currentUser.schoolName ? `${currentUser.schoolName}\nContact: ${currentUser.schoolPhone}\n` : '';
            const message = `Assalam-o-Alaikum! ${name} has been admitted to Grade ${grade}. Monthly fee: PKR ${fee}. \n${branding}Created by ${currentUser.fullName} (${currentUser.phone})`;
            openWhatsApp(phone, message);
            
            alert('Student added successfully! WhatsApp message ready to send.');
            document.getElementById('studentForm').reset();
        }

        function loadStudentsTable() {
            if (!validateUserSession()) return;
            
            const tbody = document.querySelector('#studentsTable tbody');
            tbody.innerHTML = '';

            const studentArray = Object.entries(students).map(([id, student]) => ({id, ...student}));

            const sortedStudents = studentArray.sort((a, b) => a.grade - b.grade || a.name.localeCompare(b.name));
            
            sortedStudents.forEach(student => {
                // Calculate fee status for this month
                const currentMonth = new Date().toISOString().slice(0, 7);
                const studentFees = Object.values(fees).filter(f => f.studentId === student.id && f.month === currentMonth);
                const totalPaid = studentFees.reduce((sum, fee) => sum + fee.amount, 0);
                const remaining = student.fee - totalPaid;
                
                let feeStatus = 'Pending';
                let statusClass = 'fee-pending';
                
                if (remaining <= 0) {
                    feeStatus = 'Paid';
                    statusClass = 'fee-paid';
                } else if (totalPaid > 0) {
                    feeStatus = `Partial (PKR ${remaining} due)`;
                    statusClass = 'fee-partial';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.id}</td>
                    <td>${student.name}</td>
                    <td>Grade ${student.grade}</td>
                    <td>${student.phone}</td>
                    <td><span class="currency">${student.fee}</span></td>
                    <td><span class="fee-status ${statusClass}">${feeStatus}</span></td>
                    <td class="action-buttons">
                        <button class="btn btn-danger btn-sm" onclick="deleteStudent('${student.id}')"><i class="fas fa-trash"></i> Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function deleteStudent(id) {
            if (!validateUserSession()) return;
            
            currentAction = 'deleteStudent';
            currentItemId = id;
            openPinModal();
        }

        function updateStudentDropdown() {
            if (!validateUserSession()) return;
            
            const dropdown = document.getElementById('feeStudent');
            dropdown.innerHTML = '<option value="">Select Student</option>';
            
            const studentArray = Object.entries(students).map(([id, student]) => ({id, ...student}));
            studentArray.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.name} (Grade ${student.grade}) - PKR ${student.fee}/month`;
                option.setAttribute('data-fee', student.fee);
                dropdown.appendChild(option);
            });
            updateFeeInfo();
        }

        function updateFeeInfo() {
            if (!validateUserSession()) return;
            
            const student = document.getElementById('feeStudent').value;
            const month = document.getElementById('feeMonth').value;
            
            const monthlyFeeDisplay = document.getElementById('monthlyFeeDisplay');
            const remainingFeeDisplay = document.getElementById('remainingFeeDisplay');
            const feeAmountInput = document.getElementById('feeAmount');
            
            if (!student || !month) {
                monthlyFeeDisplay.textContent = '0';
                remainingFeeDisplay.textContent = '0';
                feeAmountInput.max = null;
                feeAmountInput.value = '';
                return;
            }
            
            const studentData = students[student];
            if (!studentData) return;
            
            // Calculate already paid amount for this month
            const paidFees = Object.values(fees).filter(f => f.studentId === student && f.month === month);
            const totalPaid = paidFees.reduce((sum, f) => sum + f.amount, 0);
            const remaining = studentData.fee - totalPaid;
            
            // Update displays
            monthlyFeeDisplay.textContent = studentData.fee;
            remainingFeeDisplay.textContent = remaining < 0 ? 0 : remaining;
            
            // Set max value for fee amount input to the remaining fee
            feeAmountInput.max = remaining < 0 ? 0 : remaining;
            
            // Set default value for amount input (suggest full remaining amount)
            if (remaining > 0) {
                 feeAmountInput.value = remaining;
            } else {
                 feeAmountInput.value = 0;
            }
        }

        function handleFeeCollection(e) {
            e.preventDefault();
            if (!validateUserSession()) return;
            
            const studentId = document.getElementById('feeStudent').value;
            const month = document.getElementById('feeMonth').value;
            const amount = parseInt(document.getElementById('feeAmount').value);
            const datePaid = document.getElementById('feeDate').value;
            
            const student = students[studentId];
            if (!student) {
                alert('Please select a valid student');
                return;
            }
            
            // Recalculate remaining fee before processing
            const paidFees = Object.values(fees).filter(f => f.studentId === studentId && f.month === month);
            const totalPaid = paidFees.reduce((sum, fee) => sum + fee.amount, 0);
            const remaining = student.fee - totalPaid;
            
            if (amount > remaining) {
                alert(`Cannot collect more than the remaining fee amount (PKR ${remaining < 0 ? 0 : remaining})`);
                return;
            }
            
            if (amount <= 0) {
                alert('Please enter a valid amount greater than zero');
                return;
            }
            
            const id = generateId();
            const newFee = {
                studentId,
                studentName: student.name,
                month,
                amount: amount,
                datePaid,
                collectedBy: currentUser.username || currentUser.email
            };
            
            // FIX: Use compat set
            db.ref(`ems/${currentUser.uid}/fees/${id}`).set(newFee);
            
            // WhatsApp message content
            const totalPaidNow = totalPaid + amount;
            const remainingAfterPayment = student.fee - totalPaidNow;
            const status = remainingAfterPayment <= 0 ? 'Fully Paid' : `Partially Paid (PKR ${remainingAfterPayment} due)`;
            const branding = currentUser.schoolName ? `${currentUser.schoolName}\nContact: ${currentUser.schoolPhone || currentUser.phone}\n` : '';
            
            const message = `Fee Receipt - ${student.name}\n${branding}Month: ${month}\nAmount: PKR ${amount}\nStatus: ${status}\nDate: ${datePaid}\nThank you! - Created by ${currentUser.fullName} (${currentUser.phone})`;
            openWhatsApp(student.phone, message);
            
            alert('Fee collected successfully! WhatsApp receipt ready to send.');
            document.getElementById('feeForm').reset();
            document.getElementById('feeMonth').valueAsDate = new Date();
            document.getElementById('feeDate').value = new Date().toISOString().split('T')[0];
            updateFeeInfo();
        }

        function loadFeesTable() {
            if (!validateUserSession()) return;
            
            const tbody = document.querySelector('#feesTable tbody');
            tbody.innerHTML = '';
            
            const feeArray = Object.entries(fees).map(([id, fee]) => ({id, ...fee}));
            const sortedFees = feeArray.sort((a, b) => new Date(b.datePaid) - new Date(a.datePaid));
            
            sortedFees.forEach(fee => {
                const student = students[fee.studentId];
                if (!student) {
                    const rowDeleted = document.createElement('tr');
                    rowDeleted.innerHTML = `
                        <td>${fee.id}</td>
                        <td><span style="color:var(--danger); font-style:italic;">[DELETED] ${fee.studentName}</span></td>
                        <td>${fee.month}</td>
                        <td><span class="currency">${fee.amount}</span></td>
                        <td><span class="fee-status fee-pending">Archived</span></td>
                        <td>${fee.datePaid}</td>
                        <td class="action-buttons">
                            <button class="btn btn-danger btn-sm" onclick="deleteFee('${fee.id}')"><i class="fas fa-trash"></i> Delete</button>
                        </td>
                    `;
                    tbody.appendChild(rowDeleted);
                    return;
                }
                
                const totalMonthlyFee = student.fee;
                const paidFees = Object.values(fees).filter(f => f.studentId === fee.studentId && f.month === fee.month);
                const totalPaid = paidFees.reduce((sum, f) => sum + f.amount, 0);
                const remaining = totalMonthlyFee - totalPaid;
                
                let status = 'Partial';
                let statusClass = 'fee-partial';
                
                if (remaining <= 0) {
                    status = 'Paid';
                    statusClass = 'fee-paid';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${fee.id}</td>
                    <td>${fee.studentName}</td>
                    <td>${fee.month}</td>
                    <td><span class="currency">${fee.amount}</span></td>
                    <td><span class="fee-status ${statusClass}">${status}</span></td>
                    <td>${fee.datePaid}</td>
                    <td class="action-buttons">
                        <button class="btn btn-whatsapp btn-sm" onclick="resendReceipt('${fee.id}')"><i class="fab fa-whatsapp"></i> Resend</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteFee('${fee.id}')"><i class="fas fa-trash"></i> Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Update recent fees table on dashboard
            const recentFeesTbody = document.querySelector('#recentFeesTable tbody');
            recentFeesTbody.innerHTML = '';
            
            const recentFees = sortedFees.slice(0, 5);
            recentFees.forEach(fee => {
                const student = students[fee.studentId];
                if (!student) return;
                
                const totalPaid = Object.values(fees).filter(f => f.studentId === fee.studentId && f.month === fee.month).reduce((sum, f) => sum + f.amount, 0);
                const remaining = student.fee - totalPaid;
                
                let status = remaining <= 0 ? 'Paid' : 'Partial';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${fee.studentName}</td>
                    <td><span class="currency">${fee.amount}</span></td>
                    <td><span class="fee-status ${status === 'Paid' ? 'fee-paid' : 'fee-partial'}">${status}</span></td>
                    <td>${fee.datePaid}</td>
                `;
                recentFeesTbody.appendChild(row);
            });
        }

        function resendReceipt(feeId) {
            if (!validateUserSession()) return;
            
            const fee = fees[feeId];
            const student = students[fee.studentId];
            
            if (!student) {
                alert("Student record not found. Cannot resend.");
                return;
            }

            const paidFees = Object.values(fees).filter(f => f.studentId === fee.studentId && f.month === fee.month);
            const totalPaid = paidFees.reduce((sum, f) => sum + f.amount, 0);
            const remaining = student.fee - totalPaid;
            const status = remaining <= 0 ? 'Fully Paid' : `Partially Paid (PKR ${remaining} due)`;
            const branding = currentUser.schoolName ? `${currentUser.schoolName}\nContact: ${currentUser.schoolPhone || currentUser.phone}\n` : '';
            
            const message = `Fee Receipt - ${student.name}\n${branding}Month: ${fee.month}\nAmount: PKR ${fee.amount}\nStatus: ${status}\nDate: ${fee.datePaid}\nThank you! - Created by ${currentUser.fullName} (${currentUser.phone})`;
            openWhatsApp(student.phone, message);
            
            alert('WhatsApp receipt ready to send!');
        }

        function deleteFee(id) {
            if (!validateUserSession()) return;
            
            currentAction = 'deleteFee';
            currentItemId = id;
            openPinModal();
        }

        // Attendance Management
        function toggleAttendance(studentId, isChecked) {
            if (!validateUserSession()) return;
            
            const student = students[studentId];
            if (!student) return;

            const date = document.getElementById('attendanceDate').value;
            const alertDiv = document.getElementById(`alert-status-${studentId}`);
            
            // Update the visual status
            if (isChecked) {
                alertDiv.innerHTML = '<span class="status-badge status-present">Present</span>';
            } else {
                alertDiv.innerHTML = '<span class="status-badge status-absent">Absent</span>';
                
                // Immediate WhatsApp Alert for Absent Student
                const branding = currentUser.schoolName ? `${currentUser.schoolName}\nContact: ${currentUser.schoolPhone || currentUser.phone}\n` : '';
                const message = `Attendance Alert: ${student.name} was marked absent on ${date}. Please contact the academy for more information. \n${branding}Created by ${currentUser.fullName} (${currentUser.phone})`;
                openWhatsApp(student.phone, message);
            }
        }

        function loadAttendanceForm() {
            if (!validateUserSession()) return;
            
            const container = document.getElementById('attendanceList');
            container.innerHTML = '';
            
            const studentArray = Object.entries(students).map(([id, student]) => ({id, ...student}));
            if (studentArray.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--text-secondary);">No students available. Please add students first.</p>';
                return;
            }
            
            const date = document.getElementById('attendanceDate').value;
            const existingRecord = attendance[date] || {present: [], absent: []};

            // Group students by grade
            const studentsByGrade = studentArray.reduce((acc, student) => {
                const grade = student.grade;
                if (!acc[grade]) acc[grade] = [];
                acc[grade].push(student);
                return acc;
            }, {});
            
            // Sort grades numerically
            const sortedGrades = Object.keys(studentsByGrade).sort((a, b) => parseInt(a) - parseInt(b));

            sortedGrades.forEach(grade => {
                const gradeContainer = document.createElement('div');
                gradeContainer.style.marginBottom = '25px';
                gradeContainer.innerHTML = `<h4 style="color: var(--primary); border-bottom: 1px dashed var(--border); padding-bottom: 8px; margin-bottom: 20px; font-weight: 600;">Grade ${grade}</h4>`;
                
                // Sort students alphabetically within the grade
                studentsByGrade[grade].sort((a, b) => a.name.localeCompare(b.name));

                studentsByGrade[grade].forEach(student => {
                    // Determine initial status: checked if present in existing record, or default to present (true)
                    const isPresent = existingRecord.present.includes(student.id) || (!existingRecord.present.includes(student.id) && !existingRecord.absent.includes(student.id)); // Default to present if no record exists for this student
                    
                    const div = document.createElement('div');
                    div.style.display = 'flex';
                    div.style.alignItems = 'center';
                    div.style.marginBottom = '12px';
                    div.style.padding = '12px';
                    div.style.border = '1px solid var(--border)';
                    div.style.borderRadius = '8px';
                    div.style.backgroundColor = '#f0f2f5';
                    div.setAttribute('data-student-id', student.id);
                    
                    const statusText = isPresent ? 'Present' : 'Absent';
                    const statusClass = isPresent ? 'status-present' : 'status-absent';

                    div.innerHTML = `
                        <input type="checkbox" id="attendance-${student.id}" class="attendance-checkbox" ${isPresent ? 'checked' : ''} style="display: none;">
                        <label style="margin: 0; flex-grow: 1; color: var(--text-primary); font-weight: 600;">${student.name}</label>
                        <div id="alert-status-${student.id}" style="margin-right: 15px;">
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        <div class="action-buttons" style="gap: 5px;">
                            <button type="button" class="btn btn-sm btn-success attendance-toggle-btn" data-id="${student.id}" data-action="present" title="Mark Present (✅)" style="padding: 8px; width: 35px; height: 35px;"><i class="fas fa-check"></i></button>
                            <button type="button" class="btn btn-sm btn-danger attendance-toggle-btn" data-id="${student.id}" data-action="absent" title="Mark Absent (❌)" style="padding: 8px; width: 35px; height: 35px;"><i class="fas fa-times"></i></button>
                        </div>
                    `;
                    
                    gradeContainer.appendChild(div);
                });
                
                container.appendChild(gradeContainer);
            });
            
            // Attach event listeners for the new toggle buttons
            document.querySelectorAll('.attendance-toggle-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const studentId = this.getAttribute('data-id');
                    const action = this.getAttribute('data-action');
                    const checkbox = document.getElementById(`attendance-${studentId}`);
                    
                    if (action === 'present') {
                        if (!checkbox.checked) {
                            checkbox.checked = true;
                            // Only call toggleAttendance if status changes to absent to send alert
                            toggleAttendance(studentId, true); 
                        }
                    } else if (action === 'absent') {
                        if (checkbox.checked) {
                            checkbox.checked = false;
                            // Only call toggleAttendance if status changes to absent to send alert
                            toggleAttendance(studentId, false); 
                        }
                    }
                });
            });
        }

        function handleAttendance(e) {
            e.preventDefault();
            if (!validateUserSession()) return;
            
            const date = document.getElementById('attendanceDate').value;
            
            const presentStudents = [];
            const absentStudents = [];
            
            const studentArray = Object.entries(students).map(([id, student]) => ({id, ...student}));
            studentArray.forEach(student => {
                // Read state from the hidden checkbox
                const checkbox = document.getElementById(`attendance-${student.id}`);
                if (checkbox && checkbox.checked) {
                    presentStudents.push(student.id);
                } else if (checkbox) {
                    absentStudents.push(student.id);
                }
            });
            
            if (studentArray.length === 0) {
                 alert('No students to mark attendance for.');
                 return;
            }

            const newAttendance = {
                present: presentStudents,
                absent: absentStudents,
                markedBy: currentUser.username || currentUser.email
            };
            
            // FIX: Use compat set
            db.ref(`ems/${currentUser.uid}/attendance/${date}`).set(newAttendance);
            
            alert('Attendance saved successfully! Absent student alerts were sent via WhatsApp upon marking.');
            
            // Reload form to reflect the changes
            loadAttendanceForm(); 
        }

        function resendAbsentAlerts(attendanceDate) {
            if (!validateUserSession()) return;
            
            const record = attendance[attendanceDate];
            
            if (!record) {
                alert("Attendance record not found.");
                return;
            }
            
            record.absent.forEach(studentId => {
                const student = students[studentId];
                if (student) {
                    const branding = currentUser.schoolName ? `${currentUser.schoolName}\nContact: ${currentUser.schoolPhone || currentUser.phone}\n` : '';
                    const message = `Attendance Alert: ${student.name} was absent on ${attendanceDate}. Please contact the academy for more info. \n${branding}Created by ${currentUser.fullName} (${currentUser.phone})`;
                    openWhatsApp(student.phone, message);
                }
            });
            
            alert('WhatsApp alerts ready to send for absent students!');
        }

        function deleteAttendance(date) {
            if (!validateUserSession()) return;
            
            currentAction = 'deleteAttendance';
            currentItemId = date;
            openPinModal();
        }
        
        function loadAttendanceTable() {
            if (!validateUserSession()) return;
            
            const tbody = document.querySelector('#attendanceTable tbody');
            tbody.innerHTML = '';
            
            const attendanceArray = Object.entries(attendance).map(([date, record]) => ({date, ...record}));
            const sortedAttendance = attendanceArray.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedAttendance.forEach(record => {
                const totalStudentsOnDate = Object.keys(students).length > 0 ? Object.keys(students).length : (record.present.length + record.absent.length);
                const percentage = totalStudentsOnDate > 0 ? Math.round((record.present.length / totalStudentsOnDate) * 100) : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.date}</td>
                    <td><span class="status-badge status-present">${record.present.length}</span></td>
                    <td><span class="status-badge status-absent">${record.absent.length}</span></td>
                    <td style="font-weight: 700; color: var(--${percentage >= 80 ? 'success' : percentage >= 50 ? 'warning' : 'danger'});">${percentage}%</td>
                    <td class="action-buttons">
                        <button class="btn btn-whatsapp btn-sm" onclick="resendAbsentAlerts('${record.date}')"><i class="fab fa-whatsapp"></i> Resend Alerts</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteAttendance('${record.date}')"><i class="fas fa-trash"></i> Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Update recent attendance table on dashboard
            const recentAttendanceTbody = document.querySelector('#recentAttendanceTable tbody');
            recentAttendanceTbody.innerHTML = '';
            
            const recentAttendance = sortedAttendance.slice(0, 5);
            recentAttendance.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.date}</td>
                    <td>${record.present.length}</td>
                    <td>${record.absent.length}</td>
                `;
                recentAttendanceTbody.appendChild(row);
            });
        }

        // Update dashboard stats
        function updateDashboard() {
            if (!validateUserSession()) return;
            
            // Total Students
            document.getElementById('totalStudents').textContent = Object.keys(students).length;
            
            // Fees Collected This Month
            const currentMonth = new Date().toISOString().slice(0, 7);
            const monthlyFees = Object.values(fees).filter(fee => fee.month === currentMonth);
            const totalCollected = monthlyFees.reduce((sum, fee) => sum + fee.amount, 0);
            document.getElementById('feesCollected').textContent = totalCollected;
            
            // Pending Fees
            const pending = Object.values(students).reduce((sum, student) => {
                const studentFees = Object.values(fees).filter(f => f.studentId === student.id && f.month === currentMonth);
                const paid = studentFees.reduce((s, f) => s + f.amount, 0);
                // Only consider it pending if it's not fully paid (i.e., remaining > 0)
                const remaining = student.fee - paid;
                return sum + (remaining > 0 ? remaining : 0);
            }, 0);
            document.getElementById('pendingFees').textContent = pending;
            
            // Today's Attendance
            const today = new Date().toISOString().split('T')[0];
            const todayRecord = attendance[today];
            if (todayRecord && Object.keys(students).length > 0) {
                const percentage = Math.round((todayRecord.present.length / Object.keys(students).length) * 100);
                document.getElementById('todayAttendance').textContent = percentage + '%';
            } else {
                document.getElementById('todayAttendance').textContent = '0%';
            }
        }

        // WhatsApp Integration
        function openWhatsApp(phone, message) {
            let cleanPhone = phone.replace(/\D/g, '');
            if (cleanPhone.startsWith('03')) {
                cleanPhone = '92' + cleanPhone.substring(1);
            }
            
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/${cleanPhone}?text=${encodedMessage}`;
            
            window.open(whatsappUrl, '_blank');
        }

        // PIN Protected Actions
        function openPinModal() {
            if (!validateUserSession()) return;
            
            document.getElementById('pinModal').style.display = 'flex';
            setTimeout(() => document.querySelector('#pinModal .modal-content').classList.add('show'), 10);
            document.getElementById('pinInput').value = '';
            document.getElementById('pinInput').focus();
        }

        function closePinModal() {
            document.querySelector('#pinModal .modal-content').classList.remove('show');
            setTimeout(() => {
                document.getElementById('pinModal').style.display = 'none';
                currentAction = null;
                currentItemId = null;
            }, 400);
        }

        function verifyPin() {
            if (!validateUserSession()) return;
            
            const pin = document.getElementById('pinInput').value;
            
            if (!currentUser || !currentUser.pin) {
                alert('No admin PIN found. Login again.');
                closePinModal();
                return;
            }

            if (pin === currentUser.pin) {
                executeProtectedAction();
                closePinModal();
            } else {
                alert('Incorrect PIN. Please try again.');
                document.getElementById('pinInput').value = '';
                document.getElementById('pinInput').focus();
            }
        }

        function executeProtectedAction() {
            if (!currentItemId || !validateUserSession()) return;

            switch(currentAction) {
                case 'deleteStudent':
                    if (confirm('Are you sure you want to PERMANENTLY delete this student? Fee and attendance history will remain but be marked as archived.')) {
                        // FIX: Use compat remove
                        db.ref(`ems/${currentUser.uid}/students/${currentItemId}`).remove();
                        alert('Student deleted successfully');
                    }
                    break;
                case 'deleteFee':
                    if (confirm('Are you sure you want to PERMANENTLY delete this fee receipt?')) {
                        // FIX: Use compat remove
                        db.ref(`ems/${currentUser.uid}/fees/${currentItemId}`).remove();
                        alert('Fee record deleted successfully');
                    }
                    break;
                case 'deleteAttendance':
                    if (confirm('Are you sure you want to PERMANENTLY delete this attendance record?')) {
                        // FIX: Use compat remove
                        db.ref(`ems/${currentUser.uid}/attendance/${currentItemId}`).remove();
                        alert('Attendance record deleted successfully');
                    }
                    break;
                default:
                    alert('Action not defined for PIN protection.');
            }
        }

        // Utility functions
        function generateId() {
            return Math.random().toString(36).substr(2, 9).toUpperCase();
        }
    </script>
</body>
</html>